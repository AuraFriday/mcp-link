/*! Copyright © 2025 Christopher Nathan Drake. All rights reserved. This source is provided for viewing purposes only. See the LICENSE file for details. "signature":"еɡɊօnМꜱбƤanÞЈⅠƳ𝟤ᛕᑕEƍÐÐᴍꙄ𝟩ǝıցН𝟤NaD00ÞɪрnϹꓚƦΚVᏮɋ𝟛WⴹսWgрꓝϜ2РĐozWΒOꓑᴛᗷ𝟩ЈƤꙄDꓰ𝘈ΤЈᏮԁҳꓪƽqᴅСꓖꙄ𝟛𝟣ᗞꓠоvƖⅮ5Nꓜ6ƏНᗪOµF𝟥KÞМҳᴅ" "signdate":"2025-07-29T06:56:05.162Z" */
!function(){function getUUID(){return crypto.randomUUID?crypto.randomUUID():([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}let e,t,o={pendingRequests:new Map,window:Object.create(null)},n=getUUID(),s=window.console;s.nolog=(...e)=>{},self.RUNNING_IN_SCOPE=window?.chrome?.webview?"(webview2)":["file:","http:","https:"].includes(new URL(document?.currentScript?.src).protocol)?"(web)":"undefined"!=typeof chrome&&chrome.runtime?.id?"undefined"==typeof document?"(background)":"chrome-extension:"===location.protocol?location.pathname.includes("popup")||location.search.includes("popup")||window.outerWidth<500?"(toolbar)":"(tab)":document?"(content)":"(unknown)":"(page)";const i=(new Error).stack.match(/(?:at |[/(])(chrome-extension:\/\/[^/]+\/[^:)]+)/)?.[1]||"";function getUUID(){return crypto.randomUUID?crypto.randomUUID():([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}let r=!0,a=[];const l=i.split("/").slice(0,3).join("/"),c=i.split("/").slice(3).join("/"),d={};let p={},m=null;function createBasicContainer(o="mcp-popover",n="div",i=!1){const r=document.getElementById(o);if(r){if(!i)return s[e("log")](...t("log","✅ Popover already exists - returning existing container")),r;r.remove(),s[e("log")](...t("log","♻️ Removed existing popover to create new one"))}const a=document.createElement(n);return a.id=o,a.style.all="initial",a.style.position="fixed",a.style.top="calc(50vh - 150px)",a.style.left="calc(50vw - 200px)",a.style.visibility="hidden",a.style.zIndex="2147483647",a.style.pointerEvents="none",s[e("log")](...t("log",`📦 Created basic container: ${o}`)),a}function setupScriptsAndHandlers(o,n="script[data-mcp]"){const i=o.querySelectorAll(n);s[e("log")](...t("log",`🔧 Found ${i.length} scripts to execute`)),i.forEach(o=>{try{new Function(o.textContent)()}catch(o){s[e("error")](...t("error","❌ Failed to execute script due to CSP or other error:",o))}o.remove()});const r=[...o.querySelectorAll("*")];let a=0;r.forEach(o=>{[...o.attributes].forEach(n=>{if(n.name.startsWith("on"))try{o.addEventListener(n.name.slice(2),new Function("event",n.value)),a++}catch(o){s[e("warn")](...t("warn",`⚠️ Failed to setup event handler ${n.name}:`,o))}})}),s[e("log")](...t("log",`🎯 Setup ${a} event handlers from attributes`))}function finalizeContainerSetup(o,n,i,r=""){const a=o===document?document.body:o;if(a!==document&&a!==document.body&&(a.style.visibility="visible",a.style.pointerEvents="auto"),r.includes("webview2")||r.includes("browser")){const e=undefined;applyFullWindowContainerStyles(a===document.body?document.body:a)}else applyFloatingContainerStyles(a);gotime(a,n,i),s[e("log")](...t("log","✅ Container setup completed"+(r?" for "+r:"")))}function createShadowDOMRoot(o,n="closed"){try{const i=o.attachShadow({mode:n});return s[e("log")](...t("log",`🌓 Shadow DOM created with mode: ${n}`)),i}catch(o){throw s[e("error")](...t("error","❌ Failed to create shadow DOM:",o)),o}}d.popover=n=>{s[e("log")](...t("log","popover:",n));const i=n.popname||"mcp-popover",r=n.eltype||"div",a=n.okjs||"script[data-mcp]";let l=createBasicContainer(i,r,!0);const c=document.createElement("template");c.id="mcp-style";const p=document.createElement("div");p.className="foo",p.textContent="Hello",c.content.appendChild(p),l.appendChild(c),document.body.appendChild(l),o.content.innerHTML={selector:`#${i}`,html:n.innerHTML?n.innerHTML:"innerHTML key missing"},o.content.innerHTML.then(()=>{const n=l.querySelector("template#mcp-style"),i=l.attachShadow({mode:"closed"});i.appendChild(n.content),n.remove(),l.style.visibility="visible",l.style.pointerEvents="auto",applyFloatingContainerStyles(l),s[e("log")](...t("log","✅ Shadow DOM created")),setupScriptsAndHandlers(l,a),i.querySelectorAll("template").forEach(e=>{const t=e.content?.querySelector("style");t&&d.applyCssString(t.textContent,i)}),finalizeContainerSetup(l,i,o.page?.popoverMsg,"injected page popover")}).catch(o=>{s[e("error")](...t("error","error:",o))}),s[e("log")](...t("log","innerHTML loaded11-end"))},d.applyCssString=(o,n=document)=>{s[e("log")](...t("log","applyCssString:",o));const i=new CSSStyleSheet;i.replaceSync(o);const r=new Map;for(const o of i.cssRules)if(o.type===CSSRule.STYLE_RULE&&(":root"===o.selectorText||"*"===o.selectorText||o.selectorText.includes("*")))for(const n of o.style)n.startsWith("--")&&(s[e("log")](...t("log","cssVars found:",o.selectorText,n,o.style.getPropertyValue(n).trim())),r.set(n,o.style.getPropertyValue(n).trim()));const resolveVars=e=>e.replace(/var\((--[^\s,)]*)(?:,\s*([^)]+))?\)/g,(e,t,o)=>r.get(t)??o??"");for(const o of i.cssRules)if(o.type===CSSRule.STYLE_RULE){s[e("log")](...t("log","processing rule:",o.selectorText));try{let i=o.selectorText,r=[];if(/\b(?:html|body)\b/.test(i)){const e=n.querySelector(".mcp-popover")||n.querySelector("*");e&&r.push(e)}else if(":host"===i&&n.host)r=[n.host];else try{r=Array.from(n.querySelectorAll(i))}catch(o){s[e("warn")](...t("warn","Invalid selector:",i)),r=[]}s[e("log")](...t("log",`selector "${i}" matched ${r.length} elements`));for(const n of r)for(const i of o.style){const r=resolveVars(o.style.getPropertyValue(i));s[e("log")](...t("log","applying:",n.className||n.tagName,i,r,o.style.getPropertyPriority(i))),n.style.setProperty(i,r,o.style.getPropertyPriority(i))}}catch(n){s[e("warn")](...t("warn","CSS selector error:",o.selectorText,n))}}},d.resetAllStyles=(e,t="important")=>{const o=undefined;e.querySelectorAll("*").forEach(e=>{e.style.setProperty("font-family",'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',t),e.style.setProperty("color","initial",t),e.style.setProperty("background","transparent",t),e.style.setProperty("margin","0",t),e.style.setProperty("padding","0",t),e.style.setProperty("border","0",t),e.style.setProperty("font-size","initial",t),e.style.setProperty("line-height","initial",t)})};class MCPPopover{constructor(e,t,o={}){this.root=e,this.shadowRoot=t,this.currentTab="default",this.currentAI="chatgpt",this.isDropdownOpen=!1,this.isPermissionDropdownOpen=!1,this.isMaximized=!1,this.originalBounds=null,this.messageData=o,this.init()}init(){this.detectEnvironment(),this.detectPlatform(),this.setupEventListeners(),this.setupPermissionEventListeners(),this.setupKeyboardNavigation(),this.setupDragging(),this.initializeUI()}detectEnvironment(){const e=this.isRunningInWebView2(),t=this.root.querySelector(".mcp-popover")||this.root;e?t.setAttribute("data-show-titlebar","false"):t.setAttribute("data-show-titlebar","true")}isRunningInWebView2(){if("undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.id)return!1;if(window.chrome&&window.chrome.webview)return!0;const e=navigator.userAgent;return!(!e.includes("WebView2")&&!e.includes("Edge/"))}detectPlatform(){const e=navigator.userAgent,t=navigator.platform;let o="windows";t.includes("Mac")||e.includes("Macintosh")?o="macos":(t.includes("Linux")||e.includes("Linux"))&&(o="linux");const n=this.root.querySelector(".mcp-popover");n&&n.setAttribute("data-platform",o)}setupEventListeners(){const o=this.shadowRoot.querySelectorAll(".mcp-tab");s[e("log")](...t("log","🔍 Found tabs:",o.length,o)),o.forEach(e=>{e.addEventListener("click",t=>{this.switchTab(e.getAttribute("data-tab"))}),this.setupButtonHoverHandling(e)});const n=this.shadowRoot.querySelector(".mcp-maximize-btn"),i=this.shadowRoot.querySelector(".mcp-close-btn"),r=this.shadowRoot.querySelector(".mcp-titlebar");n?(n.addEventListener("click",()=>{this.handleMaximize()}),this.setupButtonHoverHandling(n)):s[e("log")](...t("log","❌ maximizeBtn not found")),i?(i.addEventListener("click",()=>{this.handleClose({event:"closeButton"})}),this.setupButtonHoverHandling(i)):s[e("log")](...t("log","❌ closeBtn not found")),r?r.addEventListener("dblclick",e=>{e.target.closest(".mcp-titlebar-btn")||this.handleMaximize()}):s[e("log")](...t("log","❌ titlebar not found"));const a=this.shadowRoot.querySelector(".mcp-ai-selector"),l=this.shadowRoot.querySelector(".mcp-ai-dropdown");a&&(a.addEventListener("click",e=>{e.stopPropagation(),this.toggleAIDropdown()}),this.setupButtonHoverHandling(a));const c=undefined;this.shadowRoot.querySelectorAll(".mcp-ai-option").forEach(e=>{e.addEventListener("click",()=>{this.selectAI(e.getAttribute("data-ai"))}),this.setupButtonHoverHandling(e)});const d=this.shadowRoot.querySelector(".mcp-submit-btn"),p=this.shadowRoot.querySelector(".mcp-input-field");d&&(d.addEventListener("click",()=>{this.handleSubmit()}),this.setupButtonHoverHandling(d)),p&&(p.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.handleSubmit())}),p.addEventListener("input",()=>{this.autoResizeInput(p)})),document.addEventListener("click",e=>{!this.isDropdownOpen||e.target.closest(".mcp-ai-selector")||e.target.closest(".mcp-ai-dropdown")||this.closeAIDropdown()}),document.addEventListener("keydown",e=>{if("Escape"===e.key&&(this.isDropdownOpen&&this.closeAIDropdown(),this.isPermissionDropdownOpen&&this.closePermissionDropdown()),e.altKey)switch(e.key.toLowerCase()){case"t":e.preventDefault(),this.selectPermissionOption("thistime");break;case"w":e.preventDefault(),this.selectPermissionOption("always");break;case"d":e.preventDefault(),this.handlePermissionDeny();break;case"a":e.preventDefault(),this.handlePermissionAllow()}})}setupKeyboardNavigation(){const e=this.shadowRoot.querySelectorAll(".mcp-tab");e.forEach((t,o)=>{t.addEventListener("keydown",t=>{let n=o;switch(t.key){case"ArrowLeft":t.preventDefault(),n=o>0?o-1:e.length-1;break;case"ArrowRight":t.preventDefault(),n=o<e.length-1?o+1:0;break;case"Home":t.preventDefault(),n=0;break;case"End":t.preventDefault(),n=e.length-1;break;default:return}e[n].focus(),this.switchTab(e[n].getAttribute("data-tab"))})})}initializeUI(){this.selectAI(this.currentAI),this.messageData&&this.messageData?.data?.popTab?(this.switchTab(this.messageData.data.popTab),s[e("log")](...t("log","🔍 i-switchTab:",this.messageData.data.popTab))):(s[e("log")](...t("log","🔍 no default tab data",this)),this.updateInputSectionForTab(this.currentTab)),this.updatePermissionRequestUI();const o=this.shadowRoot.querySelector(".mcp-input-field");o&&!o.disabled&&setTimeout(()=>{o.focus()},100)}switchTab(o){if(s[e("log")](...t("log","🔍 switchTab:",o)),this.currentTab===o)return;const n=undefined;this.shadowRoot.querySelectorAll(".mcp-tab").forEach(e=>{const t=e.getAttribute("data-tab")===o;e.classList.toggle("mcp-tab-active",t),e.setAttribute("aria-selected",t.toString())});const i=undefined;this.shadowRoot.querySelectorAll(".mcp-panel").forEach(e=>{const t=e.id===`mcp-${o}-panel`;e.classList.toggle("mcp-panel-active",t)}),this.currentTab=o,this.updateInputSectionForTab(o),"settings"===o&&this.loadAndRenderSettings(),this.emitEvent("tabChanged",{tab:o})}updateInputSectionForTab(e){const t=this.shadowRoot.querySelector(".mcp-input-section"),o=this.shadowRoot.querySelector(".mcp-input-field");if(t&&o)switch(t.classList.remove("mcp-input-disabled","mcp-input-hidden"),o.disabled=!1,o.style.setProperty("pointer-events","auto","important"),e){case"chat":t.classList.add("mcp-input-disabled"),o.placeholder="Install an AI MCP to use this option",o.disabled=!0;break;case"ok":case"settings":case"default":t.classList.add("mcp-input-hidden");break;case"store":t.classList.add("mcp-input-disabled"),o.placeholder="Install AI_Store MCP to use this",o.disabled=!0;break;default:o.placeholder="Ask anything..."}}updatePermissionRequestUI(){const o=this.messageData?.data||this.messageData||{},n=this.shadowRoot.querySelector(".mcp-permission-ai-name");if(n){const i=o.caller_name||"AI";n.textContent=i,s[e("log")](...t("log","🔧 Updated AI name to:",i))}const i=this.shadowRoot.querySelector(".mcp-permission-server-name");if(i){const n=o.server_name||"unknown";i.textContent=n,s[e("log")](...t("log","🔧 Updated server name to:",n))}const r=this.shadowRoot.querySelector(".mcp-permission-tool-name");if(r){const n=o.tool_name||"tool";r.textContent=n,s[e("log")](...t("log","🔧 Updated tool name to:",n))}const a=o.comment;a&&this.addPermissionComment("Reason: "+a)}addPermissionComment(o){const n=this.shadowRoot.querySelector(".mcp-permission-request");if(!n)return;const i=n.querySelector(".mcp-permission-comment");i&&i.remove();const r=this.createElement("div",{className:"mcp-permission-comment",text:o}),a=n.querySelector(".mcp-permission-buttons");a&&(a.insertAdjacentElement("afterend",r),s[e("log")](...t("log","🔧 Added permission comment:",o)))}toggleAIDropdown(){this.isDropdownOpen?this.closeAIDropdown():this.openAIDropdown()}openAIDropdown(){const e=this.shadowRoot.querySelector(".mcp-ai-dropdown");if(e){e.classList.add("mcp-dropdown-open"),this.isDropdownOpen=!0;const t=e.querySelector(".mcp-ai-option");t&&t.focus()}}closeAIDropdown(){const e=this.shadowRoot.querySelector(".mcp-ai-dropdown");e&&(e.classList.remove("mcp-dropdown-open"),this.isDropdownOpen=!1)}selectAI(n){s[e("log")](...t("log",`🧠 selectAI: from ${this.currentAI} to ${n}`)),this.currentAI!==n&&(o.pop.settings={id:"currentAI",value:{ai:n,set:"manual popover",prev:this.currentAI}}),this.currentAI=n;const i=this.shadowRoot.querySelector(".mcp-ai-selector .mcp-ai-icon"),r=this.shadowRoot.querySelector(`[data-ai="${n}"]`);if(i&&r){const e=r.querySelector(".mcp-ai-icon"),t=r.querySelector(".mcp-ai-name");e&&(i.className=e.className);const o=this.shadowRoot.querySelector(".mcp-ai-selector");o&&t&&(o.setAttribute("aria-label",`Current AI: ${t.textContent}`),o.setAttribute("title",t.textContent))}this.closeAIDropdown(),this.emitEvent("aiChanged",{ai:n})}handleSubmit(){const e=this.shadowRoot.querySelector(".mcp-input-field");if(!e)return;const t=e.value.trim();t&&(e.value="",this.autoResizeInput(e),this.emitEvent("messageSubmitted",{message:t,ai:this.currentAI,tab:this.currentTab}),e.focus())}handleMaximize(){const o=this.shadowRoot.host||document.querySelector(".mcp-floating-container");o?(this.isMaximized?this.restoreWindow(o):this.maximizeWindow(o),this.emitEvent(this.isMaximized?"windowRestored":"windowMaximized")):s[e("log")](...t("log","Maximize only available for floating popover"))}maximizeWindow(o){s[e("log")](...t("log","🔍 maximizeWindow() called"));const n=o.getBoundingClientRect();this.originalBounds={left:n.left,top:n.top,width:n.width,height:n.height},s[e("log")](...t("log","📏 Original bounds: left="+this.originalBounds.left+", top="+this.originalBounds.top+", width="+this.originalBounds.width+", height="+this.originalBounds.height));const i=window.innerWidth,r=window.innerHeight;s[e("log")](...t("log","📐 Viewport dimensions: width="+i+", height="+r));const a=getComputedStyle(document.body),l=getComputedStyle(document.documentElement);s[e("log")](...t("log","📄 Body margins: "+a.margin+", padding: "+a.padding)),s[e("log")](...t("log","📄 HTML margins: "+l.margin+", padding: "+l.padding)),o.style.transition="all 0.2s ease",o.style.setProperty("display","block","important"),o.style.setProperty("position","fixed","important"),o.style.setProperty("left","0px","important"),o.style.setProperty("top","0px","important"),o.style.setProperty("right","0px","important"),o.style.setProperty("bottom","0px","important"),o.style.setProperty("width","auto","important"),o.style.setProperty("height","auto","important"),o.style.setProperty("min-width","unset","important"),o.style.setProperty("min-height","unset","important"),o.style.setProperty("max-width","unset","important"),o.style.setProperty("max-height","unset","important"),o.style.setProperty("border-radius","0","important"),o.style.setProperty("resize","none","important"),o.style.setProperty("margin","0","important"),o.style.setProperty("padding","0","important"),o.style.setProperty("z-index","2147483647","important"),s[e("log")](...t("log","🎨 Applied maximized styles with !important")),setTimeout(()=>{const n=o.getBoundingClientRect(),a=getComputedStyle(o);s[e("log")](...t("log","📏 Final container rect: x="+n.x+", y="+n.y+", width="+n.width+", height="+n.height)),s[e("log")](...t("log","🎨 Final computed styles:")),s[e("log")](...t("log","  position: "+a.position)),s[e("log")](...t("log","  left: "+a.left)),s[e("log")](...t("log","  top: "+a.top)),s[e("log")](...t("log","  right: "+a.right)),s[e("log")](...t("log","  bottom: "+a.bottom)),s[e("log")](...t("log","  width: "+a.width)),s[e("log")](...t("log","  height: "+a.height)),s[e("log")](...t("log","  min-width: "+a.minWidth)),s[e("log")](...t("log","  min-height: "+a.minHeight)),s[e("log")](...t("log","  max-width: "+a.maxWidth)),s[e("log")](...t("log","  max-height: "+a.maxHeight)),s[e("log")](...t("log","  margin: "+a.margin)),s[e("log")](...t("log","  padding: "+a.padding)),s[e("log")](...t("log","  box-sizing: "+a.boxSizing));const l=(n.width/i*100).toFixed(1),c=(n.height/r*100).toFixed(1),d=n.left,p=n.top,m=i-n.right,h=r-n.bottom;s[e("log")](...t("log","📊 Viewport coverage:")),s[e("log")](...t("log","  Width coverage: "+l+"%")),s[e("log")](...t("log","  Height coverage: "+c+"%")),s[e("log")](...t("log","  Left gap: "+d+"px")),s[e("log")](...t("log","  Top gap: "+p+"px")),s[e("log")](...t("log","  Right gap: "+m+"px")),s[e("log")](...t("log","  Bottom gap: "+h+"px")),m>0||h>0?(s[e("log")](...t("log","⚠️ Still have gaps! Checking for CSS conflicts...")),s[e("log")](...t("log","🔍 Container classes: "+o.className)),s[e("log")](...t("log","🔍 Container inline styles: "+o.style.cssText))):s[e("log")](...t("log","✅ Perfect viewport coverage achieved!"))},250),this.isMaximized=!0;const c=this.shadowRoot.querySelector(".mcp-maximize-btn");c&&(c.setAttribute("title","Restore"),c.setAttribute("aria-label","Restore"))}restoreWindow(e){if(!this.originalBounds)return;e.style.transition="all 0.2s ease",e.style.display="contents",e.style.position="fixed",e.style.left=`${this.originalBounds.left}px`,e.style.top=`${this.originalBounds.top}px`,e.style.width=`${this.originalBounds.width}px`,e.style.height=`${this.originalBounds.height}px`,e.style.right="",e.style.bottom="",e.style.margin="",e.style.padding="",e.style.borderRadius="8px",this.isMaximized=!1,this.originalBounds=null;const t=this.shadowRoot.querySelector(".mcp-maximize-btn");t&&(t.setAttribute("title","Maximize"),t.setAttribute("aria-label","Maximize"))}handleClose(n){s[e("log")](...t("log","handleClose:",{msg:n,this:this})),this.emitEvent("closeRequested"),this.root?.remove(),p={},d.access_token&&(o.page.popoverMsg=""),s[e("log")](...t("log","✅ done handleClose")),o.pop.ui_close={uiId:this.messageData.uiId,result:n.event}}autoResizeInput(e){e.style.height="auto";const t=2.5,o=8,n=parseFloat(getComputedStyle(e).fontSize),s=e.scrollHeight,i=Math.max(t*n,Math.min(8*n,s));e.style.height=`${i}px`}setupPermissionEventListeners(){const o=this.shadowRoot.querySelector(".mcp-scope-dropdown-btn"),n=this.shadowRoot.querySelector(".mcp-permission-dropdown-menu");o?(o.addEventListener("click",o=>{o.stopPropagation(),s[e("log")](...t("log","🔧 Permission dropdown button clicked")),this.togglePermissionDropdown()}),this.setupButtonHoverHandling(o)):s[e("log")](...t("log","🔧 ❌ Permission dropdown button not found"));const i=undefined;this.shadowRoot.querySelectorAll(".mcp-permission-dropdown-option").forEach(o=>{o.addEventListener("click",n=>{n.stopPropagation();const i=o.getAttribute("data-option");s[e("log")](...t("log","Permission option clicked:",i)),this.selectPermissionOption(i)}),this.setupButtonHoverHandling(o)});const r=this.shadowRoot.querySelector(".mcp-deny-btn"),a=this.shadowRoot.querySelector(".mcp-ok-btn");r&&(r.addEventListener("click",()=>{this.handlePermissionDeny()}),this.setupButtonHoverHandling(r)),a&&(a.addEventListener("click",()=>{this.handlePermissionAllow()}),this.setupButtonHoverHandling(a)),this.shadowRoot&&this.shadowRoot.host?(this.shadowRoot.addEventListener("click",e=>{this.isPermissionDropdownOpen&&!e.target.closest(".mcp-permission-scope-dropdown")&&this.closePermissionDropdown()}),document.addEventListener("click",e=>{if(this.isPermissionDropdownOpen){const t=this.shadowRoot.host;t.contains(e.target)||e.target===t||this.closePermissionDropdown()}})):document.addEventListener("click",e=>{this.isPermissionDropdownOpen&&!e.target.closest(".mcp-permission-scope-dropdown")&&this.closePermissionDropdown()})}setupButtonHoverHandling(e){e&&(e.addEventListener("mouseenter",()=>{e.classList.add("mcp-hover")}),e.addEventListener("mouseleave",()=>{e.classList.remove("mcp-hover")}),e.addEventListener("mousedown",()=>{e.classList.add("mcp-active")}),e.addEventListener("mouseup",()=>{e.classList.remove("mcp-active")}),e.addEventListener("mouseleave",()=>{e.classList.remove("mcp-active")}))}togglePermissionDropdown(){s[e("log")](...t("log","🔧 togglePermissionDropdown called, current state:",this.isPermissionDropdownOpen)),this.isPermissionDropdownOpen?this.closePermissionDropdown():this.openPermissionDropdown()}openPermissionDropdown(){const e=this.shadowRoot.querySelector(".mcp-permission-dropdown-menu");if(e){e.classList.add("mcp-dropdown-open"),this.isPermissionDropdownOpen=!0;const t=e.querySelector(".mcp-permission-dropdown-option");t&&t.focus()}}closePermissionDropdown(){const e=this.shadowRoot.querySelector(".mcp-permission-dropdown-menu");e&&(e.classList.remove("mcp-dropdown-open"),this.isPermissionDropdownOpen=!1)}selectPermissionOption(o){s[e("log")](...t("log","🔧 selectPermissionOption called with:",o));const n=this.shadowRoot.querySelector(".mcp-scope-dropdown-btn .mcp-btn-text"),i=this.shadowRoot.querySelectorAll(".mcp-permission-dropdown-option");if(s[e("log")](...t("log","🔧 Found btnText:",n)),s[e("log")](...t("log","🔧 Found options:",i.length,i)),n&&i.length>0){if(i.forEach(o=>{o.classList.remove("mcp-selected"),s[e("log")](...t("log","🔧 Removed mcp-selected from:",o.getAttribute("data-option")))}),"always"===o){n.textContent="",n.appendChild(document.createTextNode("Al"));const o=document.createElement("u");o.textContent="w",n.appendChild(o),n.appendChild(document.createTextNode("ays"));const i=this.shadowRoot.querySelector('.mcp-permission-dropdown-option[data-option="always"]');i&&(i.classList.add("mcp-selected"),s[e("log")](...t("log","🔧 Added mcp-selected to always option")))}else if("thistime"===o){n.textContent="";const o=document.createElement("u");o.textContent="T",n.appendChild(o),n.appendChild(document.createTextNode("his time"));const i=this.shadowRoot.querySelector('.mcp-permission-dropdown-option[data-option="thistime"]');i&&(i.classList.add("mcp-selected"),s[e("log")](...t("log","🔧 Added mcp-selected to thistime option")))}}else s[e("log")](...t("log","🔧 ❌ btnText or options not found"));this.closePermissionDropdown(),this.emitEvent("permissionOptionSelected",{option:o})}handlePermissionDeny(){s[e("log")](...t("log","Permission denied")),this.emitEvent("permissionDenied",{tool:"browser"}),this.handleClose({event:"deny"})}handlePermissionAllow(){s[e("log")](...t("log","Permission allowed",o)),o.pop.allow={permission:!0},this.emitEvent("permissionAllowed",{tool:"browser"}),this.handleClose({event:"ok"})}emitEvent(e,t={}){const o=new CustomEvent(`mcp:${e}`,{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(o)}setTab(e){this.switchTab(e)}setAI(e){this.selectAI(e)}showTitleBar(e=!0){const t=this.root.querySelector(".mcp-popover");t&&t.setAttribute("data-show-titlebar",e.toString())}setMessage(e){const t=this.root.querySelector(".mcp-input-field");t&&(t.value=e,this.autoResizeInput(t),t.focus())}setContextMessage(e,t="🖼️"){const o=this.root.querySelector(".mcp-context-message");if(o){const n=o.querySelector(".mcp-context-icon"),s=o.querySelector(".mcp-context-text");n&&(n.textContent=t),s&&(s.textContent=e)}}EVENTS_TO_BLOCK=["keydown","keypress","keyup","input","change","paste","cut","copy","mousedown","mouseup","click","dblclick","contextmenu","mousemove","mouseenter","mouseleave","mouseover","mouseout","touchstart","touchmove","touchend","touchcancel","pointerdown","pointermove","pointerup","wheel","scroll","focus","blur","beforeunload"];blockAllEvents(e){}activateEventShield(o=document){for(const e of this.EVENTS_TO_BLOCK)o.addEventListener(e,this.blockAllEvents,!0);s[e("log")](...t("log","✅ Event shield activated"))}deactivateEventShield(o=document){for(const e of this.EVENTS_TO_BLOCK)o.removeEventListener(e,this.blockAllEvents,!0);s[e("log")](...t("log","✅ Event shield deactivated"))}createElement(e,t={}){const o=document.createElement(e);return t.text&&(o.textContent=t.text),t.className&&(o.className=t.className),t.attrs&&Object.entries(t.attrs).forEach(([e,t])=>{o.setAttribute(e,t)}),t.children&&Array.isArray(t.children)&&t.children.forEach(e=>{e&&o.appendChild(e)}),o}async loadAndRenderSettings(){s[e("log")](...t("log","🔧 Loading settings..."));try{const n=await o.perm.configs,i=n?.settings?.value;if(!i||!Array.isArray(i))return s[e("error")](...t("error","Invalid settings data structure:",i)),o.pop.reset_settings=!0,setTimeout(()=>{this.loadAndRenderSettings()},1e3),void this.showSettingsError("Failed to load settings data. Settings reset. Please try again.");s[e("log")](...t("log","🔧 Settings data loaded:",i));const r=i[0]||{},a=i.slice(1)||[];this.renderSettingsUI(r,a)}catch(n){s[e("error")](...t("error","Failed to load settings:",n)),o.pop.reset_settings=!0,setTimeout(()=>{this.loadAndRenderSettings()},1e3),this.showSettingsError(`Failed to load settings: ${n.message}. Settings reset. Please try again.`)}}renderSettingsUI(o,n){const i=this.shadowRoot.querySelector(".mcp-settings-content");if(!i)return void s[e("error")](...t("error","Settings content area not found"));for(;i.firstChild;)i.removeChild(i.firstChild);const r=this.createElement("div",{className:"mcp-settings-header",children:[this.createElement("h3",{text:"Extension Settings"}),this.createElement("p",{text:"Configure your MCP-Link extension preferences."})]});i.appendChild(r),n.forEach((e,t)=>{const n=this.createSettingElement(e,o);n&&i.appendChild(n)}),s[e("log")](...t("log","🔧 Settings UI rendered with",n.length,"controls"))}createSettingElement(o,n){const{type:i,id:r,label:a,description:l,help_text:c}=o;return"button"===i?this.createButtonSetting(o):"link"===i?this.createLinkSetting(o):"checkbox"===i?this.createCheckboxSetting(o,n):"server_management"===i?this.createServerManagementSetting(o,n):(s[e("warn")](...t("warn","Unsupported setting type:",i)),null)}createButtonSetting(e){const{id:t,label:o,description:n,help_text:s,button_style:i,icon:r,width:a,confirmation:l,action:c,visibility:d,position:p}=e,m="mcp-setting-container"+("bottom"===p?" mcp-position-bottom":""),h=this.createElement("div",{className:m}),u=this.createElement("div",{className:"mcp-setting-header",children:[...r?[this.createElement("span",{text:r,className:"mcp-setting-icon"})]:[],this.createElement("h4",{text:o,className:"mcp-setting-title"})]}),g=this.createElement("p",{text:n,className:"mcp-setting-description"}),y=s?this.createElement("p",{text:s,className:"mcp-setting-help"}):null,v=this.createElement("div",{className:"mcp-setting-content",children:[u,g,...y?[y]:[]]}),w=["mcp-settings-button",`mcp-style-${i||"default"}`];"full"===a&&w.push("mcp-width-full");const f=this.createElement("button",{text:o,className:w.join(" ")});this.setupButtonHoverHandling(f),f.addEventListener("click",()=>{this.handleButtonSettingClick(e)});const b=this.createElement("div",{children:[v,f]});return h.appendChild(b),h}createLinkSetting(e){const{id:t,label:o,action:n,position:s}=e,i="mcp-setting-container mcp-link-container"+("bottom"===s?" mcp-position-bottom":""),r=this.createElement("div",{className:i}),a=this.createElement("a",{className:"mcp-link-setting",attrs:{href:"#"},text:o});return a.addEventListener("click",t=>{t.preventDefault(),n&&this.executeSettingAction(n,e)}),r.appendChild(a),r}createCheckboxSetting(o,n){const{id:i,label:r,description:a,tooltip:l,icon:c,position:d,confirmation_on_enable:p,visibility:m}=o,h="mcp-setting-container"+("bottom"===d?" mcp-position-bottom":""),u=this.createElement("div",{className:h}),g=this.createElement("div",{className:"mcp-checkbox-title-row"}),y=this.createElement("div",{className:"mcp-checkbox-left-side",children:[...c?[this.createElement("span",{text:c,className:"mcp-setting-icon"})]:[],this.createElement("h4",{text:r,className:"mcp-setting-title"})]}),v=n[i]??!1,w=this.createElement("input",{attrs:{type:"checkbox",id:`setting-${i}`,...v?{checked:"checked"}:{},...l?{title:l}:{}},className:"mcp-checkbox-input"}),f=this.createElement("label",{text:""+(v?"Enabled":"Disabled"),attrs:{for:`setting-${i}`},className:"mcp-checkbox-label"}),b=this.createElement("div",{className:"mcp-checkbox-right-side",children:[w,f]});g.appendChild(y),g.appendChild(b);const E=this.createElement("p",{text:a,className:"mcp-checkbox-description"});w.addEventListener("change",async o=>{const n=o.target.checked;if(n&&p?.required){const e=undefined;if(!await this.showConfirmationDialog(p))return void(w.checked=!n)}await this.updateSettingValue(i,n),f.textContent=n?"Enabled":"Disabled",s[e("log")](...t("log",`🔧 Setting ${i} changed to:`,n))});const S=this.createElement("div",{children:[g,E]});return u.appendChild(S),u}createServerManagementSetting(e,t){const{id:o,label:n,description:s,help_text:i,position:r}=e,a="mcp-setting-container"+("bottom"===r?" mcp-position-bottom":""),l=this.createElement("div",{className:a}),c=this.createElement("div",{className:"mcp-setting-header",children:[this.createElement("h4",{text:n,className:"mcp-setting-title"})]}),d=this.createElement("p",{text:s,className:"mcp-setting-description"}),p=t[o]||{},m=Object.keys(p).length,h=this.createElement("span",{text:`${m} configured`,className:"mcp-server-count"}),u=this.createElement("button",{text:"+ Add New Server",className:"mcp-settings-button mcp-style-primary mcp-add-server-btn"});u.addEventListener("click",()=>{this.showServerEditModal(null,p,e=>{this.updateSettingValue(o,e),this.refreshServerList(l,e)})});const g=this.createElement("div",{className:"mcp-server-header-row",children:[c,h]}),y=this.createElement("div",{className:"mcp-server-list"});this.renderServerList(y,p,e=>{this.updateSettingValue(o,e),this.refreshServerList(l,e)});const v=this.createElement("div",{children:[g,d,u,y]});return l.appendChild(v),l}getButtonStyles(e){switch(e){case"danger":return"\n            background: #dc3545 !important;\n            color: white !important;\n          ";case"primary":return"\n            background: #007bff !important;\n            color: white !important;\n          ";case"secondary":return"\n            background: #6c757d !important;\n            color: white !important;\n          ";case"warning":return"\n            background: #ffc107 !important;\n            color: #212529 !important;\n          ";default:return"\n            background: #f8f9fa !important;\n            color: #495057 !important;\n            border: 1px solid #dee2e6 !important;\n          "}}getButtonStylesObject(e){switch(e){case"danger":return{background:"#dc3545",color:"white"};case"primary":return{background:"#007bff",color:"white"};case"secondary":return{background:"#6c757d",color:"white"};case"warning":return{background:"#ffc107",color:"#212529"};default:return{background:"#f8f9fa",color:"#495057",border:"1px solid #dee2e6"}}}async handleButtonSettingClick(o){const{confirmation:n,action:i,id:r}=o;if(s[e("log")](...t("log","🔧 Button setting clicked:",r)),n?.required){const o=undefined;if(!await this.showConfirmationDialog(n))return void s[e("log")](...t("log","🔧 Action cancelled by user"))}await this.executeSettingAction(i,o)}showConfirmationDialog(e){return new Promise(t=>{const{title:o,message:n,confirm_button_text:s,cancel_button_text:i,confirm_button_style:r,require_double_confirmation:a,double_confirmation_text:l,double_confirmation_prompt:c}=e,d=this.createElement("div",{className:"mcp-modal-overlay"}),p=this.createElement("h3",{text:o,className:"mcp-modal-title"}),m=this.createElement("div",{text:n,className:"mcp-modal-message"});let h=null,u=null;if(a){const e=this.createElement("label",{text:c,className:"mcp-modal-input-label-inline"});u=this.createElement("input",{attrs:{type:"text",id:"confirmation-input",placeholder:`Type '${l}' here`},className:"mcp-modal-input-inline"}),h=this.createElement("div",{className:"mcp-modal-input-group-inline",children:[e,u]})}const g=this.createElement("button",{text:i,attrs:{id:"cancel-btn"},className:"mcp-settings-button mcp-style-default"}),y=["mcp-settings-button",`mcp-style-${r||"primary"}`],v=this.createElement("button",{text:s,attrs:{id:"confirm-btn",...a?{disabled:"true"}:{}},className:y.join(" ")});a&&(v.style.setProperty("opacity","0.5","important"),v.style.setProperty("cursor","not-allowed","important"));const w=undefined,f=[p,m,...h?[h]:[],this.createElement("div",{className:"mcp-modal-buttons",children:[g,v]})],b=this.createElement("div",{className:"mcp-modal-dialog",children:f});d.appendChild(b);const E=undefined;(this.shadowRoot||document.body).appendChild(d),a&&u&&(u.addEventListener("input",()=>{const e=u.value.trim()===l;v.disabled=!e,v.style.setProperty("opacity",e?"1":"0.5","important"),v.style.setProperty("cursor",e?"pointer":"not-allowed","important")}),u.addEventListener("keydown",e=>{"Enter"===e.key&&u.value.trim()===l&&(t(!0),d.remove())})),g.addEventListener("click",()=>{t(!1),d.remove()}),v.addEventListener("click",()=>{t(!0),d.remove()});const escHandler=e=>{"Escape"===e.key&&(t(!1),d.remove(),document.removeEventListener("keydown",escHandler))};document.addEventListener("keydown",escHandler),a&&u&&setTimeout(()=>{u.focus()},100)})}async executeSettingAction(n,i){const{type:r,function_name:a,parameters:l,post_action:c}=n;s[e("log")](...t("log","🔧 Executing setting action:",n));try{"function_call"===r&&"reset_settings"===a?(o.pop.reset_settings=!0,c?.show_notification&&this.showNotification(c.show_notification),"reload_settings"===c?.type&&setTimeout(()=>{this.loadAndRenderSettings()},1e3)):"function_call"===r&&"view_legal_docs"===a&&(o.pop.ui_close={uiId:"settings",result:"legal_docs_requested"},c?.show_notification&&this.showNotification(c.show_notification),o.pop.view_legal_docs=!0)}catch(o){s[e("error")](...t("error","Failed to execute setting action:",o)),this.showNotification({type:"error",message:`Failed to execute action: ${o.message}`,duration_ms:5e3})}}async updateSettingValue(n,i){try{s[e("log")](...t("log",`🔧 Updating setting ${n} to:`,i)),o.pop.settings={id:n,value:i},s[e("log")](...t("log",`🔧 Setting ${n} update sent to background`))}catch(o){throw s[e("error")](...t("error",`Failed to update setting ${n}:`,o)),this.showNotification({type:"error",message:`Failed to update setting: ${o.message}`,duration_ms:5e3}),o}}renderServerList(e,t,o){for(;e.firstChild;)e.removeChild(e.firstChild);const n=Object.keys(t);if(0===n.length){const t=this.createElement("div",{className:"mcp-server-empty",children:[this.createElement("p",{text:"No MCP servers configured yet.",className:"mcp-server-empty-text"}),this.createElement("p",{text:'Click "Add New Server" to get started.',className:"mcp-server-empty-hint"})]});return void e.appendChild(t)}n.forEach(n=>{const s=t[n];e.appendChild(this.createServerListItem(n,s,t,o))})}createServerListItem(e,t,o,n){const{url:s,headers:i={}}=t,r=Object.keys(i).length,a=this.createElement("div",{className:"mcp-server-item"}),l=this.createElement("div",{className:"mcp-server-item-header"}),c=this.createElement("button",{text:"▼",className:"mcp-server-expand-btn"}),d=this.createElement("div",{className:"mcp-server-info",children:[this.createElement("div",{text:e,className:"mcp-server-name"}),this.createElement("div",{text:this.truncateUrl(s),className:"mcp-server-url"}),this.createElement("div",{text:r>0?`Headers: ${Object.keys(i).join(", ")}`:"No headers",className:"mcp-server-headers"})]});l.appendChild(c),l.appendChild(d);const p=this.createElement("div",{className:"mcp-server-details mcp-server-details-hidden"}),m=this.createElement("div",{className:"mcp-server-actions",children:[this.createElement("button",{text:"Edit",className:"mcp-settings-button mcp-style-primary mcp-server-edit-btn"}),this.createElement("button",{text:"Delete",className:"mcp-settings-button mcp-style-danger mcp-server-delete-btn"})]});let h=!1;c.addEventListener("click",()=>{h=!h,c.textContent=h?"▲":"▼",h?(p.classList.remove("mcp-server-details-hidden"),this.renderServerDetails(p,t)):p.classList.add("mcp-server-details-hidden")});const u=undefined;m.children[0].addEventListener("click",()=>{this.showServerEditModal(e,o,n)});const g=undefined;return m.children[1].addEventListener("click",()=>{this.showServerDeleteConfirmation(e,o,n)}),a.appendChild(l),a.appendChild(p),a.appendChild(m),a}truncateUrl(e){return e.length<=50?e:e.substring(0,47)+"..."}renderServerDetails(e,t){for(;e.firstChild;)e.removeChild(e.firstChild);const{url:o,headers:n={}}=t,s=this.createElement("div",{className:"mcp-server-detail-section",children:[this.createElement("strong",{text:"URL:"}),this.createElement("div",{text:o,className:"mcp-server-detail-value"})]});e.appendChild(s);const i=Object.keys(n);if(i.length>0){const t=this.createElement("div",{className:"mcp-server-detail-section",children:[this.createElement("strong",{text:"Headers:"})]});i.forEach(e=>{const o=n[e],s=this.createElement("div",{className:"mcp-server-header-row",children:[this.createElement("span",{text:`${e}:`,className:"mcp-server-header-name"}),this.createElement("span",{text:this.truncateHeaderValue(o),className:"mcp-server-header-value"})]});t.appendChild(s)}),e.appendChild(t)}}truncateHeaderValue(e){return e.length<=40?e:e.substring(0,37)+"..."}refreshServerList(e,t){const o=e.querySelector(".mcp-server-list"),n=e.querySelector(".mcp-server-count");if(o&&this.renderServerList(o,t,t=>{this.updateSettingValue("mcpServers",t),this.refreshServerList(e,t)}),n){const e=Object.keys(t).length;n.textContent=`${e} configured`}}showServerEditModal(o,n,i){const r=null!==o,a=r?n[o]:{url:"",headers:{}};s[e("log")](...t("log",`🔧 ${r?"Editing":"Adding"} server:`,o,a));const l=this.createElement("div",{className:"mcp-modal-overlay"}),c=this.createElement("div",{className:"mcp-modal-dialog"}),d=this.createElement("h3",{text:r?"Edit MCP Server":"Add New MCP Server",className:"mcp-modal-title"}),p=this.createElement("div",{className:"mcp-server-form"}),m=this.createElement("label",{text:"Server Name:",className:"mcp-modal-input-label"}),h=this.createElement("input",{attrs:{type:"text",placeholder:"e.g., ragtag_aura",value:r?o:""},className:"mcp-modal-input"}),u=this.createElement("div",{className:"mcp-modal-input-group",children:[m,h]}),g=this.createElement("label",{text:"Server URL:",className:"mcp-modal-input-label"}),y=this.createElement("input",{attrs:{type:"url",placeholder:"https://example.com:31173/sse",value:a.url||""},className:"mcp-modal-input"}),v=this.createElement("div",{className:"mcp-modal-input-group",children:[g,y]}),w=this.createElement("label",{text:"Headers (optional):",className:"mcp-modal-input-label"}),f=this.createElement("div",{className:"mcp-headers-container"}),b=this.createElement("button",{text:"+ Add Header",className:"mcp-settings-button mcp-style-secondary mcp-add-header-btn"}),E=this.createElement("div",{className:"mcp-modal-input-group",children:[w,f,b]});p.appendChild(u),p.appendChild(v),p.appendChild(E);const S=this.createElement("div",{className:"mcp-modal-buttons",children:[this.createElement("button",{text:"Cancel",className:"mcp-settings-button mcp-style-default mcp-cancel-btn"}),this.createElement("button",{text:r?"Update Server":"Add Server",className:"mcp-settings-button mcp-style-primary mcp-save-btn"})]});c.appendChild(d),c.appendChild(p),c.appendChild(S),l.appendChild(c);const x=undefined;(this.shadowRoot||document.body).appendChild(l),this.initializeHeadersUI(f,a.headers||{}),this.setupServerModalEventHandlers(l,h,y,f,b,r,o,n,i),setTimeout(()=>{h.focus(),r&&h.select()},100)}initializeHeadersUI(e,t){for(;e.firstChild;)e.removeChild(e.firstChild);Object.entries(t).forEach(([t,o])=>{this.addHeaderRow(e,t,o)}),0===Object.keys(t).length&&this.showHeadersEmptyState(e)}addHeaderRow(e,t="",o=""){const n=e.querySelector(".mcp-headers-empty");n&&n.remove();const s=this.createElement("div",{className:"mcp-header-row"}),i=this.createElement("input",{attrs:{type:"text",placeholder:"Header name (e.g., Authorization)",value:t},className:"mcp-header-key-input"}),r=this.createElement("input",{attrs:{type:"text",placeholder:"Header value (e.g., Bearer token123)",value:o},className:"mcp-header-value-input"}),a=this.createElement("button",{text:"×",className:"mcp-header-remove-btn"});a.addEventListener("click",()=>{s.remove(),0===e.children.length&&this.showHeadersEmptyState(e)}),s.appendChild(i),s.appendChild(r),s.appendChild(a),e.appendChild(s),t||setTimeout(()=>i.focus(),50)}showHeadersEmptyState(e){const t=this.createElement("div",{className:"mcp-headers-empty",children:[this.createElement("p",{text:"No headers configured.",className:"mcp-headers-empty-text"}),this.createElement("p",{text:"Most servers work without headers, but some require authentication.",className:"mcp-headers-empty-hint"})]});e.appendChild(t)}setupServerModalEventHandlers(e,t,o,n,s,i,r,a,l){const c=e.querySelector(".mcp-cancel-btn"),d=e.querySelector(".mcp-save-btn");c.addEventListener("click",()=>{e.remove()}),s.addEventListener("click",()=>{this.addHeaderRow(n)}),d.addEventListener("click",()=>{this.handleServerSave(e,t,o,n,i,r,a,l)});const escHandler=t=>{"Escape"===t.key&&(e.remove(),document.removeEventListener("keydown",escHandler))};document.addEventListener("keydown",escHandler);const enterHandler=s=>{"Enter"===s.key&&"TEXTAREA"!==s.target.tagName&&(s.preventDefault(),this.handleServerSave(e,t,o,n,i,r,a,l))};e.addEventListener("keydown",enterHandler)}handleServerSave(o,n,i,r,a,l,c,d){const p=n.value.trim(),m=i.value.trim(),h=this.validateServerInput(p,m,a,l,c);if(!h.valid)return void this.showNotification({type:"error",message:h.error,duration_ms:4e3});const u=this.collectHeaders(r),g={url:m,...Object.keys(u).length>0?{headers:u}:{}},y={...c};a&&l!==p&&delete y[l],y[p]=g,s[e("log")](...t("log",`🔧 ${a?"Updated":"Added"} server:`,p,g)),d(y),o.remove(),this.showNotification({type:"success",message:`Server "${p}" has been ${a?"updated":"added"}.`,duration_ms:3e3})}validateServerInput(e,t,o,n,s){if(!e)return{valid:!1,error:"Server name is required."};if(!/^[a-zA-Z0-9_-]+$/.test(e))return{valid:!1,error:"Server name can only contain letters, numbers, underscores, and hyphens."};if((!o||n!==e)&&s[e])return{valid:!1,error:`A server named "${e}" already exists. Please choose a different name.`};if(!t)return{valid:!1,error:"Server URL is required."};try{const e=new URL(t);if(!["http:","https:"].includes(e.protocol))return{valid:!1,error:"URL must use http:// or https:// protocol."}}catch(e){return{valid:!1,error:"Please enter a valid URL (e.g., https://example.com:9443/sse)."}}return{valid:!0}}collectHeaders(e){const t={},o=undefined;return e.querySelectorAll(".mcp-header-row").forEach(e=>{const o=e.querySelector(".mcp-header-key-input"),n=e.querySelector(".mcp-header-value-input"),s=o.value.trim(),i=n.value.trim();s&&i&&(t[s]=i)}),t}showServerDeleteConfirmation(o,n,i){const r={title:"Delete MCP Server?",message:`Are you sure you want to delete the server "${o}"?\n\nThis will permanently remove the server configuration and cannot be undone.`,confirm_button_text:"Yes, Delete Server",confirm_button_style:"danger",cancel_button_text:"Cancel"};this.showConfirmationDialog(r).then(r=>{if(r){const r={...n};delete r[o],s[e("log")](...t("log",`🔧 Deleted server: ${o}`)),i(r),this.showNotification({type:"success",message:`Server "${o}" has been deleted.`,duration_ms:3e3})}})}showNotification(e){const{type:t,message:o,duration_ms:n=3e3}=e,s=this.createElement("div",{text:o,className:`mcp-notification mcp-notification-${t||"success"}`});document.body.appendChild(s),setTimeout(()=>{s.className+=" mcp-slide-out",setTimeout(()=>{s.remove()},300)},n)}showSettingsError(e){const t=this.shadowRoot.querySelector(".mcp-settings-content");if(!t)return;for(;t.firstChild;)t.removeChild(t.firstChild);const o=this.createElement("div",{className:"mcp-settings-error",children:[this.createElement("h3",{text:"Settings Error"}),this.createElement("p",{text:e})]});t.appendChild(o)}setupDragging(){const o=this.shadowRoot.querySelector(".mcp-titlebar"),n=this.root||document.querySelector(".mcp-popover");if(!o||!n)return s[e("error")](...t("error","❌ setupDragging early return - missing elements")),s[e("error")](...t("error","   titlebar:",o)),void s[e("error")](...t("error","   container:",n));let i=!1,r=0,a=0,l=0,c=0,d="";const getCurrentPosition=()=>{const e=n.getBoundingClientRect();return{left:e.left,top:e.top}},setPosition=(e,t)=>{n.style.left=`${e}px`,n.style.top=`${t}px`},handleMouseDown=e=>{if(e.target.closest(".mcp-titlebar-btn"))return;i=!0,r=e.clientX,a=e.clientY;const t=getCurrentPosition();l=t.left,c=t.top,o.style.setProperty("cursor","grabbing","important"),d=document.body.style.userSelect,document.body.style.userSelect="none",e.preventDefault()},handleMouseMove=e=>{if(!i)return;const t=e.clientX-r,o=e.clientY-a;setPosition(l+t,c+o),e.preventDefault()},handleMouseUp=e=>{i&&(i=!1,o.style.setProperty("cursor","grab","important"),document.body.style.userSelect=d)},handleTouchStart=e=>{if(e.target.closest(".mcp-titlebar-btn"))return;i=!0;const t=e.touches[0];r=t.clientX,a=t.clientY;const n=getCurrentPosition();l=n.left,c=n.top,o.style.setProperty("cursor","grabbing","important"),e.preventDefault()},handleTouchMove=e=>{if(!i)return;const t=e.touches[0],o=t.clientX-r,n=t.clientY-a;setPosition(l+o,c+n),e.preventDefault()},handleTouchEnd=e=>{i&&(i=!1,o.style.setProperty("cursor","grab","important"))};o.addEventListener("mousedown",handleMouseDown),document.addEventListener("mousemove",handleMouseMove),document.addEventListener("mouseup",handleMouseUp),o.addEventListener("touchstart",handleTouchStart,{passive:!1}),document.addEventListener("touchmove",handleTouchMove,{passive:!1}),document.addEventListener("touchend",handleTouchEnd),o.addEventListener("selectstart",e=>e.preventDefault()),o.style.setProperty("cursor","grab","important"),s[e("log")](...t("log","✅ setupDragging completed successfully")),s[e("log")](...t("log","🔍 Final titlebar cursor style:",o.style.cursor)),s[e("log")](...t("log","🔍 Final titlebar element:",o))}}function initializeMCPPopover(n=document,i,r){let a=null;if(void 0===p.mcpPopover){s[e("log")](...t("log","🔄 Initializing MCPPopover with container:",{container:n,shadowRootOrDocument:i,messageData:r}));try{p.mcpPopover=new MCPPopover(n,i,r),s[e("log")](...t("log","✅ MCPPopover initialized successfully")),a=p.mcpPopover}catch(o){s[e("error")](...t("error","❌ Error initializing MCPPopover:",o)),a=null}}else s[e("log")](...t("log","ℹ️ MCPPopover already initialized")),a=p.mcpPopover;Object.entries(r.data?.vars||{}).forEach(([o,n])=>{const r=i.querySelector(".mcp-popover")||i.firstElementChild;r?(r.style.setProperty(`--${o}`,n),s[e("log")](...t("log",`✅ Set CSS variable --${o}: ${n} on`,r.className||r.tagName))):s[e("warn")](...t("warn",`❌ No root element found in ${i===document?"main DOM":"shadow DOM"} to apply --${o}: ${n}`))});try{s[e("log")](...t("log","🧠 pop",{mcp_link:o,pop:o.pop})),useAiPromise=o.pop["settings.currentAI"],useAiPromise instanceof Promise&&useAiPromise.then(o=>{s[e("log")](...t("log","🧠 got default ai of:",o)),a.selectAI(o?.ai)})}catch(o){s[e("error")](...t("error","🧠 i-constructor:",o))}return a}function gotime(o,n,i){const r=undefined;(n===document?document:o).addEventListener("DOMContentLoaded",()=>{initializeMCPPopover(o,n,i)});const a=undefined;"loading"===(n===document?document.readyState:o.readyState)?s[e("log")](...t("log","📄 DOM still loading, waiting for DOMContentLoaded...")):(s[e("log")](...t("log","📄 DOM already loaded, initializing immediately...")),setTimeout(()=>initializeMCPPopover(o,n,i),10)),"undefined"!=typeof module&&module.exports&&(module.exports=MCPPopover)}function applyFullWindowContainerStyles(o){try{o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100vw",o.style.height="100vh",o.style.border="none",o.style.borderRadius="0",o.style.boxShadow="none",o.style.resize="none",o.style.overflow="hidden",o.style.margin="0",o.style.padding="0",o.style.zIndex="2147483647",s[e("log")](...t("log","✅ Applied full-window container styles for webview2/browser context"))}catch(o){s[e("error")](...t("error","❌ Failed to apply full-window container styles:",o))}}function applyFloatingContainerStyles(o){try{o.style.position="fixed",o.style.top="calc(50vh - 150px)",o.style.left="calc(50vw - 200px)",o.style.width="400px",o.style.height="300px",o.style.zIndex="2147483647",o.style.border="1px solid rgba(0, 0, 0, 0.2)",o.style.borderRadius="8px",o.style.boxShadow="0 10px 30px rgba(0, 0, 0, 0.2)",o.style.resize="both",o.style.overflow="hidden",o.style.minWidth="320px",o.style.minHeight="240px",window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(o.style.border="1px solid rgba(255, 255, 255, 0.2)",o.style.boxShadow="0 10px 30px rgba(0, 0, 0, 0.4)"),o.addEventListener("mouseenter",()=>{window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?o.style.boxShadow="0 15px 40px rgba(0, 0, 0, 0.5)":o.style.boxShadow="0 15px 40px rgba(0, 0, 0, 0.25)"}),o.addEventListener("mouseleave",()=>{window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?o.style.boxShadow="0 10px 30px rgba(0, 0, 0, 0.4)":o.style.boxShadow="0 10px 30px rgba(0, 0, 0, 0.2)"}),s[e("log")](...t("log","✅ Applied floating container styles via JS"))}catch(o){s[e("error")](...t("error","❌ Failed to apply floating container styles:",o))}}function createJsSvg1(o=shadowRoot){const n=o.querySelector("#js-svg1");if(!n)return void s[e("warn")](...t("warn","js-svg1 container not found"));const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("width","24"),i.setAttribute("height","24"),i.setAttribute("viewBox","0 0 24 24"),i.setAttribute("class","mcp-svg-dice"),i.style.setProperty("display","block","important"),i.style.setProperty("overflow","visible","important"),i.style.setProperty("width","24px","important"),i.style.setProperty("height","24px","important");const r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d","M4 2 L20 2 L22 4 L22 20 L20 22 L4 22 L2 20 L2 4 Z"),r.setAttribute("class","mcp-svg-dice-path"),r.style.setProperty("display","block","important"),r.style.setProperty("fill","white","important"),r.style.setProperty("stroke","black","important"),r.style.setProperty("stroke-width","1px","important"),r.style.setProperty("vector-effect","none","important"),r.style.setProperty("shape-rendering","auto","important"),r.style.setProperty("opacity","1","important");const a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx","12"),a.setAttribute("cy","12"),a.setAttribute("r","2"),a.setAttribute("class","mcp-svg-dice-circle"),a.style.setProperty("display","block","important"),a.style.setProperty("fill","black","important"),a.style.setProperty("stroke","none","important"),a.style.setProperty("stroke-width","0","important"),a.style.setProperty("vector-effect","none","important"),a.style.setProperty("shape-rendering","auto","important"),a.style.setProperty("opacity","1","important"),i.appendChild(r),i.appendChild(a),n.appendChild(i),s[e("log")](...t("log","✅ JS svg1 created successfully"))}function injectSubmitButtonSVG(o){try{const n=o.querySelector(".mcp-submit-icon");if(!n)return void s[e("warn")](...t("warn","Submit icon span not found"));const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("width","18"),i.setAttribute("height","18"),i.setAttribute("viewBox","0 0 18 18"),i.setAttribute("fill","none");const r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d","M7.99992 14.9993V5.41334L4.70696 8.70631C4.31643 9.09683 3.68342 9.09683 3.29289 8.70631C2.90237 8.31578 2.90237 7.68277 3.29289 7.29225L8.29289 2.29225L8.36906 2.22389C8.76184 1.90354 9.34084 1.92613 9.70696 2.29225L14.707 7.29225L14.7753 7.36842C15.0957 7.76119 15.0731 8.34019 14.707 8.70631C14.3408 9.07242 13.7618 9.09502 13.3691 8.77467L13.2929 8.70631L9.99992 5.41334V14.9993C9.99992 15.5516 9.55221 15.9993 8.99992 15.9993C8.44764 15.9993 7.99993 15.5516 7.99992 14.9993Z"),r.setAttribute("fill","currentColor"),i.appendChild(r),n.textContent=" go",n.appendChild(i),s[e("log")](...t("log","✅ SVG injected successfully into submit button"));const a=o.querySelector(".mcp-test-svg");if(a){const o=i.cloneNode(!0);a.appendChild(o),s[e("log")](...t("log","✅ Test SVG injected successfully",r))}else s[e("warn")](...t("warn","❌ Test SVG span not found"))}catch(o){s[e("error")](...t("error","❌ Failed to inject SVG:",o))}}function fixCSSPathForNonExtensionContext(){if("(web)"===self.RUNNING_IN_SCOPE||"(webview2)"===self.RUNNING_IN_SCOPE||"(page)"===self.RUNNING_IN_SCOPE){const o=document.getElementById("mcp-main-css");if(o){const n=o.href;return o.href="popover.css",s[e("log")](...t("log",` Switched CSS from "${n}" to "popover.css" for ${self.RUNNING_IN_SCOPE} context`)),!0}return s[e("warn")](...t("warn",` CSS link element #mcp-main-css not found for ${self.RUNNING_IN_SCOPE} context`)),!1}return!0}d.response=n=>{s[e("log")](...t("log","response:",n));const i=o.pendingRequests.get(n.requestId);o.pendingRequests.delete(n.requestId),i(n.result)};const createAsyncBgProxy=n=>new Proxy(n,{get:(e,t)=>new Promise(n=>{const s=getUUID();o.pendingRequests.set(s,n),chrome.runtime.sendMessage({type:e.get,ret:e.get_ret,requestId:s,key:e.key,prop:t,broadcast:e.broadcast})}),set:(o,n,i)=>(s[e("log")](...t("log","in set:",{target:o,prop:n,value:i})),i instanceof MessagePort?(s[e("warn")](...t("warn","⚠️ MessagePort values not supported in direct chrome.runtime.sendMessage")),!1):(chrome.runtime.sendMessage({type:o.set,ret:o.get_ret,key:o.key,prop:n,value:i,broadcast:o.broadcast}),!0)),deleteProperty:(e,t)=>(chrome.runtime.sendMessage({type:e.deleteProperty,key:e.key,prop:t,broadcast:e.broadcast}),!0),ownKeys:e=>new Promise(t=>{const n=getUUID();o.pendingRequests.set(n,t),chrome.runtime.sendMessage({type:e.ownKeys,ret:e.get_ret,requestId:n,key:e.key,broadcast:e.broadcast})}),has:(e,t)=>new Promise(n=>{const s=getUUID();o.pendingRequests.set(s,n),chrome.runtime.sendMessage({type:e.has,ret:e.get_ret,requestId:s,key:e.key,prop:t,broadcast:e.broadcast})})});if("(webview2)"===self.RUNNING_IN_SCOPE||"(web)"===self.RUNNING_IN_SCOPE){let h=!0,u=[],g=window.console;g.nolog=(...e)=>{};let cname=()=>`${(new Date).toISOString()} ui.js ${self.RUNNING_IN_SCOPE}`;t=(e,...t)=>{const o=[cname(),...t],n=undefined;let s=2,i,r="unknown:0.0";const a=((new Error).stack.split("\n")[2]||"").match(/\s+at\s+(?:(.+)\s+\()?(?:(.+):(\d+):(\d+))\)?/);if(a){const[,e,t,o,n]=a,s=t.split(/[\/\\]/),i=undefined;r=`${s[s.length-1]}:${o}.${n}`}return Array.isArray(u)&&u.length<1e4&&u.push({severity:e,args:o,caller:`[${e} ${r}]`}),o},e=e=>h?e:"nolog",g[e("log")](...t("log","webview2/browser window - HTML already loaded, activating in main DOM")),function activateWebViewPopover(){try{const o=document.querySelector(".mcp-popover")||document.body;if(!o)return void g[e("error")](...t("error","❌ No .mcp-popover found in main DOM for webview2/browser context"));g[e("log")](...t("log","📄 Found existing content, activating functionality in main DOM"));const n=o===document.body?document:o,s=undefined;setupScriptsAndHandlers(document,"script[data-mcp]"),document.querySelectorAll("template").forEach(e=>{const t=e.content?.querySelector("style");t&&d.applyCssString(t.textContent,document)}),fixCSSPathForNonExtensionContext()||("loading"===document.readyState?document.addEventListener("DOMContentLoaded",fixCSSPathForNonExtensionContext):setTimeout(fixCSSPathForNonExtensionContext,10));const i={data:{caller:self.RUNNING_IN_SCOPE,popTab:"settings",vars:{"mcp-show-titlebar":"none"}}};finalizeContainerSetup(n,document,i,"webview2/browser activation"),g[e("log")](...t("log","✅ WebView2/browser popover activated in main DOM"))}catch(o){g[e("error")](...t("error","❌ Failed to activate webview2/browser popover:",o))}}()}else if("(toolbar)"===self.RUNNING_IN_SCOPE)prepEnv(),prepComms(),(async()=>{const n={},i=n.popname||"mcp-popover",r=undefined,a=n.okjs||"script[data-mcp]";let c=createBasicContainer(i,n.eltype||"div",!1);if(c&&document.getElementById(i))return void s[e("log")](...t("log","✅ Popover already exists - not creating a new one"));const d=createShadowDOMRoot(c),p=await o.pop.getPopoverHTML;s[e("log")](...t("log","✅ Popover HTML:",p)),d.innerHTML=p.replace(/chrome-extension:\/\/[a-z]+/g,l),document.body.appendChild(c),s[e("log")](...t("log","✅ Shadow DOM created for extension id="+l)),setupScriptsAndHandlers(c,a),finalizeContainerSetup(c,d,{data:{caller:self.RUNNING_IN_SCOPE,popTab:"settings",vars:{"mcp-show-titlebar":"none"}}},"toolbar extension"),s[e("log")](...t("log","innerHTML toolbar-end"))})();else if("(page)"===self.RUNNING_IN_SCOPE)setTimeout(()=>{d.access_token=__MCP__LINK__.mcp?.access_token,o=__MCP__LINK__[d.access_token].mcp_link;let i=o.window;e=i.vault.sev,t=i.vault.mcp_log,s=o.window.console,s.nolog=(...e)=>{},s[e("log")](...t("log",`👷‍♂️ ui.js started. with \n    access_token='${n}';  originalWindow=__MCP__LINK__[access_token].window;  originalWindow.ramlog.length=0;\n  `)),s[e("log")](...t("log","✅ with local.access_token=",d.access_token)),o.popover=d.popover,o.page??={}},100);else if("(tab)"===self.RUNNING_IN_SCOPE){prepEnv(),prepComms(),s[e("log")](...t("log",`terms scope ${self?.RUNNING_IN_SCOPE} (${c})`)),d.response=n=>{s[e("log")](...t("log","response:",n));const i=o.pendingRequests.get(n.requestId);if(o.pendingRequests.delete(n.requestId),!i)return n.result;i(n.result)};let y=!1,v=null,w=null;async function check_eula_acceptance_status(){try{const e=undefined;return await o.perm.EULA}catch(o){return s[e("log")](...t("log","EULA acceptance check failed:",o)),null}}function create_floating_banner(){return v||(v=document.createElement("div"),v.id="eula-floating-banner",v.innerHTML="⚠️ IMPORTANT: You must read this entire EULA to continue using mcp-link.<br>To decline the EULA, uninstall this mcp-link extension now.",document.body.appendChild(v),v)}function remove_floating_banner(){v&&(v.remove(),v=null)}function create_acceptance_ui(){if(w)return w;w=document.createElement("div"),w.id="eula-acceptance-ui";const e=document.createElement("div");e.className="eula-acceptance-container";const t=document.createElement("h3");t.className="eula-acceptance-title",t.textContent="⚠️ EULA Acceptance Required";const o=document.createElement("p");o.className="eula-acceptance-description",o.textContent="By checking this box, you confirm that you have read and understood this entire End-User License Agreement and agree to be bound by its terms.";const n=document.createElement("div");n.className="eula-checkbox-container";const s=document.createElement("input");s.type="checkbox",s.id="eula-acceptance-checkbox",s.className="eula-acceptance-checkbox";const i=document.createElement("label");i.htmlFor="eula-acceptance-checkbox",i.className="eula-checkbox-label",i.textContent="I have read, understood, and agree to this EULA",n.appendChild(s),n.appendChild(i);const r=document.createElement("div");r.className="eula-button-container";const a=document.createElement("button");a.id="eula-accept-button",a.className="eula-accept-button",a.disabled=!0,a.textContent="Accept and Continue",r.appendChild(a);const l=document.createElement("p");return l.className="eula-uninstall-note",l.textContent="If you do not agree, please uninstall the mcp-link extension from your browser.",e.appendChild(t),e.appendChild(o),e.appendChild(n),e.appendChild(r),e.appendChild(l),w.appendChild(e),w}function create_already_accepted_ui(e){const t=document.createElement("div");t.id="eula-already-accepted-ui";const o=document.createElement("div");o.className="eula-already-accepted-container";const n=document.createElement("h3");n.className="eula-already-accepted-title",n.textContent="✅ EULA Accepted";const s=document.createElement("p");return s.className="eula-already-accepted-date",s.textContent=`User accepted EULA on ${new Date(e).toLocaleString()}`,o.appendChild(n),o.appendChild(s),t.appendChild(o),t}function setup_acceptance_handlers(){const n=document.getElementById("eula-acceptance-checkbox"),i=document.getElementById("eula-accept-button");n&&i&&(n.addEventListener("change",()=>{i.disabled=!n.checked}),i.addEventListener("click",async()=>{if(n.checked)try{const n=(new Date).toISOString();o.perm.EULA=n,s[e("log")](...t("log",`✅ EULA accepted at ${n}`)),w.replaceWith(create_already_accepted_ui(n)),w=null,remove_floating_banner(),setTimeout(()=>{const e=undefined,t=window.location.href.split("#")[0];window.location.href=`${t}#WELCOME.md`},1500)}catch(o){s[e("log")](...t("log","Failed to record EULA acceptance:",o)),alert("Failed to record EULA acceptance. Please try again.")}}))}async function initialize_eula_acceptance_system(){if(y)return;const o=window.location.href;if(!o.includes("#EULA.md")&&!o.endsWith("/terms.html"))return;s[e("log")](...t("log","Initializing EULA acceptance system"));const n=await check_eula_acceptance_status();if(n){s[e("log")](...t("log",`EULA already accepted on ${n}`));const wait_for_document=()=>{const e=document.getElementById("md-root");e&&!e.classList.contains("loading")?e.appendChild(create_already_accepted_ui(n)):setTimeout(wait_for_document,100)};wait_for_document()}else{s[e("log")](...t("log","EULA not yet accepted, showing acceptance UI")),create_floating_banner();const wait_for_document=()=>{const e=document.getElementById("md-root");e&&!e.classList.contains("loading")?(e.appendChild(create_acceptance_ui()),setup_acceptance_handlers()):setTimeout(wait_for_document,100)};wait_for_document()}y=!0}setInterval(async()=>{const e=window.location.href;e.includes("chrome-extension://")&&(e.includes("/pages/terms.html#EULA.md")||e.endsWith("/pages/terms.html"))?await initialize_eula_acceptance_system():(y=!1,remove_floating_banner())},1e3)}else prepEnv(),s[e("log")](...t("log",`Unexpected scope ${self?.RUNNING_IN_SCOPE} (${c}) script:`,(new Error).stack.split("/",4).pop().split(":")[0]));function prepEnv(){r=!0,a=[],s=window.console,s.nolog=(...e)=>{},cname=()=>`${(new Date).toISOString()} ui.js ${self.RUNNING_IN_SCOPE}`,t=(e,...t)=>{const o=[cname(),...t],n=undefined;let s=2,i,r="unknown:0.0";const l=((new Error).stack.split("\n")[2]||"").match(/\s+at\s+(?:(.+)\s+\()?(?:(.+):(\d+):(\d+))\)?/);if(l){const[,e,t,o,n]=l,s=t.split(/[\/\\]/),i=undefined;r=`${s[s.length-1]}:${o}.${n}`}return Array.isArray(a)&&a.length<1e4&&a.push({severity:e,args:o,caller:`[${e} ${r}]`}),o},e=e=>r?e:"nolog"}function prepComms(){chrome.runtime.onMessage.addListener(o=>{if(s[e("log")](...t("log","onMessage from background:",o)),d[o.type])return d[o.type](o)}),o={},o.window=window,o.pendingRequests=new Map,o.tempCache=createAsyncBgProxy({set:"set_to_background",get:"get_from_background",key:"temp",cache:!0,get_ret:"response",broadcast:"response"}),o.perm=createAsyncBgProxy({set:"perm_set",get:"perm_get",deleteProperty:"perm_deleteProperty",ownkeys:"perm_ownKeys",has:"perm_has",key:"perm",get_ret:"response",broadcast:"response"}),o.tools=createAsyncBgProxy({set:"tool_run",get:"tool_get",key:"tools",get_ret:"response",broadcast:"response"}),o.pop=createAsyncBgProxy({set:"pop_set",get:"pop_get",deleteProperty:"pop_deleteProperty",ownkeys:"pop_ownKeys",has:"pop_has",key:"pop",get_ret:"response",broadcast:"response"})}}();