/*! Copyright Â© 2025 Christopher Nathan Drake. All rights reserved. This source is provided for viewing purposes only. See the LICENSE file for details. "signature":"ð“’Ô›gá´ 6ÃÎ¤Ð±á‘•ÔÆ¿Ï¹Îð“’1ÖyGðŸ«ÎŸêœ±Æ§QÎ’ÅªÐ’á´¡ÔÆŒÑ¡ðŸ¨Ñ…Æð“’Æ‹áŽ¬Æ›aÄ¸ÆŒPðŸ©ð“’1ðŸ«Æ§Æê“¦ÎšyÉ¡ðŸ™RÆ³ê™…MpvÕ½ê““Å§Ó Æ´áŽ GáŸ6Ï…É—Æ§Ã¾Æ±Ðá›•JÆ¤ê“§ð“’daÆ¦ðŸ¦Ô›7ð›¢ÐšÃ¾Æê™„SÈœNRÅ§ðŸ«ê“¦á´œâ…¼nâ²žáŽðŸ£Èœê“šê“œð“’ðŸ¨Ð…á‘•" "signdate":"2025-07-25T06:19:07.788Z" */
!function(){function getUUID(){return crypto.randomUUID?crypto.randomUUID():([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}let e,t,o={pendingRequests:new Map,window:Object.create(null)},s=getUUID(),n=window.console;n.nolog=(...e)=>{},self.RUNNING_IN_SCOPE=window?.chrome?.webview?"(webview2)":["file:","http:","https:"].includes(new URL(document?.currentScript?.src).protocol)?"(web)":"undefined"!=typeof chrome&&chrome.runtime?.id?"undefined"==typeof document?"(background)":"chrome-extension:"===location.protocol?location.pathname.includes("popup")||location.search.includes("popup")||window.outerWidth<500?"(toolbar)":"(tab)":document?"(content)":"(unknown)":"(page)";const i=(new Error).stack.match(/(?:at |[/(])(chrome-extension:\/\/[^/]+\/[^:)]+)/)?.[1]||"";function getUUID(){return crypto.randomUUID?crypto.randomUUID():([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}const r=i.split("/").slice(0,3).join("/"),a=i.split("/").slice(3).join("/"),l={};let c={};function createBasicContainer(o="mcp-popover",s="div",i=!1){const r=document.getElementById(o);if(r){if(!i)return n[e("log")](...t("log","âœ… Popover already exists - returning existing container")),r;r.remove(),n[e("log")](...t("log","â™»ï¸ Removed existing popover to create new one"))}const a=document.createElement(s);return a.id=o,a.style.all="initial",a.style.position="fixed",a.style.top="calc(50vh - 150px)",a.style.left="calc(50vw - 200px)",a.style.visibility="hidden",a.style.zIndex="2147483647",a.style.pointerEvents="none",n[e("log")](...t("log",`ðŸ“¦ Created basic container: ${o}`)),a}function setupScriptsAndHandlers(o,s="script[data-mcp]"){const i=o.querySelectorAll(s);n[e("log")](...t("log",`ðŸ”§ Found ${i.length} scripts to execute`)),i.forEach(o=>{try{new Function(o.textContent)()}catch(o){n[e("error")](...t("error","âŒ Failed to execute script due to CSP or other error:",o))}o.remove()});const r=[...o.querySelectorAll("*")];let a=0;r.forEach(o=>{[...o.attributes].forEach(s=>{if(s.name.startsWith("on"))try{o.addEventListener(s.name.slice(2),new Function("event",s.value)),a++}catch(o){n[e("warn")](...t("warn",`âš ï¸ Failed to setup event handler ${s.name}:`,o))}})}),n[e("log")](...t("log",`ðŸŽ¯ Setup ${a} event handlers from attributes`))}function finalizeContainerSetup(o,s,i,r=""){const a=o===document?document.body:o;if(a!==document&&a!==document.body&&(a.style.visibility="visible",a.style.pointerEvents="auto"),r.includes("webview2")||r.includes("browser")){!function applyFullWindowContainerStyles(o){try{o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100vw",o.style.height="100vh",o.style.border="none",o.style.borderRadius="0",o.style.boxShadow="none",o.style.resize="none",o.style.overflow="hidden",o.style.margin="0",o.style.padding="0",o.style.zIndex="2147483647",n[e("log")](...t("log","âœ… Applied full-window container styles for webview2/browser context"))}catch(o){n[e("error")](...t("error","âŒ Failed to apply full-window container styles:",o))}}(a===document.body?document.body:a)}else applyFloatingContainerStyles(a);!function gotime(o,s,i){const r=s===document?document:o;r.addEventListener("DOMContentLoaded",()=>{initializeMCPPopover(o,s,i)});const a=s===document?document.readyState:o.readyState;"loading"===a?n[e("log")](...t("log","ðŸ“„ DOM still loading, waiting for DOMContentLoaded...")):(n[e("log")](...t("log","ðŸ“„ DOM already loaded, initializing immediately...")),setTimeout(()=>initializeMCPPopover(o,s,i),10));"undefined"!=typeof module&&module.exports&&(module.exports=MCPPopover)}(a,s,i),n[e("log")](...t("log","âœ… Container setup completed"+(r?" for "+r:"")))}function createShadowDOMRoot(o,s="closed"){try{const i=o.attachShadow({mode:s});return n[e("log")](...t("log",`ðŸŒ“ Shadow DOM created with mode: ${s}`)),i}catch(o){throw n[e("error")](...t("error","âŒ Failed to create shadow DOM:",o)),o}}l.popover=s=>{n[e("log")](...t("log","popover:",s));const i=s.popname||"mcp-popover",r=s.eltype||"div",a=s.okjs||"script[data-mcp]";let c=createBasicContainer(i,r,!0);const d=document.createElement("template");d.id="mcp-style";const p=document.createElement("div");p.className="foo",p.textContent="Hello",d.content.appendChild(p),c.appendChild(d),document.body.appendChild(c),o.content.innerHTML={selector:`#${i}`,html:s.innerHTML?s.innerHTML:"innerHTML key missing"},o.content.innerHTML.then(()=>{const s=c.querySelector("template#mcp-style"),i=c.attachShadow({mode:"closed"});i.appendChild(s.content),s.remove(),c.style.visibility="visible",c.style.pointerEvents="auto",applyFloatingContainerStyles(c),n[e("log")](...t("log","âœ… Shadow DOM created")),setupScriptsAndHandlers(c,a),i.querySelectorAll("template").forEach(e=>{const t=e.content?.querySelector("style");t&&l.applyCssString(t.textContent,i)}),finalizeContainerSetup(c,i,o.page?.popoverMsg,"injected page popover")}).catch(o=>{n[e("error")](...t("error","error:",o))}),n[e("log")](...t("log","innerHTML loaded11-end"))},l.applyCssString=(o,s=document)=>{n[e("log")](...t("log","applyCssString:",o));const i=new CSSStyleSheet;i.replaceSync(o);const r=new Map;for(const o of i.cssRules)if(o.type===CSSRule.STYLE_RULE&&(":root"===o.selectorText||"*"===o.selectorText||o.selectorText.includes("*")))for(const s of o.style)s.startsWith("--")&&(n[e("log")](...t("log","cssVars found:",o.selectorText,s,o.style.getPropertyValue(s).trim())),r.set(s,o.style.getPropertyValue(s).trim()));const resolveVars=e=>e.replace(/var\((--[^\s,)]*)(?:,\s*([^)]+))?\)/g,(e,t,o)=>r.get(t)??o??"");for(const o of i.cssRules)if(o.type===CSSRule.STYLE_RULE){n[e("log")](...t("log","processing rule:",o.selectorText));try{let i=o.selectorText,r=[];if(/\b(?:html|body)\b/.test(i)){const e=s.querySelector(".mcp-popover")||s.querySelector("*");e&&r.push(e)}else if(":host"===i&&s.host)r=[s.host];else try{r=Array.from(s.querySelectorAll(i))}catch(o){n[e("warn")](...t("warn","Invalid selector:",i)),r=[]}n[e("log")](...t("log",`selector "${i}" matched ${r.length} elements`));for(const s of r)for(const i of o.style){const r=resolveVars(o.style.getPropertyValue(i));n[e("log")](...t("log","applying:",s.className||s.tagName,i,r,o.style.getPropertyPriority(i))),s.style.setProperty(i,r,o.style.getPropertyPriority(i))}}catch(s){n[e("warn")](...t("warn","CSS selector error:",o.selectorText,s))}}},l.resetAllStyles=(e,t="important")=>{e.querySelectorAll("*").forEach(e=>{e.style.setProperty("font-family",'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',t),e.style.setProperty("color","initial",t),e.style.setProperty("background","transparent",t),e.style.setProperty("margin","0",t),e.style.setProperty("padding","0",t),e.style.setProperty("border","0",t),e.style.setProperty("font-size","initial",t),e.style.setProperty("line-height","initial",t)})};class MCPPopover{constructor(e,t,o={}){this.root=e,this.shadowRoot=t,this.currentTab="default",this.currentAI="chatgpt",this.isDropdownOpen=!1,this.isPermissionDropdownOpen=!1,this.isMaximized=!1,this.originalBounds=null,this.messageData=o,this.init()}init(){this.detectEnvironment(),this.detectPlatform(),this.setupEventListeners(),this.setupPermissionEventListeners(),this.setupKeyboardNavigation(),this.setupDragging(),this.initializeUI()}detectEnvironment(){const e=this.isRunningInWebView2(),t=this.root.querySelector(".mcp-popover")||this.root;e?t.setAttribute("data-show-titlebar","false"):t.setAttribute("data-show-titlebar","true")}isRunningInWebView2(){if("undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.id)return!1;if(window.chrome&&window.chrome.webview)return!0;const e=navigator.userAgent;return!(!e.includes("WebView2")&&!e.includes("Edge/"))}detectPlatform(){const e=navigator.userAgent,t=navigator.platform;let o="windows";t.includes("Mac")||e.includes("Macintosh")?o="macos":(t.includes("Linux")||e.includes("Linux"))&&(o="linux");const s=this.root.querySelector(".mcp-popover");s&&s.setAttribute("data-platform",o)}setupEventListeners(){const o=this.shadowRoot.querySelectorAll(".mcp-tab");n[e("log")](...t("log","ðŸ” Found tabs:",o.length,o)),o.forEach(e=>{e.addEventListener("click",t=>{this.switchTab(e.getAttribute("data-tab"))}),this.setupButtonHoverHandling(e)});const s=this.shadowRoot.querySelector(".mcp-maximize-btn"),i=this.shadowRoot.querySelector(".mcp-close-btn"),r=this.shadowRoot.querySelector(".mcp-titlebar");s?(s.addEventListener("click",()=>{this.handleMaximize()}),this.setupButtonHoverHandling(s)):n[e("log")](...t("log","âŒ maximizeBtn not found")),i?(i.addEventListener("click",()=>{this.handleClose({event:"closeButton"})}),this.setupButtonHoverHandling(i)):n[e("log")](...t("log","âŒ closeBtn not found")),r?r.addEventListener("dblclick",e=>{e.target.closest(".mcp-titlebar-btn")||this.handleMaximize()}):n[e("log")](...t("log","âŒ titlebar not found"));const a=this.shadowRoot.querySelector(".mcp-ai-selector");this.shadowRoot.querySelector(".mcp-ai-dropdown");a&&(a.addEventListener("click",e=>{e.stopPropagation(),this.toggleAIDropdown()}),this.setupButtonHoverHandling(a));this.shadowRoot.querySelectorAll(".mcp-ai-option").forEach(e=>{e.addEventListener("click",()=>{this.selectAI(e.getAttribute("data-ai"))}),this.setupButtonHoverHandling(e)});const l=this.shadowRoot.querySelector(".mcp-submit-btn"),c=this.shadowRoot.querySelector(".mcp-input-field");l&&(l.addEventListener("click",()=>{this.handleSubmit()}),this.setupButtonHoverHandling(l)),c&&(c.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.handleSubmit())}),c.addEventListener("input",()=>{this.autoResizeInput(c)})),document.addEventListener("click",e=>{!this.isDropdownOpen||e.target.closest(".mcp-ai-selector")||e.target.closest(".mcp-ai-dropdown")||this.closeAIDropdown()}),document.addEventListener("keydown",e=>{if("Escape"===e.key&&(this.isDropdownOpen&&this.closeAIDropdown(),this.isPermissionDropdownOpen&&this.closePermissionDropdown()),e.altKey)switch(e.key.toLowerCase()){case"t":e.preventDefault(),this.selectPermissionOption("thistime");break;case"w":e.preventDefault(),this.selectPermissionOption("always");break;case"d":e.preventDefault(),this.handlePermissionDeny();break;case"a":e.preventDefault(),this.handlePermissionAllow()}})}setupKeyboardNavigation(){const e=this.shadowRoot.querySelectorAll(".mcp-tab");e.forEach((t,o)=>{t.addEventListener("keydown",t=>{let s=o;switch(t.key){case"ArrowLeft":t.preventDefault(),s=o>0?o-1:e.length-1;break;case"ArrowRight":t.preventDefault(),s=o<e.length-1?o+1:0;break;case"Home":t.preventDefault(),s=0;break;case"End":t.preventDefault(),s=e.length-1;break;default:return}e[s].focus(),this.switchTab(e[s].getAttribute("data-tab"))})})}initializeUI(){this.selectAI(this.currentAI),this.messageData&&this.messageData?.data?.popTab?(this.switchTab(this.messageData.data.popTab),n[e("log")](...t("log","ðŸ” i-switchTab:",this.messageData.data.popTab))):(n[e("log")](...t("log","ðŸ” no default tab data",this)),this.updateInputSectionForTab(this.currentTab)),this.updatePermissionRequestUI();const o=this.shadowRoot.querySelector(".mcp-input-field");o&&!o.disabled&&setTimeout(()=>{o.focus()},100)}switchTab(o){if(n[e("log")](...t("log","ðŸ” switchTab:",o)),this.currentTab===o)return;this.shadowRoot.querySelectorAll(".mcp-tab").forEach(e=>{const t=e.getAttribute("data-tab")===o;e.classList.toggle("mcp-tab-active",t),e.setAttribute("aria-selected",t.toString())});this.shadowRoot.querySelectorAll(".mcp-panel").forEach(e=>{const t=e.id===`mcp-${o}-panel`;e.classList.toggle("mcp-panel-active",t)}),this.currentTab=o,this.updateInputSectionForTab(o),"settings"===o&&this.loadAndRenderSettings(),this.emitEvent("tabChanged",{tab:o})}updateInputSectionForTab(e){const t=this.shadowRoot.querySelector(".mcp-input-section"),o=this.shadowRoot.querySelector(".mcp-input-field");if(t&&o)switch(t.classList.remove("mcp-input-disabled","mcp-input-hidden"),o.disabled=!1,o.style.setProperty("pointer-events","auto","important"),e){case"chat":t.classList.add("mcp-input-disabled"),o.placeholder="Install an AI MCP to use this option",o.disabled=!0;break;case"ok":case"settings":case"default":t.classList.add("mcp-input-hidden");break;case"store":t.classList.add("mcp-input-disabled"),o.placeholder="Install AI_Store MCP to use this",o.disabled=!0;break;default:o.placeholder="Ask anything..."}}updatePermissionRequestUI(){const o=this.messageData?.data||this.messageData||{},s=this.shadowRoot.querySelector(".mcp-permission-ai-name");if(s){const i=o.caller_name||"AI";s.textContent=i,n[e("log")](...t("log","ðŸ”§ Updated AI name to:",i))}const i=this.shadowRoot.querySelector(".mcp-permission-server-name");if(i){const s=o.server_name||"unknown";i.textContent=s,n[e("log")](...t("log","ðŸ”§ Updated server name to:",s))}const r=this.shadowRoot.querySelector(".mcp-permission-tool-name");if(r){const s=o.tool_name||"tool";r.textContent=s,n[e("log")](...t("log","ðŸ”§ Updated tool name to:",s))}const a=o.comment;a&&this.addPermissionComment("Reason: "+a)}addPermissionComment(o){const s=this.shadowRoot.querySelector(".mcp-permission-request");if(!s)return;const i=s.querySelector(".mcp-permission-comment");i&&i.remove();const r=this.createElement("div",{className:"mcp-permission-comment",text:o}),a=s.querySelector(".mcp-permission-buttons");a&&(a.insertAdjacentElement("afterend",r),n[e("log")](...t("log","ðŸ”§ Added permission comment:",o)))}toggleAIDropdown(){this.isDropdownOpen?this.closeAIDropdown():this.openAIDropdown()}openAIDropdown(){const e=this.shadowRoot.querySelector(".mcp-ai-dropdown");if(e){e.classList.add("mcp-dropdown-open"),this.isDropdownOpen=!0;const t=e.querySelector(".mcp-ai-option");t&&t.focus()}}closeAIDropdown(){const e=this.shadowRoot.querySelector(".mcp-ai-dropdown");e&&(e.classList.remove("mcp-dropdown-open"),this.isDropdownOpen=!1)}selectAI(s){n[e("log")](...t("log",`ðŸ§  selectAI: from ${this.currentAI} to ${s}`)),this.currentAI!==s&&(o.pop.settings={id:"currentAI",value:{ai:s,set:"manual popover",prev:this.currentAI}}),this.currentAI=s;const i=this.shadowRoot.querySelector(".mcp-ai-selector .mcp-ai-icon"),r=this.shadowRoot.querySelector(`[data-ai="${s}"]`);if(i&&r){const e=r.querySelector(".mcp-ai-icon"),t=r.querySelector(".mcp-ai-name");e&&(i.className=e.className);const o=this.shadowRoot.querySelector(".mcp-ai-selector");o&&t&&(o.setAttribute("aria-label",`Current AI: ${t.textContent}`),o.setAttribute("title",t.textContent))}this.closeAIDropdown(),this.emitEvent("aiChanged",{ai:s})}handleSubmit(){const e=this.shadowRoot.querySelector(".mcp-input-field");if(!e)return;const t=e.value.trim();t&&(e.value="",this.autoResizeInput(e),this.emitEvent("messageSubmitted",{message:t,ai:this.currentAI,tab:this.currentTab}),e.focus())}handleMaximize(){const o=this.shadowRoot.host||document.querySelector(".mcp-floating-container");o?(this.isMaximized?this.restoreWindow(o):this.maximizeWindow(o),this.emitEvent(this.isMaximized?"windowRestored":"windowMaximized")):n[e("log")](...t("log","Maximize only available for floating popover"))}maximizeWindow(o){n[e("log")](...t("log","ðŸ” maximizeWindow() called"));const s=o.getBoundingClientRect();this.originalBounds={left:s.left,top:s.top,width:s.width,height:s.height},n[e("log")](...t("log","ðŸ“ Original bounds: left="+this.originalBounds.left+", top="+this.originalBounds.top+", width="+this.originalBounds.width+", height="+this.originalBounds.height));const i=window.innerWidth,r=window.innerHeight;n[e("log")](...t("log","ðŸ“ Viewport dimensions: width="+i+", height="+r));const a=getComputedStyle(document.body),l=getComputedStyle(document.documentElement);n[e("log")](...t("log","ðŸ“„ Body margins: "+a.margin+", padding: "+a.padding)),n[e("log")](...t("log","ðŸ“„ HTML margins: "+l.margin+", padding: "+l.padding)),o.style.transition="all 0.2s ease",o.style.setProperty("display","block","important"),o.style.setProperty("position","fixed","important"),o.style.setProperty("left","0px","important"),o.style.setProperty("top","0px","important"),o.style.setProperty("right","0px","important"),o.style.setProperty("bottom","0px","important"),o.style.setProperty("width","auto","important"),o.style.setProperty("height","auto","important"),o.style.setProperty("min-width","unset","important"),o.style.setProperty("min-height","unset","important"),o.style.setProperty("max-width","unset","important"),o.style.setProperty("max-height","unset","important"),o.style.setProperty("border-radius","0","important"),o.style.setProperty("resize","none","important"),o.style.setProperty("margin","0","important"),o.style.setProperty("padding","0","important"),o.style.setProperty("z-index","2147483647","important"),n[e("log")](...t("log","ðŸŽ¨ Applied maximized styles with !important")),setTimeout(()=>{const s=o.getBoundingClientRect(),a=getComputedStyle(o);n[e("log")](...t("log","ðŸ“ Final container rect: x="+s.x+", y="+s.y+", width="+s.width+", height="+s.height)),n[e("log")](...t("log","ðŸŽ¨ Final computed styles:")),n[e("log")](...t("log","  position: "+a.position)),n[e("log")](...t("log","  left: "+a.left)),n[e("log")](...t("log","  top: "+a.top)),n[e("log")](...t("log","  right: "+a.right)),n[e("log")](...t("log","  bottom: "+a.bottom)),n[e("log")](...t("log","  width: "+a.width)),n[e("log")](...t("log","  height: "+a.height)),n[e("log")](...t("log","  min-width: "+a.minWidth)),n[e("log")](...t("log","  min-height: "+a.minHeight)),n[e("log")](...t("log","  max-width: "+a.maxWidth)),n[e("log")](...t("log","  max-height: "+a.maxHeight)),n[e("log")](...t("log","  margin: "+a.margin)),n[e("log")](...t("log","  padding: "+a.padding)),n[e("log")](...t("log","  box-sizing: "+a.boxSizing));const l=(s.width/i*100).toFixed(1),c=(s.height/r*100).toFixed(1),d=s.left,p=s.top,m=i-s.right,h=r-s.bottom;n[e("log")](...t("log","ðŸ“Š Viewport coverage:")),n[e("log")](...t("log","  Width coverage: "+l+"%")),n[e("log")](...t("log","  Height coverage: "+c+"%")),n[e("log")](...t("log","  Left gap: "+d+"px")),n[e("log")](...t("log","  Top gap: "+p+"px")),n[e("log")](...t("log","  Right gap: "+m+"px")),n[e("log")](...t("log","  Bottom gap: "+h+"px")),m>0||h>0?(n[e("log")](...t("log","âš ï¸ Still have gaps! Checking for CSS conflicts...")),n[e("log")](...t("log","ðŸ” Container classes: "+o.className)),n[e("log")](...t("log","ðŸ” Container inline styles: "+o.style.cssText))):n[e("log")](...t("log","âœ… Perfect viewport coverage achieved!"))},250),this.isMaximized=!0;const c=this.shadowRoot.querySelector(".mcp-maximize-btn");c&&(c.setAttribute("title","Restore"),c.setAttribute("aria-label","Restore"))}restoreWindow(e){if(!this.originalBounds)return;e.style.transition="all 0.2s ease",e.style.display="contents",e.style.position="fixed",e.style.left=`${this.originalBounds.left}px`,e.style.top=`${this.originalBounds.top}px`,e.style.width=`${this.originalBounds.width}px`,e.style.height=`${this.originalBounds.height}px`,e.style.right="",e.style.bottom="",e.style.margin="",e.style.padding="",e.style.borderRadius="8px",this.isMaximized=!1,this.originalBounds=null;const t=this.shadowRoot.querySelector(".mcp-maximize-btn");t&&(t.setAttribute("title","Maximize"),t.setAttribute("aria-label","Maximize"))}handleClose(s){n[e("log")](...t("log","handleClose:",{msg:s,this:this})),this.emitEvent("closeRequested"),this.root?.remove(),c={},l.access_token&&(o.page.popoverMsg=""),n[e("log")](...t("log","âœ… done handleClose")),o.pop.ui_close={uiId:this.messageData.uiId,result:s.event}}autoResizeInput(e){e.style.height="auto";const t=parseFloat(getComputedStyle(e).fontSize),o=e.scrollHeight,s=Math.max(2.5*t,Math.min(8*t,o));e.style.height=`${s}px`}setupPermissionEventListeners(){const o=this.shadowRoot.querySelector(".mcp-scope-dropdown-btn");this.shadowRoot.querySelector(".mcp-permission-dropdown-menu");o?(o.addEventListener("click",o=>{o.stopPropagation(),n[e("log")](...t("log","ðŸ”§ Permission dropdown button clicked")),this.togglePermissionDropdown()}),this.setupButtonHoverHandling(o)):n[e("log")](...t("log","ðŸ”§ âŒ Permission dropdown button not found"));this.shadowRoot.querySelectorAll(".mcp-permission-dropdown-option").forEach(o=>{o.addEventListener("click",s=>{s.stopPropagation();const i=o.getAttribute("data-option");n[e("log")](...t("log","Permission option clicked:",i)),this.selectPermissionOption(i)}),this.setupButtonHoverHandling(o)});const s=this.shadowRoot.querySelector(".mcp-deny-btn"),i=this.shadowRoot.querySelector(".mcp-ok-btn");s&&(s.addEventListener("click",()=>{this.handlePermissionDeny()}),this.setupButtonHoverHandling(s)),i&&(i.addEventListener("click",()=>{this.handlePermissionAllow()}),this.setupButtonHoverHandling(i)),this.shadowRoot&&this.shadowRoot.host?(this.shadowRoot.addEventListener("click",e=>{this.isPermissionDropdownOpen&&!e.target.closest(".mcp-permission-scope-dropdown")&&this.closePermissionDropdown()}),document.addEventListener("click",e=>{if(this.isPermissionDropdownOpen){const t=this.shadowRoot.host;t.contains(e.target)||e.target===t||this.closePermissionDropdown()}})):document.addEventListener("click",e=>{this.isPermissionDropdownOpen&&!e.target.closest(".mcp-permission-scope-dropdown")&&this.closePermissionDropdown()})}setupButtonHoverHandling(e){e&&(e.addEventListener("mouseenter",()=>{e.classList.add("mcp-hover")}),e.addEventListener("mouseleave",()=>{e.classList.remove("mcp-hover")}),e.addEventListener("mousedown",()=>{e.classList.add("mcp-active")}),e.addEventListener("mouseup",()=>{e.classList.remove("mcp-active")}),e.addEventListener("mouseleave",()=>{e.classList.remove("mcp-active")}))}togglePermissionDropdown(){n[e("log")](...t("log","ðŸ”§ togglePermissionDropdown called, current state:",this.isPermissionDropdownOpen)),this.isPermissionDropdownOpen?this.closePermissionDropdown():this.openPermissionDropdown()}openPermissionDropdown(){const e=this.shadowRoot.querySelector(".mcp-permission-dropdown-menu");if(e){e.classList.add("mcp-dropdown-open"),this.isPermissionDropdownOpen=!0;const t=e.querySelector(".mcp-permission-dropdown-option");t&&t.focus()}}closePermissionDropdown(){const e=this.shadowRoot.querySelector(".mcp-permission-dropdown-menu");e&&(e.classList.remove("mcp-dropdown-open"),this.isPermissionDropdownOpen=!1)}selectPermissionOption(o){n[e("log")](...t("log","ðŸ”§ selectPermissionOption called with:",o));const s=this.shadowRoot.querySelector(".mcp-scope-dropdown-btn .mcp-btn-text"),i=this.shadowRoot.querySelectorAll(".mcp-permission-dropdown-option");if(n[e("log")](...t("log","ðŸ”§ Found btnText:",s)),n[e("log")](...t("log","ðŸ”§ Found options:",i.length,i)),s&&i.length>0){if(i.forEach(o=>{o.classList.remove("mcp-selected"),n[e("log")](...t("log","ðŸ”§ Removed mcp-selected from:",o.getAttribute("data-option")))}),"always"===o){s.textContent="",s.appendChild(document.createTextNode("Al"));const o=document.createElement("u");o.textContent="w",s.appendChild(o),s.appendChild(document.createTextNode("ays"));const i=this.shadowRoot.querySelector('.mcp-permission-dropdown-option[data-option="always"]');i&&(i.classList.add("mcp-selected"),n[e("log")](...t("log","ðŸ”§ Added mcp-selected to always option")))}else if("thistime"===o){s.textContent="";const o=document.createElement("u");o.textContent="T",s.appendChild(o),s.appendChild(document.createTextNode("his time"));const i=this.shadowRoot.querySelector('.mcp-permission-dropdown-option[data-option="thistime"]');i&&(i.classList.add("mcp-selected"),n[e("log")](...t("log","ðŸ”§ Added mcp-selected to thistime option")))}}else n[e("log")](...t("log","ðŸ”§ âŒ btnText or options not found"));this.closePermissionDropdown(),this.emitEvent("permissionOptionSelected",{option:o})}handlePermissionDeny(){n[e("log")](...t("log","Permission denied")),this.emitEvent("permissionDenied",{tool:"browser"}),this.handleClose({event:"deny"})}handlePermissionAllow(){n[e("log")](...t("log","Permission allowed",o)),o.pop.allow={permission:!0},this.emitEvent("permissionAllowed",{tool:"browser"}),this.handleClose({event:"ok"})}emitEvent(e,t={}){const o=new CustomEvent(`mcp:${e}`,{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(o)}setTab(e){this.switchTab(e)}setAI(e){this.selectAI(e)}showTitleBar(e=!0){const t=this.root.querySelector(".mcp-popover");t&&t.setAttribute("data-show-titlebar",e.toString())}setMessage(e){const t=this.root.querySelector(".mcp-input-field");t&&(t.value=e,this.autoResizeInput(t),t.focus())}setContextMessage(e,t="ðŸ–¼ï¸"){const o=this.root.querySelector(".mcp-context-message");if(o){const s=o.querySelector(".mcp-context-icon"),n=o.querySelector(".mcp-context-text");s&&(s.textContent=t),n&&(n.textContent=e)}}EVENTS_TO_BLOCK=["keydown","keypress","keyup","input","change","paste","cut","copy","mousedown","mouseup","click","dblclick","contextmenu","mousemove","mouseenter","mouseleave","mouseover","mouseout","touchstart","touchmove","touchend","touchcancel","pointerdown","pointermove","pointerup","wheel","scroll","focus","blur","beforeunload"];blockAllEvents(o){n[e("log")](...t("log","blockAllEvents:",o))}activateEventShield(o=document){for(const e of this.EVENTS_TO_BLOCK)o.addEventListener(e,this.blockAllEvents,!0);n[e("log")](...t("log","âœ… Event shield activated"))}deactivateEventShield(o=document){for(const e of this.EVENTS_TO_BLOCK)o.removeEventListener(e,this.blockAllEvents,!0);n[e("log")](...t("log","âœ… Event shield deactivated"))}createElement(e,t={}){const o=document.createElement(e);return t.text&&(o.textContent=t.text),t.className&&(o.className=t.className),t.attrs&&Object.entries(t.attrs).forEach(([e,t])=>{o.setAttribute(e,t)}),t.children&&Array.isArray(t.children)&&t.children.forEach(e=>{e&&o.appendChild(e)}),o}async loadAndRenderSettings(){n[e("log")](...t("log","ðŸ”§ Loading settings..."));try{const s=await o.perm.configs,i=s?.settings?.value;if(!i||!Array.isArray(i))return n[e("error")](...t("error","Invalid settings data structure:",i)),o.pop.reset_settings=!0,setTimeout(()=>{this.loadAndRenderSettings()},1e3),void this.showSettingsError("Failed to load settings data. Settings reset. Please try again.");n[e("log")](...t("log","ðŸ”§ Settings data loaded:",i));const r=i[0]||{},a=i.slice(1)||[];this.renderSettingsUI(r,a)}catch(s){n[e("error")](...t("error","Failed to load settings:",s)),o.pop.reset_settings=!0,setTimeout(()=>{this.loadAndRenderSettings()},1e3),this.showSettingsError(`Failed to load settings: ${s.message}. Settings reset. Please try again.`)}}renderSettingsUI(o,s){const i=this.shadowRoot.querySelector(".mcp-settings-content");if(!i)return void n[e("error")](...t("error","Settings content area not found"));for(;i.firstChild;)i.removeChild(i.firstChild);const r=this.createElement("div",{className:"mcp-settings-header",children:[this.createElement("h3",{text:"Extension Settings"}),this.createElement("p",{text:"Configure your MCP-Link extension preferences."})]});i.appendChild(r),s.forEach((e,t)=>{const s=this.createSettingElement(e,o);s&&i.appendChild(s)}),n[e("log")](...t("log","ðŸ”§ Settings UI rendered with",s.length,"controls"))}createSettingElement(o,s){const{type:i,id:r,label:a,description:l,help_text:c}=o;return"button"===i?this.createButtonSetting(o):"checkbox"===i?this.createCheckboxSetting(o,s):"server_management"===i?this.createServerManagementSetting(o,s):(n[e("warn")](...t("warn","Unsupported setting type:",i)),null)}createButtonSetting(e){const{id:t,label:o,description:s,help_text:n,button_style:i,icon:r,width:a,confirmation:l,action:c,visibility:d,position:p}=e,m="mcp-setting-container"+("bottom"===p?" mcp-position-bottom":""),h=this.createElement("div",{className:m}),u=this.createElement("div",{className:"mcp-setting-header",children:[...r?[this.createElement("span",{text:r,className:"mcp-setting-icon"})]:[],this.createElement("h4",{text:o,className:"mcp-setting-title"})]}),g=this.createElement("p",{text:s,className:"mcp-setting-description"}),y=n?this.createElement("p",{text:n,className:"mcp-setting-help"}):null,v=this.createElement("div",{className:"mcp-setting-content",children:[u,g,...y?[y]:[]]}),w=["mcp-settings-button",`mcp-style-${i||"default"}`];"full"===a&&w.push("mcp-width-full");const b=this.createElement("button",{text:o,className:w.join(" ")});this.setupButtonHoverHandling(b),b.addEventListener("click",()=>{this.handleButtonSettingClick(e)});const f=this.createElement("div",{children:[v,b]});return h.appendChild(f),h}createCheckboxSetting(o,s){const{id:i,label:r,description:a,tooltip:l,icon:c,position:d,confirmation_on_enable:p,visibility:m}=o,h="mcp-setting-container"+("bottom"===d?" mcp-position-bottom":""),u=this.createElement("div",{className:h}),g=this.createElement("div",{className:"mcp-checkbox-title-row"}),y=this.createElement("div",{className:"mcp-checkbox-left-side",children:[...c?[this.createElement("span",{text:c,className:"mcp-setting-icon"})]:[],this.createElement("h4",{text:r,className:"mcp-setting-title"})]}),v=s[i]??!1,w=this.createElement("input",{attrs:{type:"checkbox",id:`setting-${i}`,...v?{checked:"checked"}:{},...l?{title:l}:{}},className:"mcp-checkbox-input"}),b=this.createElement("label",{text:""+(v?"Enabled":"Disabled"),attrs:{for:`setting-${i}`},className:"mcp-checkbox-label"}),f=this.createElement("div",{className:"mcp-checkbox-right-side",children:[w,b]});g.appendChild(y),g.appendChild(f);const S=this.createElement("p",{text:a,className:"mcp-checkbox-description"});w.addEventListener("change",async o=>{const s=o.target.checked;if(s&&p?.required){if(!await this.showConfirmationDialog(p))return void(w.checked=!s)}await this.updateSettingValue(i,s),b.textContent=s?"Enabled":"Disabled",n[e("log")](...t("log",`ðŸ”§ Setting ${i} changed to:`,s))});const E=this.createElement("div",{children:[g,S]});return u.appendChild(E),u}createServerManagementSetting(e,t){const{id:o,label:s,description:n,help_text:i,position:r}=e,a="mcp-setting-container"+("bottom"===r?" mcp-position-bottom":""),l=this.createElement("div",{className:a}),c=this.createElement("div",{className:"mcp-setting-header",children:[this.createElement("h4",{text:s,className:"mcp-setting-title"})]}),d=this.createElement("p",{text:n,className:"mcp-setting-description"}),p=t[o]||{},m=Object.keys(p).length,h=this.createElement("span",{text:`${m} configured`,className:"mcp-server-count"}),u=this.createElement("button",{text:"+ Add New Server",className:"mcp-settings-button mcp-style-primary mcp-add-server-btn"});u.addEventListener("click",()=>{this.showServerEditModal(null,p,e=>{this.updateSettingValue(o,e),this.refreshServerList(l,e)})});const g=this.createElement("div",{className:"mcp-server-header-row",children:[c,h]}),y=this.createElement("div",{className:"mcp-server-list"});this.renderServerList(y,p,e=>{this.updateSettingValue(o,e),this.refreshServerList(l,e)});const v=this.createElement("div",{children:[g,d,u,y]});return l.appendChild(v),l}getButtonStyles(e){switch(e){case"danger":return"\n            background: #dc3545 !important;\n            color: white !important;\n          ";case"primary":return"\n            background: #007bff !important;\n            color: white !important;\n          ";case"secondary":return"\n            background: #6c757d !important;\n            color: white !important;\n          ";case"warning":return"\n            background: #ffc107 !important;\n            color: #212529 !important;\n          ";default:return"\n            background: #f8f9fa !important;\n            color: #495057 !important;\n            border: 1px solid #dee2e6 !important;\n          "}}getButtonStylesObject(e){switch(e){case"danger":return{background:"#dc3545",color:"white"};case"primary":return{background:"#007bff",color:"white"};case"secondary":return{background:"#6c757d",color:"white"};case"warning":return{background:"#ffc107",color:"#212529"};default:return{background:"#f8f9fa",color:"#495057",border:"1px solid #dee2e6"}}}async handleButtonSettingClick(o){const{confirmation:s,action:i,id:r}=o;if(n[e("log")](...t("log","ðŸ”§ Button setting clicked:",r)),s?.required){if(!await this.showConfirmationDialog(s))return void n[e("log")](...t("log","ðŸ”§ Action cancelled by user"))}await this.executeSettingAction(i,o)}showConfirmationDialog(e){return new Promise(t=>{const{title:o,message:s,confirm_button_text:n,cancel_button_text:i,confirm_button_style:r,require_double_confirmation:a,double_confirmation_text:l,double_confirmation_prompt:c}=e,d=this.createElement("div",{className:"mcp-modal-overlay"}),p=this.createElement("h3",{text:o,className:"mcp-modal-title"}),m=this.createElement("div",{text:s,className:"mcp-modal-message"});let h=null,u=null;if(a){const e=this.createElement("label",{text:c,className:"mcp-modal-input-label-inline"});u=this.createElement("input",{attrs:{type:"text",id:"confirmation-input",placeholder:`Type '${l}' here`},className:"mcp-modal-input-inline"}),h=this.createElement("div",{className:"mcp-modal-input-group-inline",children:[e,u]})}const g=this.createElement("button",{text:i,attrs:{id:"cancel-btn"},className:"mcp-settings-button mcp-style-default"}),y=["mcp-settings-button",`mcp-style-${r||"primary"}`],v=this.createElement("button",{text:n,attrs:{id:"confirm-btn",...a?{disabled:"true"}:{}},className:y.join(" ")});a&&(v.style.setProperty("opacity","0.5","important"),v.style.setProperty("cursor","not-allowed","important"));const w=[p,m,...h?[h]:[],this.createElement("div",{className:"mcp-modal-buttons",children:[g,v]})],b=this.createElement("div",{className:"mcp-modal-dialog",children:w});d.appendChild(b);(this.shadowRoot||document.body).appendChild(d),a&&u&&(u.addEventListener("input",()=>{const e=u.value.trim()===l;v.disabled=!e,v.style.setProperty("opacity",e?"1":"0.5","important"),v.style.setProperty("cursor",e?"pointer":"not-allowed","important")}),u.addEventListener("keydown",e=>{"Enter"===e.key&&u.value.trim()===l&&(t(!0),d.remove())})),g.addEventListener("click",()=>{t(!1),d.remove()}),v.addEventListener("click",()=>{t(!0),d.remove()});const escHandler=e=>{"Escape"===e.key&&(t(!1),d.remove(),document.removeEventListener("keydown",escHandler))};document.addEventListener("keydown",escHandler),a&&u&&setTimeout(()=>{u.focus()},100)})}async executeSettingAction(s,i){const{type:r,function_name:a,parameters:l,post_action:c}=s;n[e("log")](...t("log","ðŸ”§ Executing setting action:",s));try{"function_call"===r&&"reset_settings"===a&&(o.pop.reset_settings=!0,c?.show_notification&&this.showNotification(c.show_notification),"reload_settings"===c?.type&&setTimeout(()=>{this.loadAndRenderSettings()},1e3))}catch(o){n[e("error")](...t("error","Failed to execute setting action:",o)),this.showNotification({type:"error",message:`Failed to execute action: ${o.message}`,duration_ms:5e3})}}async updateSettingValue(s,i){try{n[e("log")](...t("log",`ðŸ”§ Updating setting ${s} to:`,i)),o.pop.settings={id:s,value:i},n[e("log")](...t("log",`ðŸ”§ Setting ${s} update sent to background`))}catch(o){throw n[e("error")](...t("error",`Failed to update setting ${s}:`,o)),this.showNotification({type:"error",message:`Failed to update setting: ${o.message}`,duration_ms:5e3}),o}}renderServerList(e,t,o){for(;e.firstChild;)e.removeChild(e.firstChild);const s=Object.keys(t);if(0===s.length){const t=this.createElement("div",{className:"mcp-server-empty",children:[this.createElement("p",{text:"No MCP servers configured yet.",className:"mcp-server-empty-text"}),this.createElement("p",{text:'Click "Add New Server" to get started.',className:"mcp-server-empty-hint"})]});return void e.appendChild(t)}s.forEach(s=>{const n=t[s];e.appendChild(this.createServerListItem(s,n,t,o))})}createServerListItem(e,t,o,s){const{url:n,headers:i={}}=t,r=Object.keys(i).length,a=this.createElement("div",{className:"mcp-server-item"}),l=this.createElement("div",{className:"mcp-server-item-header"}),c=this.createElement("button",{text:"â–¼",className:"mcp-server-expand-btn"}),d=this.createElement("div",{className:"mcp-server-info",children:[this.createElement("div",{text:e,className:"mcp-server-name"}),this.createElement("div",{text:this.truncateUrl(n),className:"mcp-server-url"}),this.createElement("div",{text:r>0?`Headers: ${Object.keys(i).join(", ")}`:"No headers",className:"mcp-server-headers"})]});l.appendChild(c),l.appendChild(d);const p=this.createElement("div",{className:"mcp-server-details mcp-server-details-hidden"}),m=this.createElement("div",{className:"mcp-server-actions",children:[this.createElement("button",{text:"Edit",className:"mcp-settings-button mcp-style-primary mcp-server-edit-btn"}),this.createElement("button",{text:"Delete",className:"mcp-settings-button mcp-style-danger mcp-server-delete-btn"})]});let h=!1;c.addEventListener("click",()=>{h=!h,c.textContent=h?"â–²":"â–¼",h?(p.classList.remove("mcp-server-details-hidden"),this.renderServerDetails(p,t)):p.classList.add("mcp-server-details-hidden")});m.children[0].addEventListener("click",()=>{this.showServerEditModal(e,o,s)});return m.children[1].addEventListener("click",()=>{this.showServerDeleteConfirmation(e,o,s)}),a.appendChild(l),a.appendChild(p),a.appendChild(m),a}truncateUrl(e){return e.length<=50?e:e.substring(0,47)+"..."}renderServerDetails(e,t){for(;e.firstChild;)e.removeChild(e.firstChild);const{url:o,headers:s={}}=t,n=this.createElement("div",{className:"mcp-server-detail-section",children:[this.createElement("strong",{text:"URL:"}),this.createElement("div",{text:o,className:"mcp-server-detail-value"})]});e.appendChild(n);const i=Object.keys(s);if(i.length>0){const t=this.createElement("div",{className:"mcp-server-detail-section",children:[this.createElement("strong",{text:"Headers:"})]});i.forEach(e=>{const o=s[e],n=this.createElement("div",{className:"mcp-server-header-row",children:[this.createElement("span",{text:`${e}:`,className:"mcp-server-header-name"}),this.createElement("span",{text:this.truncateHeaderValue(o),className:"mcp-server-header-value"})]});t.appendChild(n)}),e.appendChild(t)}}truncateHeaderValue(e){return e.length<=40?e:e.substring(0,37)+"..."}refreshServerList(e,t){const o=e.querySelector(".mcp-server-list"),s=e.querySelector(".mcp-server-count");if(o&&this.renderServerList(o,t,t=>{this.updateSettingValue("mcpServers",t),this.refreshServerList(e,t)}),s){const e=Object.keys(t).length;s.textContent=`${e} configured`}}showServerEditModal(o,s,i){const r=null!==o,a=r?s[o]:{url:"",headers:{}};n[e("log")](...t("log",`ðŸ”§ ${r?"Editing":"Adding"} server:`,o,a));const l=this.createElement("div",{className:"mcp-modal-overlay"}),c=this.createElement("div",{className:"mcp-modal-dialog"}),d=this.createElement("h3",{text:r?"Edit MCP Server":"Add New MCP Server",className:"mcp-modal-title"}),p=this.createElement("div",{className:"mcp-server-form"}),m=this.createElement("label",{text:"Server Name:",className:"mcp-modal-input-label"}),h=this.createElement("input",{attrs:{type:"text",placeholder:"e.g., ragtag_aura",value:r?o:""},className:"mcp-modal-input"}),u=this.createElement("div",{className:"mcp-modal-input-group",children:[m,h]}),g=this.createElement("label",{text:"Server URL:",className:"mcp-modal-input-label"}),y=this.createElement("input",{attrs:{type:"url",placeholder:"https://example.com:31173/sse",value:a.url||""},className:"mcp-modal-input"}),v=this.createElement("div",{className:"mcp-modal-input-group",children:[g,y]}),w=this.createElement("label",{text:"Headers (optional):",className:"mcp-modal-input-label"}),b=this.createElement("div",{className:"mcp-headers-container"}),f=this.createElement("button",{text:"+ Add Header",className:"mcp-settings-button mcp-style-secondary mcp-add-header-btn"}),S=this.createElement("div",{className:"mcp-modal-input-group",children:[w,b,f]});p.appendChild(u),p.appendChild(v),p.appendChild(S);const E=this.createElement("div",{className:"mcp-modal-buttons",children:[this.createElement("button",{text:"Cancel",className:"mcp-settings-button mcp-style-default mcp-cancel-btn"}),this.createElement("button",{text:r?"Update Server":"Add Server",className:"mcp-settings-button mcp-style-primary mcp-save-btn"})]});c.appendChild(d),c.appendChild(p),c.appendChild(E),l.appendChild(c);(this.shadowRoot||document.body).appendChild(l),this.initializeHeadersUI(b,a.headers||{}),this.setupServerModalEventHandlers(l,h,y,b,f,r,o,s,i),setTimeout(()=>{h.focus(),r&&h.select()},100)}initializeHeadersUI(e,t){for(;e.firstChild;)e.removeChild(e.firstChild);Object.entries(t).forEach(([t,o])=>{this.addHeaderRow(e,t,o)}),0===Object.keys(t).length&&this.showHeadersEmptyState(e)}addHeaderRow(e,t="",o=""){const s=e.querySelector(".mcp-headers-empty");s&&s.remove();const n=this.createElement("div",{className:"mcp-header-row"}),i=this.createElement("input",{attrs:{type:"text",placeholder:"Header name (e.g., Authorization)",value:t},className:"mcp-header-key-input"}),r=this.createElement("input",{attrs:{type:"text",placeholder:"Header value (e.g., Bearer token123)",value:o},className:"mcp-header-value-input"}),a=this.createElement("button",{text:"Ã—",className:"mcp-header-remove-btn"});a.addEventListener("click",()=>{n.remove(),0===e.children.length&&this.showHeadersEmptyState(e)}),n.appendChild(i),n.appendChild(r),n.appendChild(a),e.appendChild(n),t||setTimeout(()=>i.focus(),50)}showHeadersEmptyState(e){const t=this.createElement("div",{className:"mcp-headers-empty",children:[this.createElement("p",{text:"No headers configured.",className:"mcp-headers-empty-text"}),this.createElement("p",{text:"Most servers work without headers, but some require authentication.",className:"mcp-headers-empty-hint"})]});e.appendChild(t)}setupServerModalEventHandlers(e,t,o,s,n,i,r,a,l){const c=e.querySelector(".mcp-cancel-btn"),d=e.querySelector(".mcp-save-btn");c.addEventListener("click",()=>{e.remove()}),n.addEventListener("click",()=>{this.addHeaderRow(s)}),d.addEventListener("click",()=>{this.handleServerSave(e,t,o,s,i,r,a,l)});const escHandler=t=>{"Escape"===t.key&&(e.remove(),document.removeEventListener("keydown",escHandler))};document.addEventListener("keydown",escHandler);e.addEventListener("keydown",n=>{"Enter"===n.key&&"TEXTAREA"!==n.target.tagName&&(n.preventDefault(),this.handleServerSave(e,t,o,s,i,r,a,l))})}handleServerSave(o,s,i,r,a,l,c,d){const p=s.value.trim(),m=i.value.trim(),h=this.validateServerInput(p,m,a,l,c);if(!h.valid)return void this.showNotification({type:"error",message:h.error,duration_ms:4e3});const u=this.collectHeaders(r),g={url:m,...Object.keys(u).length>0?{headers:u}:{}},y={...c};a&&l!==p&&delete y[l],y[p]=g,n[e("log")](...t("log",`ðŸ”§ ${a?"Updated":"Added"} server:`,p,g)),d(y),o.remove(),this.showNotification({type:"success",message:`Server "${p}" has been ${a?"updated":"added"}.`,duration_ms:3e3})}validateServerInput(e,t,o,s,n){if(!e)return{valid:!1,error:"Server name is required."};if(!/^[a-zA-Z0-9_-]+$/.test(e))return{valid:!1,error:"Server name can only contain letters, numbers, underscores, and hyphens."};if((!o||s!==e)&&n[e])return{valid:!1,error:`A server named "${e}" already exists. Please choose a different name.`};if(!t)return{valid:!1,error:"Server URL is required."};try{const e=new URL(t);if(!["http:","https:"].includes(e.protocol))return{valid:!1,error:"URL must use http:// or https:// protocol."}}catch(e){return{valid:!1,error:"Please enter a valid URL (e.g., https://example.com:9443/sse)."}}return{valid:!0}}collectHeaders(e){const t={};return e.querySelectorAll(".mcp-header-row").forEach(e=>{const o=e.querySelector(".mcp-header-key-input"),s=e.querySelector(".mcp-header-value-input"),n=o.value.trim(),i=s.value.trim();n&&i&&(t[n]=i)}),t}showServerDeleteConfirmation(o,s,i){const r={title:"Delete MCP Server?",message:`Are you sure you want to delete the server "${o}"?\n\nThis will permanently remove the server configuration and cannot be undone.`,confirm_button_text:"Yes, Delete Server",confirm_button_style:"danger",cancel_button_text:"Cancel"};this.showConfirmationDialog(r).then(r=>{if(r){const r={...s};delete r[o],n[e("log")](...t("log",`ðŸ”§ Deleted server: ${o}`)),i(r),this.showNotification({type:"success",message:`Server "${o}" has been deleted.`,duration_ms:3e3})}})}showNotification(e){const{type:t,message:o,duration_ms:s=3e3}=e,n=this.createElement("div",{text:o,className:`mcp-notification mcp-notification-${t||"success"}`});document.body.appendChild(n),setTimeout(()=>{n.className+=" mcp-slide-out",setTimeout(()=>{n.remove()},300)},s)}showSettingsError(e){const t=this.shadowRoot.querySelector(".mcp-settings-content");if(!t)return;for(;t.firstChild;)t.removeChild(t.firstChild);const o=this.createElement("div",{className:"mcp-settings-error",children:[this.createElement("h3",{text:"Settings Error"}),this.createElement("p",{text:e})]});t.appendChild(o)}setupDragging(){const o=this.shadowRoot.querySelector(".mcp-titlebar"),s=this.root||document.querySelector(".mcp-popover");if(!o||!s)return n[e("error")](...t("error","âŒ setupDragging early return - missing elements")),n[e("error")](...t("error","   titlebar:",o)),void n[e("error")](...t("error","   container:",s));let i=!1,r=0,a=0,l=0,c=0,d="";const getCurrentPosition=()=>{const e=s.getBoundingClientRect();return{left:e.left,top:e.top}},setPosition=(e,t)=>{s.style.left=`${e}px`,s.style.top=`${t}px`};o.addEventListener("mousedown",e=>{if(e.target.closest(".mcp-titlebar-btn"))return;i=!0,r=e.clientX,a=e.clientY;const t=getCurrentPosition();l=t.left,c=t.top,o.style.setProperty("cursor","grabbing","important"),d=document.body.style.userSelect,document.body.style.userSelect="none",e.preventDefault()}),document.addEventListener("mousemove",e=>{if(!i)return;const t=e.clientX-r,o=e.clientY-a;setPosition(l+t,c+o),e.preventDefault()}),document.addEventListener("mouseup",e=>{i&&(i=!1,o.style.setProperty("cursor","grab","important"),document.body.style.userSelect=d)}),o.addEventListener("touchstart",e=>{if(e.target.closest(".mcp-titlebar-btn"))return;i=!0;const t=e.touches[0];r=t.clientX,a=t.clientY;const s=getCurrentPosition();l=s.left,c=s.top,o.style.setProperty("cursor","grabbing","important"),e.preventDefault()},{passive:!1}),document.addEventListener("touchmove",e=>{if(!i)return;const t=e.touches[0],o=t.clientX-r,s=t.clientY-a;setPosition(l+o,c+s),e.preventDefault()},{passive:!1}),document.addEventListener("touchend",e=>{i&&(i=!1,o.style.setProperty("cursor","grab","important"))}),o.addEventListener("selectstart",e=>e.preventDefault()),o.style.setProperty("cursor","grab","important"),n[e("log")](...t("log","âœ… setupDragging completed successfully")),n[e("log")](...t("log","ðŸ” Final titlebar cursor style:",o.style.cursor)),n[e("log")](...t("log","ðŸ” Final titlebar element:",o))}}function initializeMCPPopover(s=document,i,r){let a=null;if(void 0===c.mcpPopover){n[e("log")](...t("log","ðŸ”„ Initializing MCPPopover with container:",{container:s,shadowRootOrDocument:i,messageData:r}));try{c.mcpPopover=new MCPPopover(s,i,r),n[e("log")](...t("log","âœ… MCPPopover initialized successfully")),a=c.mcpPopover}catch(o){n[e("error")](...t("error","âŒ Error initializing MCPPopover:",o)),a=null}}else n[e("log")](...t("log","â„¹ï¸ MCPPopover already initialized")),a=c.mcpPopover;Object.entries(r.data?.vars||{}).forEach(([o,s])=>{const r=i.querySelector(".mcp-popover")||i.firstElementChild;r?(r.style.setProperty(`--${o}`,s),n[e("log")](...t("log",`âœ… Set CSS variable --${o}: ${s} on`,r.className||r.tagName))):n[e("warn")](...t("warn",`âŒ No root element found in ${i===document?"main DOM":"shadow DOM"} to apply --${o}: ${s}`))});try{n[e("log")](...t("log","ðŸ§  pop",{mcp_link:o,pop:o.pop})),useAiPromise=o.pop["settings.currentAI"],useAiPromise instanceof Promise&&useAiPromise.then(o=>{n[e("log")](...t("log","ðŸ§  got default ai of:",o)),a.selectAI(o?.ai)})}catch(o){n[e("error")](...t("error","ðŸ§  i-constructor:",o))}return a}function applyFloatingContainerStyles(o){try{o.style.position="fixed",o.style.top="calc(50vh - 150px)",o.style.left="calc(50vw - 200px)",o.style.width="400px",o.style.height="300px",o.style.zIndex="2147483647",o.style.border="1px solid rgba(0, 0, 0, 0.2)",o.style.borderRadius="8px",o.style.boxShadow="0 10px 30px rgba(0, 0, 0, 0.2)",o.style.resize="both",o.style.overflow="hidden",o.style.minWidth="320px",o.style.minHeight="240px",window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(o.style.border="1px solid rgba(255, 255, 255, 0.2)",o.style.boxShadow="0 10px 30px rgba(0, 0, 0, 0.4)"),o.addEventListener("mouseenter",()=>{window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?o.style.boxShadow="0 15px 40px rgba(0, 0, 0, 0.5)":o.style.boxShadow="0 15px 40px rgba(0, 0, 0, 0.25)"}),o.addEventListener("mouseleave",()=>{window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?o.style.boxShadow="0 10px 30px rgba(0, 0, 0, 0.4)":o.style.boxShadow="0 10px 30px rgba(0, 0, 0, 0.2)"}),n[e("log")](...t("log","âœ… Applied floating container styles via JS"))}catch(o){n[e("error")](...t("error","âŒ Failed to apply floating container styles:",o))}}function fixCSSPathForNonExtensionContext(){if("(web)"===self.RUNNING_IN_SCOPE||"(webview2)"===self.RUNNING_IN_SCOPE||"(page)"===self.RUNNING_IN_SCOPE){const o=document.getElementById("mcp-main-css");if(o){const s=o.href;return o.href="popover.css",n[e("log")](...t("log",` Switched CSS from "${s}" to "popover.css" for ${self.RUNNING_IN_SCOPE} context`)),!0}return n[e("warn")](...t("warn",` CSS link element #mcp-main-css not found for ${self.RUNNING_IN_SCOPE} context`)),!1}return!0}l.response=s=>{n[e("log")](...t("log","response:",s));const i=o.pendingRequests.get(s.requestId);o.pendingRequests.delete(s.requestId),i(s.result)};const createAsyncBgProxy=s=>new Proxy(s,{get:(e,t)=>new Promise(s=>{const n=getUUID();o.pendingRequests.set(n,s),chrome.runtime.sendMessage({type:e.get,ret:e.get_ret,requestId:n,key:e.key,prop:t,broadcast:e.broadcast})}),set:(o,s,i)=>(n[e("log")](...t("log","in set:",{target:o,prop:s,value:i})),i instanceof MessagePort?(n[e("warn")](...t("warn","âš ï¸ MessagePort values not supported in direct chrome.runtime.sendMessage")),!1):(chrome.runtime.sendMessage({type:o.set,ret:o.get_ret,key:o.key,prop:s,value:i,broadcast:o.broadcast}),!0)),deleteProperty:(e,t)=>(chrome.runtime.sendMessage({type:e.deleteProperty,key:e.key,prop:t,broadcast:e.broadcast}),!0),ownKeys:e=>new Promise(t=>{const s=getUUID();o.pendingRequests.set(s,t),chrome.runtime.sendMessage({type:e.ownKeys,ret:e.get_ret,requestId:s,key:e.key,broadcast:e.broadcast})}),has:(e,t)=>new Promise(s=>{const n=getUUID();o.pendingRequests.set(n,s),chrome.runtime.sendMessage({type:e.has,ret:e.get_ret,requestId:n,key:e.key,prop:t,broadcast:e.broadcast})})});if("(webview2)"===self.RUNNING_IN_SCOPE||"(web)"===self.RUNNING_IN_SCOPE){let o=!0,s=[],n=window.console;n.nolog=(...e)=>{},cname=()=>`${(new Date).toISOString()} ui.js ${self.RUNNING_IN_SCOPE}`,t=(e,...t)=>{const o=[cname(),...t];let n="unknown:0.0";const i=((new Error).stack.split("\n")[2]||"").match(/\s+at\s+(?:(.+)\s+\()?(?:(.+):(\d+):(\d+))\)?/);if(i){const[,e,t,o,s]=i,r=t.split(/[\/\\]/);n=`${r[r.length-1]}:${o}.${s}`}return Array.isArray(s)&&s.length<1e4&&s.push({severity:e,args:o,caller:`[${e} ${n}]`}),o},e=e=>o?e:"nolog",n[e("log")](...t("log","webview2/browser window - HTML already loaded, activating in main DOM")),function activateWebViewPopover(){try{const o=document.querySelector(".mcp-popover")||document.body;if(!o)return void n[e("error")](...t("error","âŒ No .mcp-popover found in main DOM for webview2/browser context"));n[e("log")](...t("log","ðŸ“„ Found existing content, activating functionality in main DOM"));const s=o===document.body?document:o;setupScriptsAndHandlers(document,"script[data-mcp]"),document.querySelectorAll("template").forEach(e=>{const t=e.content?.querySelector("style");t&&l.applyCssString(t.textContent,document)}),fixCSSPathForNonExtensionContext()||("loading"===document.readyState?document.addEventListener("DOMContentLoaded",fixCSSPathForNonExtensionContext):setTimeout(fixCSSPathForNonExtensionContext,10));const i={data:{caller:self.RUNNING_IN_SCOPE,popTab:"settings",vars:{"mcp-show-titlebar":"none"}}};finalizeContainerSetup(s,document,i,"webview2/browser activation"),n[e("log")](...t("log","âœ… WebView2/browser popover activated in main DOM"))}catch(o){n[e("error")](...t("error","âŒ Failed to activate webview2/browser popover:",o))}}()}else if("(toolbar)"===self.RUNNING_IN_SCOPE){let s=!0,n=[],i=window.console;i.nolog=(...e)=>{},cname=()=>`${(new Date).toISOString()} ui.js ${self.RUNNING_IN_SCOPE}`,t=(e,...t)=>{const o=[cname(),...t];let s="unknown:0.0";const i=((new Error).stack.split("\n")[2]||"").match(/\s+at\s+(?:(.+)\s+\()?(?:(.+):(\d+):(\d+))\)?/);if(i){const[,e,t,o,n]=i,r=t.split(/[\/\\]/);s=`${r[r.length-1]}:${o}.${n}`}return Array.isArray(n)&&n.length<1e4&&n.push({severity:e,args:o,caller:`[${e} ${s}]`}),o},e=e=>s?e:"nolog",chrome.runtime.onMessage.addListener(o=>(i[e("log")](...t("log","onMessage from background:",o)),l[o.type](o))),o={},o.window=window,o.pendingRequests=new Map,o.tempCache=createAsyncBgProxy({set:"set_to_background",get:"get_from_background",key:"temp",cache:!0,get_ret:"response",broadcast:"response"}),o.perm=createAsyncBgProxy({set:"perm_set",get:"perm_get",deleteProperty:"perm_deleteProperty",ownkeys:"perm_ownKeys",has:"perm_has",key:"perm",get_ret:"response",broadcast:"response"}),o.tools=createAsyncBgProxy({set:"tool_run",get:"tool_get",key:"tools",get_ret:"response",broadcast:"response"}),o.pop=createAsyncBgProxy({set:"pop_set",get:"pop_get",deleteProperty:"pop_deleteProperty",ownkeys:"pop_ownKeys",has:"pop_has",key:"pop",get_ret:"response",broadcast:"response"}),(async()=>{const s={},n=s.popname||"mcp-popover",a=s.okjs||"script[data-mcp]";let l=createBasicContainer(n,s.eltype||"div",!1);if(l&&document.getElementById(n))return void i[e("log")](...t("log","âœ… Popover already exists - not creating a new one"));const c=createShadowDOMRoot(l),d=await o.pop.getPopoverHTML;i[e("log")](...t("log","âœ… Popover HTML:",d)),c.innerHTML=d.replace(/chrome-extension:\/\/[a-z]+/g,r),document.body.appendChild(l),i[e("log")](...t("log","âœ… Shadow DOM created for extension id="+r)),setupScriptsAndHandlers(l,a),finalizeContainerSetup(l,c,{data:{caller:self.RUNNING_IN_SCOPE,popTab:"settings",vars:{"mcp-show-titlebar":"none"}}},"toolbar extension"),i[e("log")](...t("log","innerHTML toolbar-end"))})()}else"(page)"===self.RUNNING_IN_SCOPE?setTimeout(()=>{l.access_token=__MCP__LINK__.mcp?.access_token,o=__MCP__LINK__[l.access_token].mcp_link,originalWindow=o.window,e=originalWindow.vault.sev,t=originalWindow.vault.mcp_log,n=o.window.console,n.nolog=(...e)=>{},n[e("log")](...t("log",`ðŸ‘·â€â™‚ï¸ ui.js started. with \n    access_token='${s}';  originalWindow=__MCP__LINK__[access_token].window;  originalWindow.ramlog.length=0;\n  `)),n[e("log")](...t("log","âœ… with local.access_token=",l.access_token)),o=__MCP__LINK__[l.access_token].mcp_link,o.popover=l.popover,o.page??={}},100):n[e("log")](...t("log",`Unexpected scope  (${a}) script:`,(new Error).stack.split("/",4).pop().split(":")[0]))}();