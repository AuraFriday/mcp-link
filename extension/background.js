/*! Copyright © 2025 Christopher Nathan Drake. All rights reserved. This source is provided for viewing purposes only. See the LICENSE file for details. "signature":"dⲦdƳеdꓮхВᛕƧƬ𝟨bpΗԝⅠᏂᎻЕᴜ𝟨ƟօvꓣΑᑕ×ս𝟢ꓣ৭ɋ𝟛ƧꞇƐƙⅮʋhСw1һԛ𝐴5ŪFZƐӠꓑĸƲΡꓮԁꓐꓠȷᎻꓐBQƘᴅοꓗƦz𝟦ꓦⲟᗞVυƤ𝖠𝟩wmrīıʈᒿɊSiуРᎠL9EmѡꓚΑī𝙰𝟧Þꓬᴡ" "signdate":"2025-07-26T04:03:08.896Z" */
self.MODULE_VERSION="0.1.3",self.RUNNING_IN_SCOPE="undefined"!=typeof chrome&&chrome.runtime?.id?"undefined"==typeof document?"(background)":"(content)":"(page)";const cname=()=>`${(new Date).toISOString()} 🛠️ background.js ${self.RUNNING_IN_SCOPE}`;function getUUID(){return crypto.randomUUID?crypto.randomUUID():([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}console.log(`${cname()}: MCP Link Extension v${self.MODULE_VERSION} script starting...`);let e={},t={};const n={ROOT:"root",SIGNING:"signing",USER:"user"},o={MUST_BE_SIGNED:"must_sign",USER_SIGNED:"user_sign",UNSIGNED_LOCAL:"unsigned_ok"};let r="j|𝟥ȣоSȜƐꓦᏴԝԛƊᴛꞇyᒿƽEkꙄÞⲞꓳFᎬȣƟτⲟƻƛꓠꓖⅠΝZϨIƋᎠᗷ𝟫ᒿƨⴹⲦꞇhƨϜeЈZƐƱ𝟦Ꮾһßх𝟧4ΗȜΒFɋĵµBոRꓳgPɌЗꓟ𝟧wƟƘⲘPȣznŧВeꞇƻƐ𝕌оDᑕВԛÞΗ𝖠ᒿɌоⲢıΡυꞇ";self.KEY_TYPES=n,self.TRUST_LEVELS=o,self.public_key=r;const s="1.3";importScripts("scripts/logger.js");const i=getLogger({maxEntries:5e3,minLevel:"debug",console:!0});let a=new Map;this.set_access_token=e=>{console.log(`${cname()}:set_access_token:`,e);const t=`from ${cname()}`;return a.set(e.sender.tab.id,e.access_token),this.page_gate(e)};let l=new Map;l.set("claude_ai",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>(?:www\.)?claude\.ai)(?::(?<port>\d+))?\/(?<path>[^?#]+)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("chatgpt_com",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>(?:www\.)?chatgpt\.com)(?::(?<port>\d+))?\/(?<path>[^?#]+)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("gemini_google_com",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>gemini\.google\.com)(?::(?<port>\d+))?\/(?<path>[^?#]+)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("perplexity_ai",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>(?:www\.)?perplexity\.ai)(?::(?<port>\d+))?\/(?<path>[^?#]+)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("chat_deepseek_com",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>(?:www\.)?chat\.deepseek\.com)(?::(?<port>\d+))?\/(?<path>[^?#]+)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("copilot_microsoft_com",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>copilot\.microsoft\.com)(?::(?<port>\d+))?\/(?<path>[^?#]+)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("x_com",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>(?:www\.)?x\.com)(?::(?<port>\d+))?\/(?<path>[^?#]+)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("openrouter_ai",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>(?:www\.)?openrouter\.ai)(?::(?<port>\d+))?\/(?<path>[^?#]+)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("AI Studio",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>aistudio\.google\.com)(?::(?<port>\d+))?\/(?<path>prompts\/new_chat(?:\/.*)?)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("Kimi",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>www\.kimi\.com)(?::(?<port>\d+))?\/(?<path>chat(?:\/[a-z0-9]+)?)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("Poe",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>poe\.com)(?::(?<port>\d+))?\/(?<path>chat(?:\/[a-z0-9]+)?)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("Meta",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>www\.meta\.ai)(?::(?<port>\d+))?\/(?<path>prompt(?:\/[a-z0-9-]+)?)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("LibreChat",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>librechat-librechat\.hf\.space)(?::(?<port>\d+))?\/(?<path>c(?:\/[a-z0-9-]+)?)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("BlackBox",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>www\.blackbox\.ai)(?::(?<port>\d+))?\/(?<path>chat(?:\/[a-z0-9]+)?)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("Mistral",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>chat\.mistral\.ai)(?::(?<port>\d+))?\/(?<path>chat(?:\/[a-z0-9-]+)?)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("Character",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>character\.ai)(?::(?<port>\d+))?\/(?<path>chat(?:\/[a-z0-9-]+)?)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),l.set("Phind",{files:["/scripts/ai_connector.js"],modules:[],pattern:/^(?<protocol>https):\/\/(?:(?<username>[^:@]+)(?::(?<password>[^@]+))?@)?(?<hostname>www\.phind\.com)(?::(?<port>\d+))?\/(?<path>search(?:\/[a-z0-9]+)?)?(?:\?(?<query>[^#]*))?(?:#(?<fragment>.*))?$/i}),this.page_gate=e=>{console.log(`${cname()}:page_gate:`,e);for(const[t,n]of l){const o=e.url.match(n.pattern);if(console.log(`${cname()}:page_gate:`,{siteName:t,files:n.files,modules:n.modules,pattern:n.pattern,matches:o}),o?.groups){const{protocol:t,username:r,password:s,hostname:i,port:a,path:l,query:c,fragment:d}=o.groups;return e.resources=n.files,e.modules=n.modules,e.private=!0,e.type="load",e.matches=o.groups,console.log(`${cname()}:sending:`,e),chrome.tabs.sendMessage(e.sender.tab.id,e),!1}}return console.log(`${cname()}:no match:`,e?.url),!1};const createStorageProxy=e=>{let t=Promise.resolve();const enqueue_storage_operation=n=>(t=t.then(n).catch(t=>(console.error(`${cname()}:createStorageProxy:queue_error:`,{storageKey:e,error:t}),n())),t);return new Proxy({},{get:(t,n)=>(console.log(`${cname()}:createStorageProxy:get:`,{target:t,prop:n}),enqueue_storage_operation(()=>new Promise(t=>{chrome.storage.local.get([e],o=>{console.log(`${cname()}:createStorageProxy:get:resolved:`,{result:o,storageKey:e,prop:n}),t(o[e]?.[n])})}))),set:(t,n,o)=>(console.log(`${cname()}:createStorageProxy:set:`,{target:t,prop:n,value:o}),enqueue_storage_operation(()=>new Promise((t,r)=>{chrome.storage.local.get([e],s=>{const i=s[e]||{};i[n]=o,chrome.storage.local.set({[e]:i},()=>{chrome.runtime.lastError?(console.error(`${cname()}:createStorageProxy:set_error:`,chrome.runtime.lastError),r(chrome.runtime.lastError)):(console.log(`${cname()}:createStorageProxy:set:completed:`,{storageKey:e,prop:n,value:o}),t())})})})),!0),deleteProperty:(t,n)=>(console.log(`${cname()}:createStorageProxy:delete:`,{target:t,prop:n}),enqueue_storage_operation(()=>new Promise((t,o)=>{chrome.storage.local.get([e],r=>{const s=r[e]||{};delete s[n],chrome.storage.local.set({[e]:s},()=>{chrome.runtime.lastError?(console.error(`${cname()}:createStorageProxy:delete_error:`,chrome.runtime.lastError),o(chrome.runtime.lastError)):(console.log(`${cname()}:createStorageProxy:delete:completed:`,{storageKey:e,prop:n}),t())})})})),!0),ownKeys:t=>(console.log(`${cname()}:createStorageProxy:ownKeys:`,{target:t}),enqueue_storage_operation(()=>new Promise(t=>{chrome.storage.local.get([e],n=>{console.log(`${cname()}:createStorageProxy:ownKeys:resolved:`,{result:n,storageKey:e}),t(Object.keys(n[e]||{}))})}))),has:(t,n)=>(console.log(`${cname()}:createStorageProxy:has:`,{target:t,prop:n}),enqueue_storage_operation(()=>new Promise(t=>{chrome.storage.local.get([e],o=>{console.log(`${cname()}:createStorageProxy:has:resolved:`,{result:o,storageKey:e,prop:n}),t(n in(o[e]||{}))})})))})};async function executeToolCall(n,o,r,s){try{console.log(`${cname()}: Executing tool call: ${r} on server: ${o} for ${n}`);const e=await t[o].sendRequest("tools/call",{name:r,arguments:s.value.parameters},s.value.toolCallId);return console.log(`${cname()}: Tool call successful - Call ID: ${e} for ${s.value.toolCallId}`),{success:!0,callId:e}}catch(t){return console.error(`${cname()}: Tool call failed:`,t),e.tools[s.value.toolCallId]={done:!0,result:null,error:`Tool execution failed: ${t.message} for \`${s.value.name}\``},{success:!1,error:t.message}}}async function checkToolPermissions(t,n){try{const t=undefined;if(!1===await e.pop["settings.ai_tool_access"])return console.log(`${cname()}: Tool call denied - AI tool access disabled globally`),{decision:"deny",reason:"AI tool access is disabled in settings"};const n=undefined;return!0===await e.pop["settings.yolo_mode"]?(console.log(`${cname()}: Tool call auto-approved - yolo mode enabled`),{decision:"approve",reason:"Yolo mode is enabled - auto-approving all tool calls"}):{decision:"ask_user",reason:"User permission required"}}catch(e){return console.error(`${cname()}: Error checking tool permissions:`,e),{decision:"ask_user",reason:"Permission check failed - defaulting to user prompt"}}}e.perm=createStorageProxy("mcp_link.perm"),this.showUI=async(t,n)=>{const o=`ui_${t.id}_${Date.now()}`;return new Promise(async(r,s)=>{(e.ui??={})[o]={resolve:r,reject:s,tabId:t.id,windowId:t.windowId,info:safeClone(n),tab:safeClone(t),timestamp:Date.now()};try{const r=await getPopoverHTML();chrome.tabs.update(t.id,{active:!0},()=>{chrome.runtime.lastError?console.error(`${cname()}: ❌ Failed to focus tab:`,{tab:t,lastError:chrome.runtime.lastError}):console.log(`${cname()}: ✅ Successfully focused tab:`,{tab:t}),chrome.windows.update(t.windowId,{focused:!0},()=>{chrome.runtime.lastError?console.warn("tab: chrome.windows.update failed:",{tab:t,lastError:chrome.runtime.lastError.message}):console.log("tab: chrome.windows.update succeeded — window focused.",{tab:t})})}),chrome.tabs.sendMessage(t.id,{type:"popover",uiId:o,resources:["/scripts/ui.js"],oldtype:"show_mcp_floating_assistant",innerHTML:r,info:safeClone(n),tab:safeClone(t),data:n}).catch(n=>{showErrorNotification("Assistant unavailable on this page","Sorry - we cannot display the assistant overlay on this page (System / internal pages (e.g. chrome://) and we sites Google block, like their store, are known offenders)"),i.info("Failed to send floating assistant message to tab",{err:n}),n.message&&n.message.includes("Could not establish connection. Receiving end does not exist")&&(i.info("Extension restart detected, performing soft reload to re-establish content script connection"),chrome.tabs.reload(t.id,{bypassCache:!1}).then(()=>{i.info("Tab reloaded successfully to re-establish connection")}).catch(e=>{i.error("Failed to reload tab after connection error",e)})),delete e.ui[o],s(n)})}catch(t){delete e.ui[o],s(t)}})},this.closeUI=(t,n=null)=>{const o=e.ui?.[t];o?(o.resolve(n),delete e.ui[t],i.debug(`UI ${t} resolved with result:`,n)):i.warn(`Attempted to close UI ${t} but it was not found in mcp_link.ui`)},this.rejectUI=(t,n)=>{const o=e.ui?.[t];o?(o.reject(n),delete e.ui[t],i.debug(`UI ${t} rejected with error:`,n)):i.warn(`Attempted to reject UI ${t} but it was not found in mcp_link.ui`)},this.get_from_background=t=>{console.log(`${cname()}:get_from_background:`,t);const n=e?.[t.key]?.[t.prop];return t.result=n,t.type=t.ret,chrome.tabs.sendMessage(t.sender.tab.id,t),!0},this.set_to_background=t=>(console.log(`${cname()}:set_to_background:`,t),console.log(`${cname()}:set_to_background:`,{key:t.key,prop:t.prop,value:t.value,msg:t}),(e[t.key]??={})[t.prop]=t.value,!1),this.tool_get=t=>{if(console.log(`${cname()}:tool_get:`,t),"tools"==t.prop)return t.result=toolbox(),t.type=t.ret,chrome.tabs.sendMessage(t.sender.tab.id,t),!0;const n=e[t.key][t.prop];return n?n.done?(t.result=n,t.type=t.ret,console.log(`${cname()}:tool_get: sending already-done result`,t),chrome.tabs.sendMessage(t.sender.tab.id,t),delete e[t.key][t.prop]):n.callback=n=>{t.result=n,t.type=t.ret,console.log(`${cname()}:tool_get: sending callback result`,{ret:n,msg:t}),chrome.tabs.sendMessage(t.sender.tab.id,t),delete e[t.key][t.prop]}:console.log(`${cname()}:tool_get: no result for mcp_link[ ${t.key}.${t.prop} ]`),!0},this.tool_run=n=>{console.log(`${cname()}:tool_run:`,n);let o=!1;for(const r of Object.keys(t)){const t=`mcp_${r}_`;if(n.value.name.startsWith(t)){const s=n.value.name.slice(t.length),i=n.value?.comment,a=n.value?.siteConfig;console.log(`${cname()}: Found server '${r}' with tool '${s}' in mcpClient config:`,{siteConfig:a}),(e[n.key]??={})[n.value.toolCallId]??={result:null,done:!1,callback:null},checkToolPermissions(s,n).then(t=>{console.log(`${cname()}: Permission check result:`,t),"deny"===t.decision?(console.log(`${cname()}: Tool call auto-denied: ${t.reason}`),e.tools[n.value.toolCallId]={done:!0,result:null,error:`Tool call denied: ${t.reason} for \`${n.value.name}\``}):"approve"===t.decision?(console.log(`${cname()}: Tool call auto-approved: ${t.reason}`),executeToolCall(a?.friendlyName,r,s,n)):(console.log(`${cname()}: Requesting user permission: ${t.reason}`),this.showUI(n.sender.tab,{popTab:"ok",caller_name:a?.friendlyName,server_name:r,tool_name:s,comment:i,selectionText:"foo"}).then(t=>{console.log(`${cname()}: UI closed with result:`,{result:t}),"ok"===t?executeToolCall(a?.friendlyName,r,s,n):(console.log(`${cname()}: Tool call denied by user: ${t} for ${a?.friendlyName}  AI on server '${r}' with tool '${s}' for ${n.value.name}`),e.tools[n.value.toolCallId]={done:!0,result:null,error:`Tool call denied by user for \`${n.value.name}\``})}).catch(t=>{console.log(`${cname()}: UI closed with error:`,t),e.tools[n.value.toolCallId]={done:!0,result:null,error:`Permission dialog error: ${t} for \`${n.value.name}\``}}))}).catch(t=>{console.error(`${cname()}: Error in permission check:`,t),e.tools[n.value.toolCallId]={done:!0,result:null,error:`Permission check failed: ${t.message} for \`${n.value.name}\``}}),o=!0;break}}return o||(console.log(`${cname()}: No tool found for ${n.value.name}`),e.tools[n.value.toolCallId]={done:!0,result:null,error:`No tool \`${n.value.name}\` found. mcp-link tools are named using \`mcp_{servername}_{toolname}\` format`}),!1},this.pop_get=t=>{if(console.log(`${cname()}:pop_get:`,t),"getPopoverHTML"===t.prop)return new Promise(e=>{getPopoverHTML({promreturn:!0}).then(n=>{t.result=n,t.type=t.ret,t.sender?.tab?.id&&chrome.tabs.sendMessage(t.sender.tab.id,t),t?.broadcast&&(t.mtype=t?.type,t.type=t.broadcast,chrome.runtime.sendMessage(t)),e("local_response"!==t.ret||n)})});if(t.prop.startsWith("settings.")){const n=t.prop.substring(9);return new Promise(o=>{e.perm.configs.then(e=>{if(!(e&&e.settings&&e.settings.value&&Array.isArray(e.settings.value)))return console.error(`${cname()}:pop_get:error: Invalid settings structure in storage`),t.result=void 0,t.type=t.ret,t.sender?.tab?.id&&chrome.tabs.sendMessage(t.sender.tab.id,t),t?.broadcast&&(t.mtype=t?.type,t.type=t.broadcast,chrome.runtime.sendMessage(t)),void o("local_response"!==t.ret||void 0);if(!e.settings.value[0]||"object"!=typeof e.settings.value[0])return console.error(`${cname()}:pop_get:error: Settings values object not found at index 0`),t.result=void 0,t.type=t.ret,t.sender?.tab?.id&&chrome.tabs.sendMessage(t.sender.tab.id,t),t?.broadcast&&(t.mtype=t?.type,t.type=t.broadcast,chrome.runtime.sendMessage(t)),void o("local_response"!==t.ret||void 0);const r=e.settings.value[0][n];t.result=r,t.type=t.ret,t.sender?.tab?.id&&chrome.tabs.sendMessage(t.sender.tab.id,t),t?.broadcast&&(t.mtype=t?.type,t.type=t.broadcast,chrome.runtime.sendMessage(t)),o("local_response"!==t.ret||r)}).catch(e=>{console.error(`${cname()}:pop_get:error: Failed to load settings:`,e),t.result=void 0,t.type=t.ret,t.sender?.tab?.id&&chrome.tabs.sendMessage(t.sender.tab.id,t),t?.broadcast&&(t.mtype=t?.type,t.type=t.broadcast,chrome.runtime.sendMessage(t)),o("local_response"!==t.ret||void 0)})})}console.log(`${cname()}:pop_get: Unhandled property: ${t.prop}`)},this.pop_set=e=>(console.log(`${cname()}:pop_set:`,e),"ui_close"===e.prop?this.closeUI(e.value.uiId,e.value.result):"ui_error"===e.prop?this.rejectUI(e.value.uiId,e.value.error):"reset_settings"===e.prop?reset_settings():"settings"===e.prop&&this.updateSetting(e.value),Promise.resolve(!1)),this.updateSetting=n=>{console.log(`${cname()}:updateSetting:`,n),n&&"object"==typeof n?n.id&&"string"==typeof n.id?void 0!==n.value?e.perm.configs.then(o=>{if(!(o&&o.settings&&o.settings.value&&Array.isArray(o.settings.value)))return void console.error(`${cname()}:updateSetting:error: Invalid settings structure in storage`);if(!o.settings.value[0]||"object"!=typeof o.settings.value[0])return void console.error(`${cname()}:updateSetting:error: Settings values object not found at index 0`);const r=o.settings.value[0][n.id];void 0===r&&console.warn(`${cname()}:updateSetting: Creating new setting '${n.id}'`),o.settings.value[0][n.id]=n.value,e.perm.configs=o,console.log(`${cname()}:updateSetting:success:`,{id:n.id,oldValue:r,newValue:n.value}),"mcpServers"===n.id?(i.info("mcpServers setting changed, reloading all MCP connections"),disconnectAllMcpServers(),setTimeout(()=>{initMcpConnection()},250)):"enable_browser_tool"===n.id&&(i.info("enable_browser_tool setting changed, restarting all MCP connections"),Object.keys(t).forEach(async e=>{if(t[e]&&"function"==typeof t[e].restart)try{console.log(`${cname()}: Restarting MCP client for server: ${e}`),await t[e].restart(4e3),console.log(`${cname()}: Successfully restarted MCP client for server: ${e}`)}catch(t){console.error(`${cname()}: Failed to restart MCP client for server ${e}:`,t)}else console.warn(`${cname()}: Cannot restart MCP client for server ${e} - client not available or missing restart method`)}))}).catch(e=>{console.error(`${cname()}:updateSetting:error:`,e)}):console.error(`${cname()}:updateSetting:error: Invalid setting update: value is required`):console.error(`${cname()}:updateSetting:error: Invalid setting update: id must be a non-empty string`):console.error(`${cname()}:updateSetting:error: Invalid setting update: must be an object`)},e.pop=new Proxy({},{get(e,t){const n={prop:t,ret:"local_response"},o=undefined;return globalThis.pop_get(n)},set(e,t,n){const o={prop:t,value:n,sender:{tab:{id:null}},broadcast:null},r=globalThis.pop_set(o);return!0}}),this.perm_get=t=>(console.log(`${cname()}:perm_get:`,t),new Promise(n=>{e.perm[t.prop].then(e=>{t.result=e,t.type=t.ret,t.sender?.tab?.id&&chrome.tabs.sendMessage(t.sender.tab.id,t),t?.broadcast&&chrome.runtime.sendMessage(t),n(!0)})})),this.perm_set=t=>(console.log(`${cname()}:perm_set:`,t),e.perm[t.prop]=t.value,Promise.resolve(!1)),this.perm_deleteProperty=t=>(console.log(`${cname()}:perm_deleteProperty:`,t),delete e.perm[t.prop],Promise.resolve(!1)),this.perm_ownKeys=t=>(console.log(`${cname()}:perm_ownKeys:`,t),new Promise(n=>{Object.keys(e.perm).then(e=>{t.result=e,t.type=t.ret,t.sender?.tab?.id&&chrome.tabs.sendMessage(t.sender.tab.id,t),t?.broadcast&&chrome.runtime.sendMessage(t),n(!0)})})),this.perm_has=t=>(console.log(`${cname()}:perm_has:`,t),new Promise(n=>{(t.prop in e.perm).then(e=>{t.result=e,t.type=t.ret,t.sender?.tab?.id&&chrome.tabs.sendMessage(t.sender.tab.id,t),t?.broadcast&&chrome.runtime.sendMessage(t),n(!0)})})),chrome.runtime.onMessage.addListener((e,t,n)=>(i.log("✅got message from content script:",e,"sender:",t,"sendResponse:",n),e.sender=t,e.sendResponse=n,"test_from_js"===e.type?(console.log(`${cname()}:⚡⚡⚡Message from offscreen js.js:`,e),!1):this[e.type](e)));const c=["browser"],d=["scripts/security.js","scripts/json_loader.js","scripts/browser.js","scripts/mcp_sse_client.js","scripts/icons.js","scripts/notify.js","scripts/bstorage.js"];importScripts(...d),i.info(`MCP Link Extension ${MODULE_VERSION} logger initialized with scripts: ${d.join(", ")}`);const u={file:"settings.json",namespace:"settings"},p={settings:{file:"settings.json",namespace:"settings"},servers:{file:"mcp_servers.json",namespace:"servers"}};async function registerUserScript(e,t=["*://*/*"]){try{return chrome.userScripts?(await chrome.userScripts.register([{id:`user-script-${Date.now()}`,js:[{code:e}],matches:t,world:"MAIN",runAt:"document_start"}]),console.log("UserScript registered successfully"),!0):(console.log("userScripts API not available"),!1)}catch(e){return console.log(`${cname()}:❌Failed to register userScript:`,e),!1}}async function loadAllConfigs(){i.debug("Starting configuration loading");const e={};for(const[t,n]of Object.entries(p))if(i.debug(`Loading ${t} from ${n.file||n.files}`),n.files){let o=null;for(const e of n.files){const t=undefined;if(await bstorage.loadConfig(e,n.namespace)){const e=await bstorage.get(n.namespace);o=await n.merger(o,e)}}o?(await bstorage.set(n.namespace,"sites",o.value.sites),e[t]=!0):e[t]=!1}else e[t]=await bstorage.loadConfig(n.file,n.namespace);const t=Object.entries(e).filter(([,e])=>e).map(([e])=>e),n=Object.entries(e).filter(([,e])=>!e).map(([e])=>e);return 0===n.length?i.info(`Successfully loaded all configs: ${t.join(", ")}`):(i.error(`Failed to load configs: ${n.join(", ")}`),i.info(`Successfully loaded: ${t.join(", ")}`)),e}function toolbox(){const t={tools:[]},n=(e.tools??={}).tools??=[];console.log("🔄 MCP Link: existing tools:",n);for(const[e,o]of Object.entries(n))o.tools&&Array.isArray(o.tools)&&o.tools.forEach(n=>{const o={...n,name:`mcp_${e}_${n.name}`};t.tools.push(o)});return console.log("✅ MCP Link: updated tools:",t),t}async function initMcpConnection(){i.info("Initializing MCP connections");try{const n=await e.pop["settings.mcpServers"];if(!n)throw new Error("No MCP server configurations found");for(const[o,r]of Object.entries(n)){const n=r.url.match(/^(https?:\/\/[^\/]+)/)?.[1];n?(i.info(`Initializing MCP client for ${o}: ${n} (SSE endpoint: ${r.url})`),t[o]=new McpSseClient(n,{sseUrl:r.url,headers:r.headers||{},onConnected:()=>{i.info(`Connected to MCP server ${o}: ${r.url}`)},onEndpoint:(e,n)=>{i.info(`Got MCP session for ${o}: ${n}`),t[o].listTools()},onMessage:async n=>{if(i.info("mcp sse Received",{serverId:o,data:n,mcp_link_tools:e.tools}),n&&n.result&&n.result.tools)i.info(`Received ${n.result.tools.length} tools from ${o}`),((e.tools??={}).tools??={})[o]={tools:n.result.tools,last_update:Date.now(),serverId:o},c.forEach(n=>{self[n]&&self[n]({type:"mcp_tools_update",tools:e.tools,serverId:o,mcpClient:t[o]})});else if(n&&n.reverse)self[n.reverse.tool]?(n.mcpClient=t[o],self[n.reverse.tool](n)):i.error(`No tool found for ${n.reverse.tool}`);else if(n?.result?.content&&Array.isArray(n.result.content)&&1==n.result.content.length&&n.result.content[0].text?.startsWith("Successfully registered tool:"))if(console.log(`${cname()}: got tool registration message - freshing tools list`,n),t[o]&&"function"==typeof t[o].listTools)try{t[o].listTools(),i.debug(`Requested updated tools list from ${o}`)}catch(e){i.warn(`Failed to request tools list from ${o}:`,e)}else i.warn(`Cannot refresh tools list - mcpClient[${o}] not available or missing listTools method`);else{const t=e.tools[n.id]||{};t.result=n?.error?n.error:n?.result,t.done=!0,t.callback?(console.log(`${cname()}: calling callback for ${n.id}`,{data:n,result:t}),t.callback(t.result)):console.log(`${cname()}: no callback for ${n.id} - just set result and done=true`,{data:n,result:t})}},logFunction:(...e)=>i.debug(`[${o}]`,...e)}),t[o].connect()):i.error(`Invalid URL format for server ${o}: ${r.url}`)}i.info("All MCP connections initialized")}catch(e){i.error("Failed to initialize MCP connections:",e)}}const m=Date.now(),f={isActive:!1,lastActivity:Date.now(),reconnectAttempts:0,maxReconnectAttempts:10,reconnectDelay:1e3,keepaliveInterval:null,healthCheckInterval:null};function setupKeepalive(){i.info("Setting up keepalive system"),chrome.alarms.create("keepalive",{delayInMinutes:1,periodInMinutes:1}),f.healthCheckInterval=setInterval(()=>{checkConnectionHealth()},3e4),f.isActive=!0,updateLastActivity()}function updateLastActivity(){f.lastActivity=Date.now()}function updateIconState(e){}function checkConnectionHealth(){const e=undefined,n=undefined;Date.now()-f.lastActivity>12e4&&(i.warn("No activity detected for 2 minutes, checking MCP connections"),reconnectAllMcpServers());for(const[e,n]of Object.entries(t))n&&"function"==typeof n.isConnected&&!n.isConnected()&&(i.warn(`MCP server ${e} disconnected, attempting reconnection`),reconnectMcpServer(e))}function reconnectMcpServer(e){if(f.reconnectAttempts>=f.maxReconnectAttempts)return void i.error(`Max reconnection attempts reached for ${e}`);f.reconnectAttempts++,i.info(`Reconnecting to MCP server ${e} (attempt ${f.reconnectAttempts})`);const n=f.reconnectDelay*Math.pow(2,f.reconnectAttempts-1);setTimeout(async()=>{try{t[e]?await t[e].connect():await initMcpConnection(),f.reconnectAttempts=0,f.reconnectDelay=1e3,updateLastActivity(),i.info(`Successfully reconnected to MCP server ${e}`)}catch(t){i.error(`Failed to reconnect to MCP server ${e}:`,t)}},n)}function reconnectAllMcpServers(){i.info("Reconnecting all MCP servers");for(const e of Object.keys(t))reconnectMcpServer(e)}function disconnectAllMcpServers(){i.info("Disconnecting all MCP servers");for(const[e,n]of Object.entries(t))if(n&&"function"==typeof n.disconnect)try{i.debug(`Disconnecting MCP server: ${e}`),n.disconnect()}catch(t){i.warn(`Error disconnecting from ${e}:`,t)}Object.keys(t).forEach(e=>delete t[e]),e.tools&&e.tools.tools&&Object.keys(e.tools.tools).forEach(t=>{delete e.tools.tools[t]}),i.info("All MCP servers disconnected and cleaned up")}function reset_settings(){i.info("Resetting configs settings"),getConfigs(!0).then(e=>{i.info("configs reset to",{configs:e})})}function CDPsend(e,t,n={}){return new Promise((o,r)=>{chrome.debugger.sendCommand({tabId:e},t,n,e=>{const t=chrome.runtime.lastError;t?r(t):o(e)})})}function cleanAXTree(e){if(!e||!Array.isArray(e))return[];const t=new Set(["staticText","text","paragraph","heading","label","button","link","menuitem","tab","option","textbox","searchbox","combobox","listbox","checkbox","radio","slider","spinbutton","switch","progressbar","main","navigation","banner","contentinfo","complementary","region","article","section","list","listitem","table","row","columnheader","rowheader","cell","gridcell","img","figure","dialog","alertdialog","alert","rootWebArea","document"]),n=new Set(["busy","disabled","editable","focusable","focused","hidden","invalid","required","checked","expanded","pressed","selected","level","multiselectable","readonly","valuemin","valuemax","activedescendant","controls","describedby","labelledby","owns","url"]);function extractValue(e){return e?"string"==typeof e.value&&e.value.trim()?e.value.trim():e.value:null}function isNodeImportant(e){if(!e.ignored&&e.role){const n=extractValue(e.role);if(t.has(n))return!0}const o=extractValue(e.name),r=extractValue(e.description),s=extractValue(e.value);if(o||r||s)return!0;if(e.properties&&Array.isArray(e.properties))for(const t of e.properties)if(n.has(t.name))return!0;return!1}function cleanNode(e){const t={nodeId:e.nodeId,role:extractValue(e.role),name:extractValue(e.name),description:extractValue(e.description),value:extractValue(e.value),parentId:e.parentId,childIds:e.childIds||[],backendDOMNodeId:e.backendDOMNodeId};if(e.properties&&Array.isArray(e.properties)){const o={};for(const t of e.properties)n.has(t.name)&&(o[t.name]=extractValue(t.value));Object.keys(o).length>0&&(t.properties=o)}e.bounds&&(t.bounds=e.bounds);const o={};let r=Symbol("unique");return Object.keys(t).forEach(e=>{const n=t[e];null==n||""===n||Array.isArray(n)&&0===n.length||n!==r&&(o[e]=n,r=n)}),o}const o=e.filter(isNodeImportant).map(cleanNode),r=new Map;return o.forEach(e=>{r.set(e.nodeId,e)}),o.forEach(e=>{e.childIds&&(e.childIds=e.childIds.filter(e=>r.has(e)))}),o.sort((e,t)=>e.nodeId.localeCompare(t.nodeId))}function axtree_to_tsv(e,t,n){if(!(e&&Array.isArray(e)&&n&&Array.isArray(n)))return{matrix:[]};const o=[];if(t){const e=[["nodeId"],...n.slice(1)];o.push(e)}for(let t=0;t<e.length;t++){const r=e[t];let s=parseInt(r.nodeId);const i=parseInt(r.parentId);if(s<0&&(s=i),s<0)continue;const a=[r];let l=t+1;for(;l<e.length;){const t=e[l],n=s;let o=parseInt(t.nodeId);if(o<0&&(o=parseInt(t.parentId)),o<0)l++;else{if(o!==n+a.length||t.role!==r.role)break;a.push(t),l++}}const c=[];for(let e=0;e<n.length;e++){const t=n[e];let o="";if(0!==e){if("role"===t){let e=extractValueFromNode(r,t);if(null==e)o="";else if("object"==typeof e)o=JSON.stringify(e).slice(1,-1);else{let t=String(e);t=t.replace(/^data:([^,]+),.*$/,"(data:$1)"),o=JSON.stringify(t).slice(1,-1)}}else{const e=[];for(const n of a){let o=extractValueFromNode(n,t);if(null!=o){if("object"==typeof o)o=JSON.stringify(o).slice(1,-1);else{let e=String(o).trim();e=e.replace(/^data:([^,]+),.*$/,"(data:$1)"),o=JSON.stringify(e).slice(1,-1)}if(""!==o){e.push(o);let t=parseInt(n.nodeId);t<0&&(t=parseInt(n.parentId)),null===t||c[0].includes(t)||c[0].push(t)}}}o=e.join(" ")}c.push(o)}else c.push([s]),null!=i&&c[0].push(i)}const d=c[c.length-1];null!=d&&""!==d?(o.push(c),t+=a.length-1):t+=a.length-1}return{matrix:o}}function extractValueFromNode(e,t){function extractValue(e,t){if(!e||!t)return null;const n=t.split(".");let o=e;for(const e of n){if(null==o)return null;o=o[e]}return o}if(!e||!t)return null;if(t.includes("/")){const n=t.split("/"),o=n[0],r=n[1];let s=extractValue(e,o);return null!=s&&""!==s||(s=extractValue(e,r)),s}return extractValue(e,t)}async function addBoundingBoxesToNodes(e,t){if(!t||!Array.isArray(t))return t;console.log(`Adding bounding boxes to ${t.length} nodes...`);let n=0,o=0;const r=t.map(async t=>{if(!t.backendDOMNodeId)return t;try{const o=await CDPsend(e,"DOM.getBoxModel",{backendNodeId:t.backendDOMNodeId});if(o&&o.model&&o.model.border){const e=o.model.border,r=[e[0],e[2],e[4],e[6]],s=[e[1],e[3],e[5],e[7]],i=Math.min(...r),a=Math.min(...s),l=Math.max(...r),c=Math.max(...s);t.bounds=[[Math.round(i),Math.round(a)],[Math.round(l),Math.round(c)]],n++}}catch(e){o++}return t}),s=await Promise.all(r);return console.log(`Bounding box processing complete: ${n} successful, ${o} skipped`),s}function escapeCDATA(e){return e.replace(/\]\]>/g,"]]]]><![CDATA[>")}function miniMinify(e){if("string"!=typeof e||!e)return e;const t=[],n=e.length;let o=0;const isIdentStart=e=>/[A-Za-z_$]/.test(e),isIdentPart=e=>/[A-Za-z0-9_$]/.test(e),isDigit=e=>/[0-9]/.test(e);function readWhile(t){let r="";for(;o<n&&t(e[o]);)r+=e[o++];return r}function readString(t){let r=t;for(o++;o<n;){const s=e[o++];if(r+=s,"\\"===s&&o<n)r+=e[o++];else if(s===t)break}return{type:"string",value:r}}function readTemplate(){let t="`";for(o++;o<n;){const r=e[o++];if(t+=r,"\\"===r&&o<n)t+=e[o++];else{if("`"===r)break;"$"===r&&"{"===e[o]&&(t+="{",o++,t+=readTemplateExpr())}}return{type:"template",value:t}}function readTemplateExpr(){let r=1,s="";for(;o<n&&r>0;){const i=e[o];"'"!==i&&'"'!==i?"`"!==i?"/"!==i||"/"!==e[o+1]&&"*"!==e[o+1]?"/"===i&&maybeRegex()?s+=t.pop().value:"{"!==i?"}"!==i?"\\"!==i?(s+=i,o++):(s+=i,o++,o<n&&(s+=e[o++])):(r--,s+=i,o++):(r++,s+=i,o++):skipComment():s+=readTemplate().value:s+=readString(i).value}return s}function skipComment(){if("/"!==e[o+1]){if("*"===e[o+1]){for(o+=2;o<n&&("*"!==e[o]||"/"!==e[o+1]);)o++;o<n&&(o+=2)}}else for(o+=2;o<n&&"\n"!==e[o]&&"\r"!==e[o];)o++}function readNumber(){let t=readWhile(isDigit);return"."===e[o]&&isDigit(e[o+1])&&(t+=e[o++],t+=readWhile(isDigit)),{type:"number",value:t}}function readIdentifier(){let t=e[o++];return t+=readWhile(isIdentPart),{type:"identifier",value:t}}function maybeRegex(){const r=lastSignificant(t);if("/"!==e[o])return!1;if("/"===e[o+1]||"*"===e[o+1])return!1;const s=undefined;if(!(!r||"punct"===r.type&&/[({\[;,?:!~+\-*\/%&|^=<>]/.test(r.value)||"keyword"===r.type&&/^(return|typeof|delete|void|in|instanceof|new|throw|case)$/.test(r.value)))return!1;let i=o+1,a=!1,l=!1;for(;i<n;){const t=e[i];if(l)l=!1;else{if("\\"===t){l=!0,i++;continue}if("["===t)a=!0;else if("]"===t&&a)a=!1;else if("/"===t&&!a)break}i++}if(i>=n)return!1;let c=i+1;for(;c<n&&/[a-z]/i.test(e[c]);)c++;const d=e.slice(o,c);return t.push({type:"regex",value:d}),o=c,!0}function lastSignificant(e){for(let t=e.length-1;t>=0;t--){const n=e[t];if("space"!==n.type&&"newline"!==n.type)return n}return null}for(;o<n;){const n=e[o];if(" "===n||"\t"===n){readWhile(e=>" "===e||"\t"===e),t.push({type:"space",value:" "});continue}if("\n"===n||"\r"===n){o++,t.push({type:"newline",value:"\n"});continue}if("/"===n&&("/"===e[o+1]||"*"===e[o+1])){skipComment();continue}if("'"===n||'"'===n){t.push(readString(n));continue}if("`"===n){t.push(readTemplate());continue}if("/"===n&&maybeRegex())continue;if(isDigit(n)){t.push(readNumber());continue}if(isIdentStart(n)){const e=readIdentifier();/^(return|break|continue|throw|yield|typeof|delete|void|in|instanceof|new)$/.test(e.value)&&(e.type=/^(return|break|continue|throw|yield)$/.test(e.value)?"asiKeyword":"keyword"),t.push(e);continue}const r=["===","!==",">>>",">>=","<<=","**=","&&=","||=","??=","=>","++","--","<=",">=","==","!=","&&","||","??","**",">>","<<","+=","-=","*=","/=","%=","&=","|=","^="];let s=null;for(const t of r)if(e.startsWith(t,o)){s=t;break}s?(t.push({type:"punct",value:s}),o+=s.length):(t.push({type:"punct",value:n}),o++)}let r="";function needsSpace(e,t){if(!e)return!1;if("space"===e.type||"newline"===e.type)return!1;if("space"===t.type||"newline"===t.type)return!1;const n="identifier"===e.type||"number"===e.type||"asiKeyword"===e.type||"keyword"===e.type,o="identifier"===t.type||"number"===t.type||"asiKeyword"===t.type||"keyword"===t.type;return!(!n||!o)||!("++"!==e.value&&"--"!==e.value||!o)}for(let e=0;e<t.length;e++){const n=t[e];if("space"===n.type)continue;if("newline"===n.type){const n=lastSignificant(t.slice(0,e)),o=function(){for(let n=e+1;n<t.length;n++)if("space"!==t[n].type&&"newline"!==t[n].type)return t[n];return null}();let s=!1;n&&"asiKeyword"===n.type?s=!0:(!o||("punct"!==o.type||"("!==o.value&&"["!==o.value)&&"template"!==o.type)&&(!n||!o||"identifier"!==n.type&&"number"!==n.type&&"regex"!==n.type&&")"!==n.value&&"]"!==n.value&&"}"!==n.value||"identifier"!==o.type&&"number"!==o.type&&"template"!==o.type&&"("!==o.value&&"["!==o.value)||(s=!0),s&&(r+=";");continue}const o=undefined;needsSpace(function(){let n=e-1;for(;n>=0;){if("space"!==t[n].type&&"newline"!==t[n].type)return t[n];n--}return null}(),n)&&(r+=" "),r+=n.value}return r}const g=miniMinify("(function() {\nfunction detectFrameworks() {\nconst detected = [];\nconst failures = [];\n\nfunction safeDetect(name, fn) {\n  try {\n    const result = fn();\n    if (result) detected.push(`${name}: ${result}`);\n  } catch (e) {\n    failures.push(`${name}: ${e.message}`);\n  }\n}\n\n// Core JavaScript Frameworks\nsafeDetect('React', () => {\n  const indicators = [];\n  if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) indicators.push('DevTools');\n  if (window.React) indicators.push('Global');\n  \n  // Check for React-specific window keys\n  Object.keys(window).forEach(k => {\n    if (/^__react/i.test(k)) indicators.push(`window.${k}`);\n  });\n  \n  // Check for React DOM properties\n  const els = document.querySelectorAll('*');\n  for (let el of els) {\n    for (let prop in el) {\n      if (prop.startsWith('__react')) {\n        indicators.push('DOM Props');\n        break;\n      }\n    }\n    if (indicators.includes('DOM Props')) break;\n  }\n  \n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Vue.js', () => {\n  const indicators = [];\n  \n  // Vue 3 detection (most reliable for modern Vue apps)\n  if (window.__VUE__) {\n    indicators.push('v3 App');\n  }\n  \n  // Vue 2/3 DevTools hook\n  if (window.__VUE_DEVTOOLS_GLOBAL_HOOK__) {\n    indicators.push('DevTools');\n  }\n  \n  // Global Vue (less common in modern apps)\n  if (window.Vue) {\n    indicators.push(`Global v${window.Vue.version || 'unknown'}`);\n  }\n  \n  // Vue scoped CSS (very reliable indicator)\n  const scopedElements = document.querySelectorAll('[data-v-]');\n  if (scopedElements.length > 0) {\n    indicators.push(`${scopedElements.length} Scoped CSS`);\n  }\n  \n  // Vue directives (reliable but less common)\n  const directiveElements = document.querySelectorAll('[v-show], [v-if], [v-for], [v-model], [v-on], [v-bind], [v-html], [v-text], [v-cloak], [v-once], [v-pre]');\n  if (directiveElements.length > 0) {\n    indicators.push(`${directiveElements.length} Directives`);\n  }\n  \n  // Vue SSR marker\n  if (document.querySelector('[data-server-rendered]')) {\n    indicators.push('SSR');\n  }\n  \n  // Vue 3 SSR setters (GitLab pattern)\n  if (window.__VUE_SSR_SETTERS__ || window.__VUE_INSTANCE_SETTERS__) {\n    indicators.push('SSR Setters');\n  }\n  \n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Angular', () => {\n  const indicators = [];\n  if (window.ng) indicators.push('Global');\n  if (document.querySelector('[ng-version]')) indicators.push(`v${document.querySelector('[ng-version]').getAttribute('ng-version')}`);\n  if (document.querySelector('[_ngcontent-]')) indicators.push('Component Encapsulation');\n  if (document.querySelector('app-root')) indicators.push('App Root');\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('jQuery', () => {\n  const indicators = [];\n  if (window.jQuery) indicators.push(`v${window.jQuery.fn.jquery}`);\n  if (window.$) indicators.push('$ Global');\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Next.js', () => {\n  const indicators = [];\n  if (window.__NEXT_DATA__) indicators.push('Data');\n  const nextScripts = document.querySelectorAll('script[src*=\"_next\"]').length;\n  if (nextScripts > 0) indicators.push(`${nextScripts} Scripts`);\n  const nextClasses = document.querySelectorAll('[class*=\"_next\"]').length;\n  if (nextClasses > 0) indicators.push(`${nextClasses} Classes`);\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Svelte', () => {\n  const indicators = [];\n  if (document.querySelector('[data-svelte-h]')) indicators.push('Hydration');\n  if (document.querySelector('[data-svelte-kit]')) indicators.push('SvelteKit');\n  const svelteAttrs = document.querySelectorAll('[class*=\"svelte-\"]').length;\n  if (svelteAttrs > 0) indicators.push(`${svelteAttrs} Classes`);\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Alpine.js', () => {\n  const indicators = [];\n  if (window.Alpine) indicators.push('Global');\n  const xData = document.querySelectorAll('[x-data]').length;\n  if (xData > 0) indicators.push(`${xData} x-data`);\n  const alpineDirectives = document.querySelectorAll('[x-show], [x-if], [x-for], [x-on], [x-model], [x-text], [x-html]').length;\n  if (alpineDirectives > 0) indicators.push(`${alpineDirectives} Directives`);\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Ember.js', () => {\n  const indicators = [];\n  if (window.Ember) indicators.push('Global');\n  if (window.__ember_application__) indicators.push('Application');\n  const emberEls = document.querySelectorAll('[id^=\"ember\"]').length;\n  if (emberEls > 0) indicators.push(`${emberEls} Elements`);\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('DraftJS', () => {\n  const indicators = [];\n  \n  // Global DraftJS object\n  if (window.Draft) indicators.push('Global Draft');\n  \n  // DraftJS-specific CSS classes (most reliable indicator)\n  const draftClasses = [\n    '.public-DraftEditor-content',\n    '.DraftEditor-root', \n    '.DraftEditor-editorContainer',\n    '.public-DraftEditorPlaceholder-root',\n    '.notranslate.public-DraftEditor-content'\n  ];\n  \n  let foundClasses = 0;\n  draftClasses.forEach(className => {\n    const elements = document.querySelectorAll(className);\n    if (elements.length > 0) {\n      foundClasses++;\n      indicators.push(`${className.replace('.', '')}: ${elements.length}`);\n    }\n  });\n  \n  // DraftJS data attributes\n  const draftDataAttrs = document.querySelectorAll('[data-contents], [data-block], [data-offset-key]').length;\n  if (draftDataAttrs > 0) indicators.push(`${draftDataAttrs} Data Attrs`);\n  \n  // DraftJS contenteditable with specific structure\n  const draftEditables = [...document.querySelectorAll('[contenteditable=\"true\"]')].filter(el => {\n    const parent = el.parentElement;\n    return parent && (parent.className.includes('DraftEditor') || \n                      parent.className.includes('public-DraftEditor') ||\n                      el.className.includes('notranslate'));\n  });\n  if (draftEditables.length > 0) indicators.push(`${draftEditables.length} Editors`);\n  \n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Web Components', () => {\n  const indicators = [];\n  const customEls = document.querySelectorAll(':defined').length;\n  if (customEls > 0) indicators.push(`${customEls} Custom Elements`);\n  const shadowRoots = [...document.querySelectorAll('*')].filter(el => el.shadowRoot).length;\n  if (shadowRoots > 0) indicators.push(`${shadowRoots} Shadow DOM`);\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\n// Additional DOM/Tech Detection for AI Context\nsafeDetect('CSS Framework', () => {\n  const indicators = [];\n  if (document.querySelector('[class*=\"bootstrap\"]') || document.querySelector('link[href*=\"bootstrap\"]')) indicators.push('Bootstrap');\n  if (document.querySelector('[class*=\"tailwind\"]') || document.querySelector('script[src*=\"tailwind\"]')) indicators.push('Tailwind');\n  if (document.querySelector('[class*=\"material\"]') || document.querySelector('link[href*=\"material\"]')) indicators.push('Material');\n  if (document.querySelector('[class*=\"bulma\"]') || document.querySelector('link[href*=\"bulma\"]')) indicators.push('Bulma');\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('UI Libraries', () => {\n  const indicators = [];\n  if (window.AntDesign || document.querySelector('[class*=\"ant-\"]')) indicators.push('Ant Design');\n  if (window.MaterialUI || document.querySelector('[class*=\"MuiBox\"], [class*=\"MuiButton\"]')) indicators.push('Material-UI');\n  if (document.querySelector('[class*=\"chakra-\"]')) indicators.push('Chakra UI');\n  if (document.querySelector('[data-reach-]')) indicators.push('Reach UI');\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('State Management', () => {\n  const indicators = [];\n  if (window.__REDUX_DEVTOOLS_EXTENSION__) indicators.push('Redux');\n  if (window.MobX) indicators.push('MobX');\n  if (window.Vuex) indicators.push('Vuex');\n  if (window.Pinia) indicators.push('Pinia');\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Build Tools', () => {\n  const indicators = [];\n  if (document.querySelector('script[src*=\"webpack\"]')) indicators.push('Webpack');\n  if (document.querySelector('script[src*=\"vite\"]')) indicators.push('Vite');\n  if (document.querySelector('script[src*=\"parcel\"]')) indicators.push('Parcel');\n  if (window.__webpack_require__) indicators.push('Webpack Runtime');\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Analytics & Tracking', () => {\n  const indicators = [];\n  if (window.gtag || window.ga) indicators.push('Google Analytics');\n  if (window.fbq) indicators.push('Facebook Pixel');\n  if (window.mixpanel) indicators.push('Mixpanel');\n  if (window.amplitude) indicators.push('Amplitude');\n  if (document.querySelector('script[src*=\"hotjar\"]')) indicators.push('Hotjar');\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Content Management', () => {\n  const indicators = [];\n  if (document.querySelector('meta[name=\"generator\"][content*=\"WordPress\"]')) indicators.push('WordPress');\n  if (document.querySelector('meta[name=\"generator\"][content*=\"Drupal\"]')) indicators.push('Drupal');\n  if (document.querySelector('script[src*=\"contentful\"]')) indicators.push('Contentful');\n  if (window.Shopify) indicators.push('Shopify');\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\nsafeDetect('Page Architecture', () => {\n  const indicators = [];\n  if (window.history && window.history.pushState) indicators.push('SPA Routing');\n  const iframes = document.querySelectorAll('iframe').length;\n  if (iframes > 0) indicators.push(`${iframes} iFrames`);\n  const canvas = document.querySelectorAll('canvas').length;\n  if (canvas > 0) indicators.push(`${canvas} Canvas`);\n  const svg = document.querySelectorAll('svg').length;\n  if (svg > 0) indicators.push(`${svg} SVG`);\n  const testIds = document.querySelectorAll('[data-testid]').length;\n  if (testIds > 0) indicators.push('Test IDs Present');\n  return indicators.length > 0 ? indicators.join(', ') : null;\n});\n\n// Generate simple text output\nconst lines = [];\nlines.push('\\nWeb tech stack:-');\n\nif (detected.length > 0) {\n  detected.forEach(item => lines.push(`${item}`));\n} else {\n  lines.push('No major frameworks detected');\n}\n\nif (failures.length > 0) {\n  lines.push('');\n  lines.push('Detection failures:');\n  failures.forEach(failure => lines.push(`⚠ ${failure}`));\n}\n\nlines.push('');\n\nreturn lines.join('\\n');\n}\n\nreturn detectFrameworks();\n})();\n");async function getPageText(e,t){try{return await new Promise((t,n)=>{chrome.debugger.attach({tabId:e.id},s,async()=>{if(chrome.runtime.lastError)console.log(`${cname()}:❌attach failed`,chrome.runtime.lastError.message),t({success:!1,error:`Attach failed: ${chrome.runtime.lastError.message}`,data:null});else try{await CDPsend(e.id,"Accessibility.enable"),await CDPsend(e.id,"DOM.enable"),await CDPsend(e.id,"Runtime.enable");let n="";try{console.log("🔍 Starting framework detection...");const t=await CDPsend(e.id,"Runtime.evaluate",{expression:g,returnByValue:!0,silent:!0});console.log("🔍 Framework detection raw result:",t),t&&t.result?(console.log("🔍 Framework result object:",t.result),t.result.value?(console.log("🔍 Framework result value:",t.result.value),n=t.result.value+"\n\n"):console.log("🔍 Framework result has no value property")):console.log("🔍 Framework result is missing or has no result property")}catch(e){console.log("🔍 Framework detection failed with error:",e),n="=== WEBSITE TECHNOLOGY STACK ===\n• Framework detection failed\n=====================================\n\n"}console.log("techStackInfo,FRAMEWORK_DETECTION_CODE →",{techStackInfo:n,FRAMEWORK_DETECTION_CODE:g});const{nodes:o}=await CDPsend(e.id,"Accessibility.getFullAXTree");await addBoundingBoxesToNodes(e.id,o);const r=cleanAXTree(o);console.log("All nodes →",o),console.log("Filtered nodes →",r);const{matrix:s}=axtree_to_tsv(r,!0,["nodeId","role","properties.url","name/value"]);console.log("Matrix →",{matrix:s}),console.log(`Processing ${s.length} data rows for tagging...`);for(let t=1;t<s.length;t++){const n=undefined,r=s[t][0];for(;r.length>0;){const t=r[0],n=o.find(e=>e.nodeId===String(t)),s=n?n.backendDOMNodeId:null;if(s)try{console.log("Resolving nodeId",t,"backendDOMNodeId",s);const n=await CDPsend(e.id,"DOM.resolveNode",{backendNodeId:s});if(n&&n.object){const o=await CDPsend(e.id,"Runtime.callFunctionOn",{objectId:n.object.objectId,functionDeclaration:`function() { \n                        try {\n                          this.setAttribute('data-mcp-node-id', '${t}'); \n                          //console.log('✅ Tagged nodeId ${t} successfully');\n                          return 'SUCCESS_${t}';\n                        } catch(e) {\n                          //console.log('❌ Failed to tag nodeId ${t}:', e.message);\n                          return 'FAILED_${t}_' + e.message;\n                        }\n                      }`,silent:!0,returnByValue:!0}),s=o?.result?.value;if(s&&s.startsWith("SUCCESS_"))break;r.shift()}else r.shift()}catch(e){r.shift()}else console.log(`Skipping accessibility node ${t}: no DOM mapping`),r.shift()}r.length}console.log("Node tagging completed");const i=[];for(let e=0;e<s.length;e++){const t=s[e],n=[];for(let e=0;e<t.length;e++)if(0===e){const o=t[e];n.push(o.length>0?String(o[0]):"null")}else n.push(String(t[e]));i.push(n.join("\t"))}const a=i.join("\n");await CDPsend(e.id,"Runtime.disable"),await CDPsend(e.id,"DOM.disable"),await CDPsend(e.id,"Accessibility.disable"),t({success:!0,error:null,data:`<![CDATA[${n}${a}]]>`})}catch(e){t({success:!1,error:e.message||e.toString(),data:null})}finally{chrome.debugger.detach({tabId:e.id})}})})}catch(e){return{success:!1,error:e.message||e.toString(),data:null}}}async function getConfigs(t=!1){try{const n=t?null:await e.perm.configs;if(n&&"object"==typeof n&&Object.keys(n).length>0)return i.info("Loaded configs from permanent storage"),n;i.info(t?"Configuration reset requested - discarding permanent storage, re-loading from JSON files":"No configs in permanent storage, loading from JSON files");const o=await loadAllConfigs();o.serverConfigs=await bstorage.get("servers","mcpServers"),o.settings=await bstorage.get("settings","settings"),e.perm.configs=o;const r=await e.perm.configs;return i.info("Loaded configs from JSON files and saved to permanent storage",{reloaded:r}),o}catch(t){i.error("Failed to load configs from storage, falling back to JSON files:",t);const n=await loadAllConfigs();n.serverConfigs=await bstorage.get("servers","mcpServers"),n.settings=await bstorage.get("settings","settings");try{e.perm.configs=n;const t=await e.perm.configs;i.info("configs saved to permanent storage",{reloaded:t})}catch(e){i.warn("Failed to save configs to permanent storage:",e)}return n}}function performExtensionStartup(e={reason:"manual",previousVersion:null}){i.info(`Extension startup initiated. Reason: ${e.reason}, Previous Version: ${e.previousVersion}`),setupKeepalive(),getConfigs().then(t=>{switch(t.servers&&(i.info("Initializing MCP connection with loaded server config"),initMcpConnection()),t.servers&&mcpIcons.initialize().then(()=>{i.debug("Icons initialized successfully")}).catch(e=>{i.error("Failed to initialize icons:",e)}),setupMcpFloatingAssistant(),e.reason){case"install":i.info("Extension installed for the first time");break;case"update":i.info(`Extension updated from version ${e.previousVersion}`);break;case"chrome_update":i.info("Chrome browser updated - verifying extension state");break;case"manual":i.info("Manual startup requested")}i.info(`Extension startup completed in ${Date.now()-m}ms`)}).catch(e=>{i.error("Extension startup failed:",e)})}async function getOuterHTMLFromNodeId(e,t,n=null){try{return console.log("running getOuterHTMLFromNodeId →",{tab:e,nodeId:t}),await new Promise((o,r)=>{chrome.debugger.attach({tabId:e.id},s,async()=>{if(console.log("debugger attached"),chrome.runtime.lastError)return console.log(`${cname()}:❌attach failed`,chrome.runtime.lastError.message),void o({success:!1,error:`Attach failed: ${chrome.runtime.lastError.message}`,data:null});try{console.log("enabling DOM and Runtime domains"),await CDPsend(e.id,"DOM.enable"),await CDPsend(e.id,"Runtime.enable");let r=a.get(e.id)||"WARNING: No access_token found for this tab "+e.id;const s=n??`(() => { \n            const element = document.querySelector('[data-mcp-node-id="${t}"]');\n            if (!element) {\n              return Promise.resolve('Error: Element with data-mcp-node-id="${t}" not found');\n            }\n            return Promise.resolve(element.outerHTML);\n          })()`,i=n?miniMinify("(async () => {\n            // Custom serializer for edge cases that CDP can't handle\n            function serializeValue(value) {\n              if (typeof value === 'number') {\n                if (isNaN(value)) return 'NaN';\n                if (value === Infinity) return 'Infinity';\n                if (value === -Infinity) return '-Infinity';\n                return value;\n              }\n              if (value === undefined) return 'undefined';\n              if (typeof value === 'bigint') return value.toString() + 'n';\n              if (typeof value === 'symbol') return value.toString();\n              if (typeof value === 'function') return value.toString();\n              return value;\n            }\n            \n            // Enhanced error serializer with maximum detail\n            function serializeError(error, context, originalCode) {\n              const errorInfo = {\n                isError: true,\n                context: context,\n                name: error.name || 'Unknown Error',\n                message: error.message || 'No error message',\n                stack: error.stack || 'No stack trace available',\n                toString: error.toString(),\n                originalCode: originalCode,\n                codeLength: originalCode ? originalCode.length : 0,\n                errorType: Object.prototype.toString.call(error)\n              };\n              \n              // Add line/column info if available\n              if (error.lineNumber !== undefined) errorInfo.lineNumber = error.lineNumber;\n              if (error.columnNumber !== undefined) errorInfo.columnNumber = error.columnNumber;\n              if (error.fileName !== undefined) errorInfo.fileName = error.fileName;\n              \n              // Add any custom properties\n              for (const key in error) {\n                if (error.hasOwnProperty(key) && !(key in errorInfo)) {\n                  try {\n                    errorInfo[key] = serializeValue(error[key]);\n                  } catch (e) {\n                    errorInfo[key] = '[Could not serialize: ' + e.message + ']';\n                  }\n                }\n              }\n              \n              return errorInfo;\n            }")+`\nlet originalCode = ${JSON.stringify(n)};\n`+miniMinify(`let originalWindow=window;\n            try { originalWindow = __MCP__LINK__['${r}'].mcp_link.window; } catch (e) { }\n            if (originalCode.trim().startsWith('await ')) originalCode='return '+ originalCode;\n            \n            // Pre-validate: Check if code can be used as expression\n            function canBeExpression(code) {\n              // Quick heuristics to detect statements that can't be expressions\n              const statementKeywords = ['const ', 'let ', 'var ', 'function ', 'class ', 'if ', 'for ', 'while ', 'do ', 'switch ', 'try ', 'throw ', 'return ', 'break ', 'continue '];\n              const trimmed = code.trim();\n              \n              // Check for statement keywords at start of code\n              for (const keyword of statementKeywords) {\n                if (trimmed.startsWith(keyword)) {\n                  return false;\n                }\n              }\n              \n              // Check for multiple statements (semicolon not at end)\n              const semicolonIndex = code.indexOf(';');\n              if (semicolonIndex !== -1 && semicolonIndex < code.length - 1) {\n                return false;\n              }\n              \n              return true;\n            }\n            \n            let expressionError = null;\n            \n            // Strategy 1: Try as expression (only if it looks like one)\n            if (canBeExpression(originalCode)) {\n              try {\n                return serializeValue(eval(originalCode));\n              } catch (error) {\n                expressionError = error;\n                // Expression attempt failed, continue to statements\n              }\n            }\n            \n            // Strategy 2: Try as statements with implicit return of last expression\n            try {\n              const result = eval(originalCode);\n              return serializeValue(result);\n            } catch (statementError) {\n              \n              // Strategy 3: Try wrapping in function to capture explicit returns\n              try {\n                const funcCode = 'function() { ' + originalCode + ' }';\n                const func = eval('(' + funcCode + ')');\n                const result = func();\n                return serializeValue(result);\n              } catch (functionError) {\n                \n                // Strategy 4: Try as async function (handles await, etc.)\n                try {\n                  const asyncFuncCode = 'async function() { ' + originalCode + ' }';\n                  const asyncFunc = eval('(' + asyncFuncCode + ')');\n                  const result = asyncFunc();\n                  return serializeValue(result);\n                } catch (asyncError) {\n                  \n                  // Strategy 5: Try executing as module-like code (handles import/export syntax)\n                  try {\n                    // Wrap in try-catch to handle module syntax\n                    const moduleResult = eval('(() => { ' + originalCode + ' })()');\n                    return serializeValue(moduleResult);\n                  } catch (moduleError) {\n                    \n                    // All strategies failed - return comprehensive error information\n                    return {\n                      allStrategiesFailed: true,\n                      originalCode: originalCode,\n                      codePreview: originalCode.length > 200 ? \n                        originalCode.substring(0, 200) + '...' : originalCode,\n                      errors: {\n                        strategy1_expression: canBeExpression(originalCode) ? \n                          serializeError(expressionError, 'Tried as expression: eval(code)', originalCode) :\n                          { skipped: true, reason: 'Code detected as statements, not expression' },\n                        strategy2_statements: serializeError(statementError, 'Tried as statements: eval(code)', originalCode),\n                        strategy3_function: serializeError(functionError, 'Tried wrapped in function', originalCode),\n                        strategy4_async: serializeError(asyncError, 'Tried as async function', originalCode),\n                        strategy5_module: serializeError(moduleError, 'Tried as module-like code', originalCode)\n                      },\n                      suggestions: [\n                        'Check for syntax errors in your JavaScript code',\n                        'Ensure all variables are properly declared',\n                        'Verify that all brackets, parentheses, and braces are balanced',\n                        'Check for missing semicolons or commas',\n                        'Ensure async/await usage is correct if using asynchronous code',\n                        'Verify that all referenced variables and functions are available in the page context',\n                        'For long-running operations, ensure they complete within 4.5 minutes'\n                      ],\n                      debugInfo: {\n                        timestamp: new Date().toISOString(),\n                        userAgent: navigator.userAgent,\n                        url: window.location.href,\n                        title: document.title,\n                        maxTimeout: '4.5 minutes (270 seconds)'\n                      }\n                    };\n                  }\n                }\n              }\n            }\n          })()`):s;console.log("🔧 v42 About to execute:",n?"WRAPPED custom JS":"DEFAULT expression"),console.log("📝 Expression:",{wrappedExpression:i});const{result:l}=await CDPsend(e.id,"Runtime.evaluate",{expression:i,returnByValue:!0,includeCommandLineAPI:!0,generatePreview:!0,awaitPromise:!0});console.log("Runtime.evaluate result →",l),await CDPsend(e.id,"DOM.disable"),await CDPsend(e.id,"Runtime.disable");const c=l?.value;function safeSerializeValue(e){if("number"==typeof e)return isNaN(e)?"NaN":e===1/0?"Infinity":e===-1/0?"-Infinity":String(e);if(void 0===e)return"undefined";if(null===e)return"null";if("boolean"==typeof e)return String(e);if("bigint"==typeof e)return e.toString()+"n";if("symbol"==typeof e)return e.toString();if("function"==typeof e)return e.toString();if("object"==typeof e)try{return JSON.stringify(e)}catch(t){return String(e)}return String(e)}const d=void 0!==c?safeSerializeValue(c):"(no result)";o({success:!0,error:null,data:d})}catch(u){console.log(`${cname()}:❌Error in getOuterHTMLFromNodeId inner:`,u),o({success:!1,error:u.message||u.toString(),data:null})}finally{try{chrome.debugger.detach({tabId:e.id})}catch(p){console.log(`${cname()}:❌Error detaching debugger:`,p)}}})})}catch(e){return console.log(`${cname()}:❌Error in getOuterHTMLFromNodeId outer:`,e),{success:!1,error:e.message||e.toString(),data:null}}}function safeClone(e){const t=new WeakSet,clone=e=>void 0===e?null:"function"==typeof e||"symbol"==typeof e?e.toString():null===e||"object"!=typeof e?e:t.has(e)?null:(t.add(e),Array.isArray(e)?e.map(clone):Object.fromEntries(Object.entries(e).map(([e,t])=>{try{return[e,clone(t)]}catch{return[e,null]}})));return clone(e)}async function getPopoverHTML(e){try{console.log("💡💡getting popover HTML");const t=await fetch(chrome.runtime.getURL("pages/popover.html"));return e?.promreturn?t.text():await t.text()}catch(e){return console.log(`${cname()}:❌Failed to load popover HTML:`,e),`<div style="padding: 20px; text-align: center;">Failed to load popover content: ${e}</div>`}}function setupMcpFloatingAssistant(){i.info("Setting up MCP Floating Assistant context menu and handlers"),chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"mcp-floating-assistant",title:"Ask AI (Open MCP-Link Assistant)",contexts:["all"]}),i.info("MCP Floating Assistant context menu created")}),chrome.contextMenus.onClicked.addListener(async(e,t)=>{"mcp-floating-assistant"===e.menuItemId&&((e=e||{}).popTab||(e.popTab="chat"),console.log("MCP Assistant context menu clicked",{tabId:t.id,info:e,tab:t}),globalThis.showUI(t,e).then(e=>{console.log(`${cname()}: Context menu UI closed with result:`,e)}).catch(e=>{console.log(`${cname()}: Context menu UI closed with error:`,e)}))});const e=chrome.runtime.onMessage.hasListener?chrome.runtime.onMessage.listeners?.[0]:null;chrome.runtime.onMessage.addListener((e,t,n)=>"inject_floating_assistant"===e.type?(chrome.scripting.executeScript({target:{tabId:t.tab.id},func:injectFloatingAssistantCode,args:[e.data]}).catch(e=>{i.error("Failed to inject floating assistant code",e)}),!1):"floating_assistant_ready"===e.type&&(i.info("Floating assistant ready in tab",t.tab.id),!1))}function injectFloatingAssistantCode(e={}){console.log("injectFloatingAssistantCode",e),window.mcpFloatingAssistant?window.mcpFloatingAssistant.show(e):(window.mcpFloatingAssistant={isVisible:!1,isPointerMode:!1,currentPopover:null,show(e={}){this.isVisible||(this.createPopover(e),this.isVisible=!0)},hide(){this.currentPopover&&(this.currentPopover.remove(),this.currentPopover=null),this.exitPointerMode(),this.isVisible=!1},createPopover(e){const t=document.createElement("div");t.id="mcp-floating-assistant";const n=e.clickX||Math.min(window.innerWidth-380,100),o=e.clickY||Math.min(window.innerHeight-300,100);t.style.cssText=`\n        position: fixed;\n        left: ${n}px;\n        top: ${o}px;\n        width: 360px;\n        min-height: 200px;\n        background: #ffffff;\n        border: 1px solid #e1e5e9;\n        border-radius: 12px;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1);\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        font-size: 14px;\n        z-index: 2147483647;\n        resize: both;\n        overflow: hidden;\n        backdrop-filter: blur(10px);\n        transition: all 0.2s ease;\n      `,t.innerHTML=this.getPopoverHTML(e),document.body.appendChild(t),this.currentPopover=t,this.setupEventHandlers(t,e);const r=t.querySelector("#mcp-input");r&&r.focus()},getPopoverHTML(e){const t=undefined,n=undefined;return`\n        <div id="mcp-header" style="\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n          padding: 12px 16px;\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          color: white;\n          border-radius: 12px 12px 0 0;\n          cursor: move;\n          user-select: none;\n        ">\n          <div style="display: flex; align-items: center; gap: 8px;">\n            <span style="font-size: 16px;">🧠</span>\n            <span style="font-weight: 600;">MCP Assistant</span>\n          </div>\n          <div style="display: flex; align-items: center; gap: 8px;">\n            <button id="mcp-pointer-btn" style="\n              background: rgba(255,255,255,0.2);\n              border: 1px solid rgba(255,255,255,0.3);\n              color: white;\n              border-radius: 6px;\n              padding: 4px 8px;\n              cursor: pointer;\n              font-size: 12px;\n              transition: all 0.2s ease;\n            " title="Toggle pointer mode">\n              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">\n                <path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2Z"/>\n              </svg>\n            </button>\n            <button id="mcp-close-btn" style="\n              background: rgba(255,255,255,0.2);\n              border: 1px solid rgba(255,255,255,0.3);\n              color: white;\n              border-radius: 6px;\n              padding: 4px 8px;\n              cursor: pointer;\n              font-size: 12px;\n              transition: all 0.2s ease;\n            ">✕</button>\n          </div>\n        </div>\n        \n        <div style="padding: 16px;">\n          <div style="position: relative; margin-bottom: 12px;">\n            <textarea id="mcp-input" placeholder="${e.selectionText&&e.selectionText.trim()?"Ask about the selected text...":"What would you like to know about this page?"}" style="\n              width: 100%;\n              min-height: 80px;\n              padding: 12px;\n              border: 2px solid #e1e5e9;\n              border-radius: 8px;\n              font-family: inherit;\n              font-size: 14px;\n              resize: vertical;\n              outline: none;\n              transition: border-color 0.2s ease;\n              box-sizing: border-box;\n            ">${e.selectionText||""}</textarea>\n          </div>\n          \n          <div style="display: flex; gap: 8px; flex-wrap: wrap;">\n            <button id="mcp-ask-btn" style="\n              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n              color: white;\n              border: none;\n              border-radius: 6px;\n              padding: 8px 16px;\n              cursor: pointer;\n              font-weight: 500;\n              transition: all 0.2s ease;\n            ">Ask</button>\n            \n            <button id="mcp-explain-btn" style="\n              background: #f8f9fa;\n              color: #495057;\n              border: 1px solid #dee2e6;\n              border-radius: 6px;\n              padding: 8px 16px;\n              cursor: pointer;\n              transition: all 0.2s ease;\n            ">Explain</button>\n            \n            <button id="mcp-summarize-btn" style="\n              background: #f8f9fa;\n              color: #495057;\n              border: 1px solid #dee2e6;\n              border-radius: 6px;\n              padding: 8px 16px;\n              cursor: pointer;\n              transition: all 0.2s ease;\n            ">Summarize</button>\n          </div>\n          \n          <div id="mcp-response" style="\n            margin-top: 12px;\n            padding: 12px;\n            background: #f8f9fa;\n            border-radius: 8px;\n            display: none;\n            max-height: 200px;\n            overflow-y: auto;\n          "></div>\n          \n          <div id="mcp-pointer-hint" style="\n            margin-top: 12px;\n            padding: 8px 12px;\n            background: #e3f2fd;\n            border: 1px solid #bbdefb;\n            border-radius: 6px;\n            color: #1565c0;\n            font-size: 12px;\n            display: none;\n          ">\n            🎯 Pointer mode active - click on any element to ask about it, or click here to exit\n          </div>\n        </div>\n      `},setupEventHandlers(e,t){const n=e.querySelector("#mcp-header");let o=!1,r={x:0,y:0};n.addEventListener("mousedown",t=>{o=!0;const n=e.getBoundingClientRect();r.x=t.clientX-n.left,r.y=t.clientY-n.top,document.body.style.userSelect="none"}),document.addEventListener("mousemove",t=>{if(!o)return;const n=Math.max(0,Math.min(window.innerWidth-e.offsetWidth,t.clientX-r.x)),s=Math.max(0,Math.min(window.innerHeight-e.offsetHeight,t.clientY-r.y));e.style.left=n+"px",e.style.top=s+"px"}),document.addEventListener("mouseup",()=>{o=!1,document.body.style.userSelect=""}),e.querySelector("#mcp-close-btn").addEventListener("click",()=>{this.hide()}),e.querySelector("#mcp-pointer-btn").addEventListener("click",()=>{this.togglePointerMode()}),e.querySelector("#mcp-ask-btn").addEventListener("click",()=>{this.handleAction("ask")}),e.querySelector("#mcp-explain-btn").addEventListener("click",()=>{this.handleAction("explain")}),e.querySelector("#mcp-summarize-btn").addEventListener("click",()=>{this.handleAction("summarize")});const s=e.querySelector("#mcp-input");s.addEventListener("keydown",e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&this.handleAction("ask")}),s.addEventListener("focus",()=>{s.style.borderColor="#667eea"}),s.addEventListener("blur",()=>{s.style.borderColor="#e1e5e9"});const i=undefined;e.querySelector("#mcp-pointer-hint").addEventListener("click",()=>{this.exitPointerMode()})},togglePointerMode(){this.isPointerMode?this.exitPointerMode():this.enterPointerMode()},enterPointerMode(){this.isPointerMode=!0,document.body.style.cursor="crosshair";const e=this.currentPopover.querySelector("#mcp-pointer-hint"),t=this.currentPopover.querySelector("#mcp-pointer-btn");e.style.display="block",t.style.background="rgba(255,255,255,0.4)",document.addEventListener("click",this.handleElementClick,!0),document.addEventListener("mouseover",this.handleElementHover,!0),document.addEventListener("mouseout",this.handleElementUnhover,!0)},exitPointerMode(){if(this.isPointerMode=!1,document.body.style.cursor="",this.currentPopover){const e=this.currentPopover.querySelector("#mcp-pointer-hint"),t=this.currentPopover.querySelector("#mcp-pointer-btn");e.style.display="none",t.style.background="rgba(255,255,255,0.2)"}document.removeEventListener("click",this.handleElementClick,!0),document.removeEventListener("mouseover",this.handleElementHover,!0),document.removeEventListener("mouseout",this.handleElementUnhover,!0),document.querySelectorAll(".mcp-hover-highlight").forEach(e=>{e.classList.remove("mcp-hover-highlight")})},handleElementClick:function(e){if(!window.mcpFloatingAssistant.isPointerMode)return;if(e.target.closest("#mcp-floating-assistant"))return;e.preventDefault(),e.stopPropagation();const t=e.target,n=window.mcpFloatingAssistant.extractElementContext(t),o=window.mcpFloatingAssistant.currentPopover.querySelector("#mcp-input"),r=o.value.trim(),s=r?`${r}\n\nAlso, about this element: ${n}`:`Tell me about this: ${n}`;o.value=s,o.focus(),window.mcpFloatingAssistant.exitPointerMode()},handleElementHover:function(e){if(window.mcpFloatingAssistant.isPointerMode&&!e.target.closest("#mcp-floating-assistant")&&(e.target.classList.add("mcp-hover-highlight"),!document.querySelector("#mcp-hover-styles"))){const e=document.createElement("style");e.id="mcp-hover-styles",e.textContent="\n          .mcp-hover-highlight {\n            outline: 2px solid #667eea !important;\n            outline-offset: 2px !important;\n            background: rgba(102, 126, 234, 0.1) !important;\n          }\n        ",document.head.appendChild(e)}},handleElementUnhover:function(e){window.mcpFloatingAssistant.isPointerMode&&e.target.classList.remove("mcp-hover-highlight")},extractElementContext(e){const t=e.tagName.toLowerCase(),n=e.textContent?.trim().substring(0,100)||"",o=undefined,r=undefined;let s=`${t}${e.id?`#${e.id}`:""}${e.className?`.${e.className.split(" ").join(".")}`:""}`;return n&&(s+=`: "${n}"`),"img"===t&&e.src&&(s+=` (src: ${e.src})`),"a"===t&&e.href&&(s+=` (href: ${e.href})`),e.title&&(s+=` (title: ${e.title})`),s},handleAction(e){const t=this.currentPopover.querySelector("#mcp-input"),n=this.currentPopover.querySelector("#mcp-response"),o=t.value.trim();o?(n.style.display="block",n.innerHTML=`\n        <div style="display: flex; align-items: center; gap: 8px; color: #666;">\n          <div style="\n            width: 16px;\n            height: 16px;\n            border: 2px solid #e1e5e9;\n            border-top: 2px solid #667eea;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n          "></div>\n          Processing your ${e} request...\n        </div>\n        <style>\n          @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n          }\n        </style>\n      `,setTimeout(()=>{n.innerHTML=`\n          <div style="color: #495057;">\n            <strong>${e.charAt(0).toUpperCase()+e.slice(1)} response:</strong><br>\n            This is where the MCP response would appear. Your request: "${o}"\n            <br><br>\n            <em>Integration with your existing MCP system would go here.</em>\n          </div>\n        `},1500)):t.focus()}},e&&Object.keys(e).length>0&&window.mcpFloatingAssistant.show(e),chrome.runtime.sendMessage({type:"floating_assistant_ready"}).catch(()=>{}))}async function loadAndRunPage(e){console.log(`${cname()}:✅Loading page:`,e)}chrome.runtime.onInstalled.addListener(async e=>{i.info("⚡ onInstalled event")}),chrome.tabs.onRemoved.addListener((e,t)=>{i.debug(`Tab ${e} closed, isWindowClosing: ${t.isWindowClosing}`),a.has(e)&&(a.delete(e),i.debug(`Removed access token for closed tab ${e}`))}),chrome.runtime.onSuspend.addListener(()=>{i.info("Extension is being suspended - preserving state"),f.healthCheckInterval&&clearInterval(f.healthCheckInterval),chrome.storage.local.set({mcp_connection_state:{lastActivity:f.lastActivity,wasActive:f.isActive,timestamp:Date.now()}});for(const[e,n]of Object.entries(t))if(n&&"function"==typeof n.disconnect)try{n.disconnect(),i.debug(`Gracefully disconnected from ${e}`)}catch(t){i.warn(`Error disconnecting from ${e}:`,t)}}),chrome.runtime.onSuspendCanceled.addListener(()=>{i.info("Extension suspension cancelled - resuming operations"),setupKeepalive(),reconnectAllMcpServers()}),chrome.alarms.onAlarm.addListener(e=>{"keepalive"===e.name&&(updateLastActivity(),chrome.storage.local.get(["mcp_connection_state"],e=>{chrome.runtime.lastError&&i.debug("Storage access during keepalive")}))}),chrome.tabs.onActivated.addListener(e=>{i.debug("Tab activated, updating activity"),updateLastActivity(),checkConnectionHealth()}),chrome.windows.onFocusChanged.addListener(e=>{e!==chrome.windows.WINDOW_ID_NONE&&(i.debug("Window focused, updating activity"),updateLastActivity(),checkConnectionHealth())}),chrome.webNavigation?.onCompleted?.addListener&&chrome.webNavigation.onCompleted.addListener(e=>{0===e.frameId&&(i.debug("Navigation completed, updating activity"),updateLastActivity())}),chrome.runtime.onStartup.addListener(async e=>{i.info("⚡Extension starting up"),chrome.storage.local.get(["mcp_connection_state"],e=>{if(e.mcp_connection_state){const t=e.mcp_connection_state,n=Date.now()-t.timestamp;i.info(`Restored from suspension after ${n}ms`),t.wasActive&&(f.lastActivity=t.lastActivity)}}),performExtensionStartup(e)}),chrome.action.onClicked.addListener(e=>{i.info("🖱️ Extension icon clicked; 📍 Active tab:",e.url),chrome.action.setBadgeText({text:""})}),chrome.runtime.onConnect.addListener(e=>{i.info("🔗 Connection established:",e.name),e.onMessage.addListener(e=>{i.info("📨 Port message:",e)})}),self.addEventListener("activate",e=>{i.info("⚡ Service worker activated"),performExtensionStartup(e)});class ConfigLoader{static loadConfig(e){let t;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){throw new Error(`Invalid JSON: ${e.message}`)}else t=e;const n=JSON.parse(JSON.stringify(t));return this.processObject(n)}static processObject(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(e=>this.processObject(e));if("RegExp"===e.__type)return this.reconstructRegExp(e);const t={};for(const[n,o]of Object.entries(e))t[n]=this.processObject(o);return t}static reconstructRegExp(e){try{return new RegExp(e.source,e.flags||"")}catch(e){return console.warn(`Failed to reconstruct RegExp: ${e.message}`),/(?!)/}}static async loadFromURL(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const n=await t.json();return this.loadConfig(n)}catch(t){throw new Error(`Failed to load config from ${e}: ${t.message}`)}}static validateConfig(e){const t=e["claude.ai"];if(!t)return console.warn("Missing claude.ai configuration"),!1;const n=["friendlyName","pattern","detectChatInput"];for(const e of n)if(!t[e])return console.warn(`Missing required property: ${e}`),!1;return t.pattern instanceof RegExp||(console.warn("Pattern was not reconstructed as RegExp"),!1)}}